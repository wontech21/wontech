<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ g.organization.organization_name }} - Point of Sale</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>
    <!-- Google Maps API - Replace YOUR_API_KEY with actual key -->
    <script src="https://maps.googleapis.com/maps/api/js?key={{ config.get('GOOGLE_MAPS_API_KEY', '') }}&libraries=places&callback=initGoogleMaps" async defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        .pos-container {
            display: grid;
            grid-template-columns: 1fr 380px;
            height: 100vh;
            gap: 0;
        }

        /* Left Side - Product Grid */
        .pos-main {
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* ── Employee Selection Overlay ── */
        .pos-employee-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pos-employee-overlay.hidden { display: none; }

        .employee-select-card {
            background: white;
            border-radius: 24px;
            padding: 40px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 24px 48px rgba(0,0,0,0.3);
            text-align: center;
        }

        .employee-select-card h2 {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .employee-select-card p {
            color: #6b7280;
            margin-bottom: 24px;
        }

        .employee-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }

        .num-btn {
            padding: 20px;
            font-size: 1.8em;
            font-weight: 600;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.2s;
            color: #1f2937;
            min-height: 64px;
        }

        .num-btn:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        .num-btn:active {
            transform: scale(0.96);
        }

        /* ── Employee Badge in Header ── */
        .pos-employee-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pos-employee-badge:hover {
            opacity: 0.9;
            transform: scale(1.02);
        }

        .pos-employee-badge .badge-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(255,255,255,0.25);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
        }

        /* ── 86'd / Out-of-Stock Badge ── */
        .product-btn.out-of-stock {
            opacity: 0.35;
            pointer-events: none;
            position: relative;
            background: rgba(220, 38, 38, 0.12) !important;
            filter: grayscale(40%);
        }

        .product-low-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #f59e0b;
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 6px;
            z-index: 5;
        }

        .product-btn.low-stock {
            position: relative;
        }

        .pos-header {
            background: white;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #e9ecef;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .pos-header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .pos-logo {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .pos-logo:hover {
            opacity: 0.8;
            transform: scale(1.02);
        }

        .pos-header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .pos-settings-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pos-settings-btn:hover {
            background: #f0f4ff;
            transform: translateY(-2px);
        }

        .pos-categories {
            background: white;
            padding: 16px 24px;
            display: flex;
            gap: 14px;
            overflow-x: auto;
            border-bottom: 2px solid #e9ecef;
        }

        .category-btn {
            padding: 16px 32px;
            background: #f1f3f4;
            border: 2px solid transparent;
            border-radius: 30px;
            font-size: 17px;
            font-weight: 600;
            color: #5f6368;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .category-btn:hover {
            background: #e8eaed;
        }

        .category-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        .subcat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 16px;
        }

        .subcat-btn {
            background: white;
            border: 3px solid #667eea;
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            min-height: 140px;
        }

        .subcat-btn:hover {
            background: #f0f4ff;
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
        }

        .subcat-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        .subcat-btn .subcat-icon {
            font-size: 48px;
            line-height: 1;
        }

        .subcat-btn .subcat-name {
            font-size: 14px;
            font-weight: 700;
            color: #1f2937;
        }

        .subcat-btn.active .subcat-name {
            color: white;
        }

        /* Expanded subcategory view */
        .subcat-expanded {
            display: flex;
            gap: 16px;
            align-items: flex-start;
        }

        .subcat-expanded .subcat-btn {
            min-width: 140px;
            flex-shrink: 0;
        }

        .subcat-expanded .products-grid {
            flex: 1;
        }

        .pos-products {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 16px;
        }

        .product-btn {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            min-height: 140px;
        }

        .product-btn:hover {
            border-color: #667eea;
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.2);
        }

        .product-btn:active {
            transform: translateY(-2px);
        }

        .product-icon {
            font-size: 48px;
            line-height: 1;
        }

        .product-name {
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
            line-height: 1.3;
        }

        .product-price {
            font-size: 16px;
            font-weight: 700;
            color: #667eea;
        }

        /* Right Side - Order Panel */
        .pos-order {
            background: white;
            display: flex;
            flex-direction: column;
            border-left: 2px solid #e9ecef;
        }

        .order-header {
            padding: 20px 24px;
            border-bottom: 2px solid #e9ecef;
        }

        .order-title {
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .order-subtitle {
            font-size: 13px;
            color: #6b7280;
        }

        .order-items {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 10px;
        }

        .order-item-info {
            flex: 1;
        }

        .order-item-name {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 2px;
        }

        .order-item-price {
            font-size: 13px;
            color: #6b7280;
        }

        .order-item-qty {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .qty-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 8px;
            background: #e9ecef;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .qty-btn:hover {
            background: #667eea;
            color: white;
        }

        .order-empty {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        .order-empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .order-summary {
            padding: 20px 24px;
            border-top: 2px solid #e9ecef;
            background: #f8f9fa;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 15px;
        }

        .summary-row.total {
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
            padding-top: 12px;
            margin-top: 8px;
            border-top: 2px solid #e9ecef;
        }

        .order-actions {
            padding: 16px 24px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .pay-btn {
            padding: 18px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pay-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .pay-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .clear-btn {
            padding: 14px;
            background: white;
            color: #ef4444;
            border: 2px solid #ef4444;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .clear-btn:hover {
            background: #fef2f2;
        }

        /* Order Type Selector */
        .order-type-selector {
            display: flex;
            gap: 8px;
            padding: 16px 24px;
            border-bottom: 2px solid #e9ecef;
            background: #f8f9fa;
        }

        .order-type-btn {
            flex: 1;
            padding: 12px 8px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            background: white;
            font-size: 13px;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .order-type-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .order-type-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: transparent;
            color: white;
        }

        .order-type-btn .type-icon {
            font-size: 20px;
        }

        /* Customer Info Section */
        .customer-info {
            padding: 16px 24px;
            border-bottom: 2px solid #e9ecef;
            background: #fefce8;
            display: none;
        }

        .customer-info.visible {
            display: block;
        }

        .customer-info-title {
            font-size: 13px;
            font-weight: 700;
            color: #92400e;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .customer-field {
            margin-bottom: 10px;
        }

        .customer-field:last-child {
            margin-bottom: 0;
        }

        .customer-field label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .customer-field input,
        .customer-field textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .customer-field input:focus,
        .customer-field textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .customer-field textarea {
            resize: none;
            height: 60px;
        }

        .pickup-time-row {
            display: flex;
            gap: 10px;
        }

        .pickup-time-row .customer-field {
            flex: 1;
        }

        /* Address row for city/state/zip */
        .address-row {
            display: flex;
            gap: 8px;
        }

        .address-row .customer-field {
            margin-bottom: 10px;
        }

        /* Map preview */
        .map-preview {
            margin: 10px 0;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e9ecef;
        }

        #mapContainer {
            height: 150px;
            background: #f1f3f4;
        }

        .map-status {
            padding: 8px 12px;
            font-size: 12px;
            background: white;
            border-top: 1px solid #e9ecef;
        }

        .map-status.valid {
            color: #059669;
            background: #ecfdf5;
        }

        .map-status.invalid {
            color: #dc2626;
            background: #fef2f2;
        }

        .map-status.calculating {
            color: #667eea;
            background: #eef2ff;
        }

        /* Google Places Autocomplete styling */
        .pac-container {
            z-index: 10000 !important;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: none;
            margin-top: 4px;
        }

        .pac-item {
            padding: 10px 12px;
            cursor: pointer;
        }

        .pac-item:hover {
            background: #f3f4f6;
        }

        /* Delivery fee note */
        .delivery-note {
            font-size: 11px;
            color: #92400e;
            margin-top: 8px;
            padding: 8px;
            background: #fef3c7;
            border-radius: 6px;
        }

        /* Settings Modal */
        .pos-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .pos-modal-overlay.visible {
            display: flex;
        }

        .pos-modal {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 24px 48px rgba(0, 0, 0, 0.2);
        }

        .pos-modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pos-modal-title {
            font-size: 20px;
            font-weight: 700;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pos-modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pos-modal-close:hover {
            background: rgba(255,255,255,0.3);
        }

        .pos-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .pos-modal-footer {
            padding: 16px 24px;
            border-top: 2px solid #e9ecef;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background: #f8f9fa;
        }

        .settings-cancel-btn {
            padding: 12px 24px;
            background: white;
            color: #6b7280;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .settings-cancel-btn:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

        .settings-save-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .settings-save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .pos-modal-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 12px;
        }

        .pos-modal-tab {
            padding: 10px 20px;
            background: #f1f3f4;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pos-modal-tab:hover {
            background: #e8eaed;
        }

        .pos-modal-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .settings-section {
            margin-bottom: 24px;
        }

        .settings-section-title {
            font-size: 14px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .export-csv-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
            text-transform: none;
            letter-spacing: 0;
            transition: all 0.2s;
        }

        .export-csv-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .settings-row-label {
            font-weight: 600;
            color: #374151;
        }

        .settings-row-desc {
            font-size: 12px;
            color: #6b7280;
            margin-top: 2px;
        }

        .settings-input {
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            width: 120px;
            text-align: center;
        }

        .settings-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .settings-select {
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        .settings-toggle {
            position: relative;
            width: 52px;
            height: 28px;
        }

        .settings-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .settings-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #cbd5e1;
            border-radius: 28px;
            transition: 0.3s;
        }

        .settings-toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }

        .settings-toggle input:checked + .settings-toggle-slider {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .settings-toggle input:checked + .settings-toggle-slider:before {
            transform: translateX(24px);
        }

        /* Order History Table */
        .order-history-table {
            width: 100%;
            border-collapse: collapse;
        }

        .order-history-table th,
        .order-history-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .order-history-table th {
            background: #f8f9fa;
            font-weight: 700;
            font-size: 12px;
            color: #6b7280;
            text-transform: uppercase;
        }

        .order-history-table tr:hover {
            background: #f8f9fa;
        }

        .order-type-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .order-type-badge.dine-in {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .order-type-badge.pickup {
            background: #fef3c7;
            color: #92400e;
        }

        .order-type-badge.delivery {
            background: #d1fae5;
            color: #065f46;
        }

        .order-history-empty {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
        }

        /* ── Orders View (full-page, replaces product grid) ── */
        .pos-orders-view {
            padding: 24px;
            overflow-y: auto;
            height: 100%;
        }

        .pos-orders-topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .pos-orders-topbar-left {
            display: flex;
            align-items: baseline;
            gap: 12px;
        }

        .pos-orders-title {
            font-size: 28px;
            font-weight: 700;
            color: #1f2937;
            margin: 0;
        }

        .pos-orders-date {
            font-size: 14px;
            color: #9ca3af;
            font-weight: 500;
        }

        .pos-orders-topbar-right {
            display: flex;
            gap: 10px;
        }

        .pos-orders-back-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pos-orders-back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .pos-orders-export-btn {
            padding: 10px 20px;
            background: white;
            color: #374151;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pos-orders-export-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .pos-orders-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .pos-orders-stat {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 14px;
            color: white;
            text-align: center;
        }

        .pos-orders-stat__value {
            font-size: 32px;
            font-weight: 700;
        }

        .pos-orders-stat__label {
            font-size: 13px;
            opacity: 0.9;
            margin-top: 4px;
        }

        .pos-orders-filters {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .pos-orders-search {
            flex: 1;
            padding: 10px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .pos-orders-search:focus {
            outline: none;
            border-color: #667eea;
        }

        .pos-orders-filter-select {
            padding: 10px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            min-width: 140px;
        }

        .pos-orders-filter-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .pos-orders-table-wrap {
            background: white;
            border-radius: 12px;
            border: 2px solid #e9ecef;
            overflow: hidden;
        }

        .pos-orders-btn--active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            border-color: transparent !important;
        }

        .time-slots-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .time-slot-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .time-slot-row label {
            min-width: 60px;
            font-size: 13px;
            font-weight: 600;
            color: #374151;
        }

        /* Payment Modal Styles */
        .payment-summary {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .payment-summary-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
            color: #6b7280;
        }

        .payment-summary-row.payment-total {
            border-top: 2px solid #e5e7eb;
            margin-top: 8px;
            padding-top: 12px;
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
        }

        .payment-methods {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .payment-method-title {
            font-size: 14px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .payment-method-btn {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .payment-method-btn:hover {
            border-color: #667eea;
            background: #f5f3ff;
        }

        .payment-method-icon {
            font-size: 32px;
        }

        .payment-method-label {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }

        .payment-method-desc {
            font-size: 12px;
            color: #6b7280;
            margin-left: auto;
        }

        .payment-form {
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cash Payment */
        .cash-input-group {
            margin-bottom: 16px;
        }

        .cash-input-group label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 6px;
            text-transform: uppercase;
        }

        .cash-input-wrapper {
            display: flex;
            align-items: center;
            background: #f8f9fa;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
        }

        .cash-currency {
            padding: 16px;
            font-size: 24px;
            font-weight: 700;
            color: #6b7280;
            background: #e5e7eb;
        }

        .cash-input {
            flex: 1;
            border: none;
            padding: 16px;
            font-size: 24px;
            font-weight: 700;
            background: transparent;
            outline: none;
        }

        .cash-quick-amounts {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .quick-amount-btn {
            flex: 1;
            padding: 12px;
            background: #e5e7eb;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-amount-btn:hover {
            background: #667eea;
            color: white;
        }

        .change-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            color: white;
            margin-bottom: 20px;
        }

        .change-display span:first-child {
            font-size: 14px;
            opacity: 0.9;
        }

        #changeAmount {
            font-size: 28px;
            font-weight: 700;
        }

        /* Card Payment */
        .card-form {
            margin-bottom: 20px;
        }

        .card-field {
            margin-bottom: 16px;
        }

        .card-field label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 6px;
            text-transform: uppercase;
        }

        .card-row {
            display: flex;
            gap: 16px;
        }

        .card-row .card-field {
            flex: 1;
        }

        .stripe-element {
            padding: 14px;
            background: #f8f9fa;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            transition: border-color 0.2s;
        }

        .stripe-element.StripeElement--focus {
            border-color: #667eea;
        }

        .stripe-element.StripeElement--invalid {
            border-color: #dc2626;
        }

        .card-errors {
            color: #dc2626;
            font-size: 13px;
            margin-top: 8px;
            min-height: 20px;
        }

        /* Payment Buttons */
        .payment-submit-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .payment-submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .payment-submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .payment-back-btn {
            width: 100%;
            padding: 14px;
            background: transparent;
            color: #6b7280;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
        }

        .payment-back-btn:hover {
            color: #1f2937;
        }

        .payment-cancel-btn {
            width: 100%;
            padding: 14px;
            background: #fee2e2;
            color: #dc2626;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
        }

        .btn-spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Terminal Payment */
        .terminal-status {
            text-align: center;
            padding: 40px 20px;
        }

        .terminal-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .terminal-message {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 16px;
        }

        .terminal-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        .terminal-instructions {
            text-align: center;
            color: #6b7280;
            font-size: 14px;
        }

        /* Payment Success */
        .payment-success-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            font-size: 40px;
            font-weight: 700;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }

        .payment-success-title {
            text-align: center;
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .payment-success-amount {
            text-align: center;
            font-size: 36px;
            font-weight: 700;
            color: #059669;
            margin-bottom: 8px;
        }

        .payment-success-method {
            text-align: center;
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 24px;
        }

        .payment-receipt-options {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .receipt-btn {
            flex: 1;
            padding: 12px;
            background: #f3f4f6;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .receipt-btn:hover {
            background: #e5e7eb;
        }

        .payment-done-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .payment-done-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }

        /* Coming Soon Overlay */
        .coming-soon-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .coming-soon-card {
            background: white;
            border-radius: 24px;
            padding: 60px 80px;
            text-align: center;
            max-width: 500px;
            box-shadow: 0 24px 48px rgba(0, 0, 0, 0.2);
        }

        .coming-soon-icon {
            font-size: 80px;
            margin-bottom: 24px;
        }

        .coming-soon-title {
            font-size: 32px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 12px;
        }

        .coming-soon-text {
            font-size: 16px;
            color: #6b7280;
            margin-bottom: 32px;
            line-height: 1.6;
        }

        .coming-soon-badge {
            display: inline-block;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 10px 24px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 24px;
        }

        .back-home-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 14px 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .back-home-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
        }

        .loading-products {
            grid-column: 1 / -1;
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
            font-size: 16px;
        }

        @media (max-width: 900px) {
            .pos-container {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr auto;
            }

            .pos-order {
                border-left: none;
                border-top: 2px solid #e9ecef;
                max-height: 50vh;
            }

            .pos-categories {
                padding: 12px 16px;
            }

            .category-btn {
                padding: 10px 16px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <!-- Employee Selection Overlay (keypad) -->
    <div class="pos-employee-overlay" id="employeeOverlay">
        <div class="employee-select-card" style="max-width:420px; padding:40px 35px;">
            <h2>Employee Code</h2>
            <p>Enter your code to start</p>
            <input type="tel" id="employeePinField" readonly maxlength="10"
                   style="width:100%; padding:16px; font-size:2em; text-align:center;
                          border:2px solid #e5e7eb; border-radius:14px; font-weight:700;
                          letter-spacing:0.3em; background:#f9fafb; color:#1f2937; margin-bottom:4px;">
            <div class="pin-error" id="pinError" style="color:#dc2626; font-size:13px; min-height:24px; margin-bottom:8px;"></div>
            <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:16px;">
                <button type="button" class="num-btn" onclick="posAddDigit('1')">1</button>
                <button type="button" class="num-btn" onclick="posAddDigit('2')">2</button>
                <button type="button" class="num-btn" onclick="posAddDigit('3')">3</button>
                <button type="button" class="num-btn" onclick="posAddDigit('4')">4</button>
                <button type="button" class="num-btn" onclick="posAddDigit('5')">5</button>
                <button type="button" class="num-btn" onclick="posAddDigit('6')">6</button>
                <button type="button" class="num-btn" onclick="posAddDigit('7')">7</button>
                <button type="button" class="num-btn" onclick="posAddDigit('8')">8</button>
                <button type="button" class="num-btn" onclick="posAddDigit('9')">9</button>
                <button type="button" class="num-btn" style="grid-column:1/3;" onclick="posAddDigit('0')">0</button>
                <button type="button" class="num-btn" onclick="posClearCode()" style="background:#fef2f2;color:#dc2626;font-size:1.1em;">&#x232B;</button>
            </div>
            <button onclick="submitEmployeePin()" style="
                width:100%; padding:16px; font-size:1.1em; font-weight:600;
                background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
                color:white; border:none; border-radius:14px; cursor:pointer;
                box-shadow:0 4px 12px rgba(102,126,234,0.25);
            ">Continue</button>
        </div>
    </div>

    <div class="pos-container">
        <!-- Left Side - Product Selection -->
        <div class="pos-main">
            <div class="pos-header">
                <div class="pos-header-left">
                    <a href="/dashboard/pos" class="pos-logo">⬅ POS Terminal</a>
                </div>
                <div class="pos-header-right">
                    <div class="pos-employee-badge" id="employeeBadge" onclick="switchEmployee()" style="display:none;">
                        <span class="badge-avatar" id="badgeAvatar"></span>
                        <span id="badgeName"></span>
                    </div>
                    <button class="pos-settings-btn" id="eightySixBtn" onclick="toggle86Mode()" style="border-color: transparent; background: #f1f3f4; color: #5f6368;">
                        <span>86</span>
                    </button>
                </div>
            </div>

            <div class="pos-categories" id="mainCategories">
                <button class="category-btn active" data-category="All">All</button>
                <button class="category-btn" data-category="Appetizers">Appetizers</button>
                <button class="category-btn" data-category="Salads">Salads</button>
                <button class="category-btn" data-category="Pizza">Pizza</button>
                <button class="category-btn" data-category="Calzones">Calzones</button>
                <button class="category-btn" data-category="Subs">Subs</button>
                <button class="category-btn" data-category="Sandwiches">Sandwiches</button>
                <button class="category-btn" data-category="Wraps">Wraps</button>
                <button class="category-btn" data-category="Dinners">Dinners</button>
                <button class="category-btn" data-category="Pasta">Pasta</button>
                <button class="category-btn" data-category="Desserts">Desserts</button>
                <button class="category-btn" data-category="Drinks">Drinks</button>
                <button class="category-btn" data-category="Catering">Catering</button>
                <button class="category-btn" data-category="Add-ons">Add-ons</button>
            </div>

            <div id="eightySixGroupBar" style="display:none; padding: 6px 12px; overflow-x: auto; white-space: nowrap; background: #fef2f2; border-bottom: 1px solid #fecaca;"></div>

            <div class="pos-products" id="posProductsArea">
                <div id="productsGrid">
                    <div class="loading-products">Loading products...</div>
                </div>
            </div>

        </div>

        <!-- Right Side - Order Summary -->
        <div class="pos-order">
            <div class="order-header">
                <div class="order-title">Current Order</div>
                <div class="order-subtitle" id="orderSubtitle">Order #001 • Dine In</div>
            </div>

            <!-- Order Type Selector -->
            <div class="order-type-selector">
                <button class="order-type-btn active" data-type="dine-in" onclick="setOrderType('dine-in')">
                    <span class="type-icon">🍽️</span>
                    <span>Dine In</span>
                </button>
                <button class="order-type-btn" data-type="pickup" onclick="setOrderType('pickup')">
                    <span class="type-icon">🥡</span>
                    <span>Pickup</span>
                </button>
                <button class="order-type-btn" data-type="delivery" onclick="setOrderType('delivery')">
                    <span class="type-icon">🚗</span>
                    <span>Delivery</span>
                </button>
            </div>

            <!-- Customer Info (for Pickup/Delivery) -->
            <div class="customer-info" id="customerInfo">
                <div class="customer-info-title">
                    <span id="customerInfoIcon">📋</span>
                    <span id="customerInfoTitle">Customer Information</span>
                </div>
                <div class="customer-field">
                    <label>Customer Name</label>
                    <input type="text" id="customerName" placeholder="Enter name">
                </div>
                <div class="customer-field">
                    <label>Phone Number</label>
                    <input type="tel" id="customerPhone" placeholder="(555) 555-5555" oninput="debouncedCustomerLookup()">
                    <div id="customerLookupHint" style="display:none; font-size:12px; margin-top:4px; padding:6px 8px; border-radius:6px; background:#ecfdf5; color:#065f46;"></div>
                </div>
                <div class="pickup-time-row" id="pickupTimeRow">
                    <div class="customer-field">
                        <label>Ready Time</label>
                        <input type="time" id="pickupTime">
                    </div>
                </div>
                <div id="deliveryFields" style="display: none;">
                    <div class="customer-field">
                        <label>Street Address</label>
                        <input type="text" id="streetAddress" placeholder="123 Main St" autocomplete="off">
                    </div>
                    <div class="customer-field">
                        <label>Apt/Suite/Unit (optional)</label>
                        <input type="text" id="aptUnit" placeholder="Apt 4B, Suite 100, etc.">
                    </div>
                    <div class="address-row">
                        <div class="customer-field" style="flex: 2;">
                            <label>City</label>
                            <input type="text" id="city" placeholder="City">
                        </div>
                        <div class="customer-field" style="flex: 1;">
                            <label>State</label>
                            <input type="text" id="state" placeholder="CA" maxlength="2" style="text-transform: uppercase;">
                        </div>
                        <div class="customer-field" style="flex: 1;">
                            <label>Zip</label>
                            <input type="text" id="zipCode" placeholder="12345" maxlength="10">
                        </div>
                    </div>
                    <div class="customer-field">
                        <label>Delivery Instructions (optional)</label>
                        <input type="text" id="deliveryInstructions" placeholder="Gate code, leave at door, etc.">
                    </div>
                    <div id="mapPreview" class="map-preview" style="display: none;">
                        <div id="mapContainer"></div>
                        <div class="map-status" id="mapStatus"></div>
                    </div>
                    <div class="delivery-note">
                        💰 Delivery fee will be calculated based on distance
                    </div>
                </div>
            </div>

            <div class="order-items" id="orderItems">
                <div class="order-empty">
                    <div class="order-empty-icon">🛒</div>
                    <div>No items yet</div>
                    <div style="font-size: 13px; margin-top: 8px;">Tap products to add them</div>
                </div>
            </div>

            <div class="order-summary">
                <div class="summary-row">
                    <span>Subtotal</span>
                    <span id="subtotalAmount">$0.00</span>
                </div>
                <div class="summary-row" id="taxRow">
                    <span id="taxLabelDisplay">Tax (8%)</span>
                    <span id="taxAmount">$0.00</span>
                </div>
                <div class="summary-row" id="deliveryFeeRow" style="display: none; color: #667eea;">
                    <span>🚗 Delivery Fee</span>
                    <span id="deliveryFeeAmount">$0.00</span>
                </div>
                <div class="summary-row total">
                    <span>Total</span>
                    <span id="totalAmount">$0.00</span>
                </div>
            </div>

            <div class="order-actions">
                <button class="pay-btn" id="payBtn" disabled onclick="processPayment()">Pay $0.00</button>
                <button class="clear-btn" onclick="clearOrder()">Clear Order</button>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="pos-modal-overlay" id="paymentModal">
        <div class="pos-modal" style="max-width: 480px;">
            <div class="pos-modal-header">
                <h2>Payment</h2>
                <button class="pos-modal-close" onclick="closePaymentModal()">&times;</button>
            </div>
            <div class="pos-modal-body">
                <!-- Order Summary -->
                <div class="payment-summary">
                    <div class="payment-summary-row">
                        <span>Subtotal</span>
                        <span id="paymentSubtotal">$0.00</span>
                    </div>
                    <div class="payment-summary-row">
                        <span>Tax</span>
                        <span id="paymentTax">$0.00</span>
                    </div>
                    <div class="payment-summary-row" id="paymentDeliveryRow" style="display: none;">
                        <span>Delivery Fee</span>
                        <span id="paymentDeliveryFee">$0.00</span>
                    </div>
                    <div class="payment-summary-row payment-total">
                        <span>Total</span>
                        <span id="paymentTotal">$0.00</span>
                    </div>
                </div>

                <!-- Payment Method Selection -->
                <div id="paymentMethodSelect" class="payment-methods">
                    <div class="payment-method-title">Select Payment Method</div>
                    <button class="payment-method-btn" onclick="selectPaymentMethod('cash')">
                        <span class="payment-method-icon">💵</span>
                        <span class="payment-method-label">Cash</span>
                    </button>
                    <button class="payment-method-btn" onclick="selectPaymentMethod('card')">
                        <span class="payment-method-icon">💳</span>
                        <span class="payment-method-label">Card</span>
                    </button>
                    <button class="payment-method-btn" onclick="selectPaymentMethod('terminal')">
                        <span class="payment-method-icon">📱</span>
                        <span class="payment-method-label">Card Reader</span>
                        <span class="payment-method-desc">Stripe Terminal</span>
                    </button>
                </div>

                <!-- Cash Payment -->
                <div id="cashPayment" class="payment-form" style="display: none;">
                    <div class="payment-method-title">Cash Payment</div>
                    <div class="cash-input-group">
                        <label>Amount Received</label>
                        <div class="cash-input-wrapper">
                            <span class="cash-currency">$</span>
                            <input type="number" id="cashReceived" class="cash-input" step="0.01" min="0" placeholder="0.00" oninput="calculateChange()">
                        </div>
                    </div>
                    <div class="cash-quick-amounts">
                        <button class="quick-amount-btn" onclick="setQuickAmount('exact')">Exact</button>
                        <button class="quick-amount-btn" onclick="setQuickAmount(20)">$20</button>
                        <button class="quick-amount-btn" onclick="setQuickAmount(50)">$50</button>
                        <button class="quick-amount-btn" onclick="setQuickAmount(100)">$100</button>
                    </div>
                    <div class="change-display" id="changeDisplay">
                        <span>Change Due</span>
                        <span id="changeAmount">$0.00</span>
                    </div>
                    <button class="payment-submit-btn" id="cashSubmitBtn" onclick="completeCashPayment()" disabled>
                        Complete Cash Payment
                    </button>
                    <button class="payment-back-btn" onclick="showPaymentMethods()">← Back</button>
                </div>

                <!-- Card Payment (Stripe Elements) -->
                <div id="cardPayment" class="payment-form" style="display: none;">
                    <div class="payment-method-title">Card Payment</div>
                    <div class="card-form">
                        <div class="card-field">
                            <label>Card Number</label>
                            <div id="card-number-element" class="stripe-element"></div>
                        </div>
                        <div class="card-row">
                            <div class="card-field">
                                <label>Expiry</label>
                                <div id="card-expiry-element" class="stripe-element"></div>
                            </div>
                            <div class="card-field">
                                <label>CVC</label>
                                <div id="card-cvc-element" class="stripe-element"></div>
                            </div>
                        </div>
                        <div id="card-errors" class="card-errors"></div>
                    </div>
                    <button class="payment-submit-btn" id="cardSubmitBtn" onclick="processCardPayment()">
                        <span id="cardBtnText">Pay <span id="cardPayAmount">$0.00</span></span>
                        <span id="cardBtnSpinner" class="btn-spinner" style="display: none;"></span>
                    </button>
                    <button class="payment-back-btn" onclick="showPaymentMethods()">← Back</button>
                </div>

                <!-- Terminal Payment (Stripe Terminal) -->
                <div id="terminalPayment" class="payment-form" style="display: none;">
                    <div class="payment-method-title">Card Reader</div>
                    <div class="terminal-status" id="terminalStatus">
                        <div class="terminal-icon">📱</div>
                        <div class="terminal-message" id="terminalMessage">Connecting to reader...</div>
                        <div class="terminal-spinner" id="terminalSpinner"></div>
                    </div>
                    <div class="terminal-instructions">
                        <p>Present card to the reader when prompted</p>
                    </div>
                    <button class="payment-cancel-btn" id="terminalCancelBtn" onclick="cancelTerminalPayment()">
                        Cancel
                    </button>
                    <button class="payment-back-btn" onclick="showPaymentMethods()">← Back</button>
                </div>

                <!-- Payment Success -->
                <div id="paymentSuccess" class="payment-form" style="display: none;">
                    <div class="payment-success-icon">✓</div>
                    <div class="payment-success-title">Payment Complete!</div>
                    <div class="payment-success-amount" id="successAmount">$0.00</div>
                    <div class="payment-success-method" id="successMethod"></div>
                    <div class="payment-receipt-options">
                        <button class="receipt-btn" onclick="printReceipt()">🖨️ Print Receipt</button>
                        <button class="receipt-btn" onclick="emailReceipt()">📧 Email Receipt</button>
                        <button class="receipt-btn" onclick="textReceipt()">💬 Text Receipt</button>
                    </div>
                    <button class="payment-done-btn" onclick="finishPayment()">Done - New Order</button>
                </div>
            </div>
        </div>
    </div>

    {% if not g.is_super_admin %}
    <!-- Coming Soon Overlay (only for non-super admins) -->
    <div class="coming-soon-overlay">
        <div class="coming-soon-card">
            <div class="coming-soon-icon">🛒</div>
            <div class="coming-soon-badge">Coming Soon</div>
            <h1 class="coming-soon-title">Point of Sale</h1>
            <p class="coming-soon-text">
                We're building a fast and intuitive POS system for quick ordering and checkout.
                This feature will be available soon!
            </p>
            <a href="/dashboard/pos" class="back-home-btn">
                <span>&#8592;</span> Back to POS Terminal
            </a>
        </div>
    </div>
    {% endif %}


    <script>
        let allProducts = [];
        let currentCategory = 'All';
        let currentSubcategory = null;
        let subcatExpanded = false;
        let orderItems = [];
        let orderType = 'dine-in';
        let deliveryFee = 0;
        let deliveryDistanceInfo = null;
        let googleMapsLoaded = false;
        let autocomplete = null;
        let map = null;
        let marker = null;

        // Store location (set this to your restaurant's address)
        const storeLocation = {
            address: '{{ g.organization.address if g.organization.address else "123 Main St, City, State" }}',
            lat: null,
            lng: null
        };

        // Stripe configuration
        const stripePublicKey = '{{ config.get("STRIPE_PUBLIC_KEY", "") }}';
        let stripe = null;
        let cardNumberElement = null;
        let cardExpiryElement = null;
        let cardCvcElement = null;
        let currentPaymentIntent = null;
        let pendingOrderData = null;

        // Initialize Stripe if key is available
        if (stripePublicKey) {
            stripe = Stripe(stripePublicKey);
        }

        // Order history cache (persisted to localStorage)
        let orderHistory = [];
        let orderNumber = 1;
        let lastCompletedOrderId = null;
        let registerSession = null;

        // POS Settings (persisted to localStorage)
        let posSettings = {
            // Tax settings
            taxEnabled: true,
            taxRate: 8.00,
            taxDisplay: 'add',
            taxLabel: 'Tax',
            // Delivery settings
            deliveryFeeType: 'fixed',
            fixedDeliveryFee: 5.00,
            baseDeliveryFee: 3.00,
            perMileFee: 1.50,
            maxDeliveryDistance: 10,
            minDeliveryOrder: 15.00,
            freeDeliveryThreshold: 50.00,
            dineInOpens: '11:00',
            dineInCloses: '22:00',
            pickupLeadTime: 15,
            deliveryStarts: '11:30',
            deliveryEnds: '21:30',
            deliveryLeadTime: 45,
            deliveryTimeMin: 30,
            deliveryTimeMax: 45,
            lastOrderBuffer: 30
        };

        // Load settings and order history from localStorage
        async function loadPosData() {
            const savedSettings = localStorage.getItem('posSettings');
            if (savedSettings) {
                posSettings = { ...posSettings, ...JSON.parse(savedSettings) };
            }

            // Try loading today's orders from server
            try {
                const response = await fetch('/api/pos/orders');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.orders.length > 0) {
                        orderHistory = data.orders.map(o => ({
                            orderNumber: o.order_number,
                            serverId: o.id,
                            time: new Date(o.created_at).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }),
                            timestamp: o.created_at,
                            date: (o.created_at || '').split('T')[0] || (o.created_at || '').split(' ')[0],
                            type: o.order_type,
                            status: o.status,
                            items: [],
                            itemCount: o.item_count || 0,
                            itemsList: o.items_summary || '',
                            subtotal: o.subtotal,
                            tax: o.tax_amount,
                            deliveryFee: o.delivery_fee,
                            total: o.total,
                            customerName: o.customer_name || '',
                            customerPhone: o.customer_phone || '',
                            fullAddress: o.customer_address || '',
                            serverOrder: true
                        }));
                        // Set orderNumber from server's last sequence
                        const lastNum = data.orders[0].order_number;
                        const lastSeq = parseInt(lastNum.split('-').pop());
                        orderNumber = lastSeq + 1;
                    }
                } else {
                    throw new Error('Server unavailable');
                }
            } catch (e) {
                // Fall back to localStorage
                const savedHistory = localStorage.getItem('posOrderHistory');
                if (savedHistory) {
                    const data = JSON.parse(savedHistory);
                    const today = new Date().toDateString();
                    if (data.date === today) {
                        orderHistory = data.orders;
                        orderNumber = data.nextOrderNumber;
                    } else {
                        orderHistory = [];
                        orderNumber = 1;
                    }
                }
            }

            // Apply fixed delivery fee from settings
            if (posSettings.deliveryFeeType === 'fixed') {
                deliveryFee = 0; // Will be set when delivery is selected
            }
        }

        // Save settings to localStorage
        function savePosSettings() {
            localStorage.setItem('posSettings', JSON.stringify(posSettings));
        }

        // Save order history to localStorage
        function saveOrderHistory() {
            localStorage.setItem('posOrderHistory', JSON.stringify({
                date: new Date().toDateString(),
                orders: orderHistory,
                nextOrderNumber: orderNumber
            }));
        }

        // ============== PAYMENT HANDLING ==============

        // Open payment modal
        function openPaymentModal() {
            const itemsTotal = orderItems.reduce((sum, item) => sum + (item.price * item.qty), 0);
            const taxRate = posSettings.taxEnabled ? (posSettings.taxRate / 100) : 0;

            let subtotal, tax, total;

            if (posSettings.taxDisplay === 'included' && posSettings.taxEnabled) {
                // Tax is included in prices - extract it
                subtotal = itemsTotal / (1 + taxRate);
                tax = itemsTotal - subtotal;
                total = itemsTotal + deliveryFee;
            } else {
                // Tax is added at checkout
                subtotal = itemsTotal;
                tax = subtotal * taxRate;
                total = subtotal + tax + deliveryFee;
            }

            // Store order data for later
            pendingOrderData = {
                subtotal,
                tax,
                taxRate: posSettings.taxRate,
                taxEnabled: posSettings.taxEnabled,
                taxDisplay: posSettings.taxDisplay,
                deliveryFee,
                total,
                customerInfo: getCustomerInfo()
            };

            // Update payment summary
            document.getElementById('paymentSubtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('paymentTax').textContent = posSettings.taxEnabled ? `$${tax.toFixed(2)}` : '$0.00';
            document.getElementById('paymentTotal').textContent = `$${total.toFixed(2)}`;
            document.getElementById('cardPayAmount').textContent = `$${total.toFixed(2)}`;

            if (deliveryFee > 0) {
                document.getElementById('paymentDeliveryRow').style.display = 'flex';
                document.getElementById('paymentDeliveryFee').textContent = `$${deliveryFee.toFixed(2)}`;
            } else {
                document.getElementById('paymentDeliveryRow').style.display = 'none';
            }

            // Reset to payment method selection
            showPaymentMethods();

            // Show modal
            document.getElementById('paymentModal').classList.add('visible');
        }

        // Close payment modal
        function closePaymentModal() {
            document.getElementById('paymentModal').classList.remove('visible');
            pendingOrderData = null;
            currentPaymentIntent = null;
        }

        // Show payment method selection
        function showPaymentMethods() {
            document.getElementById('paymentMethodSelect').style.display = 'flex';
            document.getElementById('cashPayment').style.display = 'none';
            document.getElementById('cardPayment').style.display = 'none';
            document.getElementById('terminalPayment').style.display = 'none';
            document.getElementById('paymentSuccess').style.display = 'none';
        }

        // Select payment method
        function selectPaymentMethod(method) {
            document.getElementById('paymentMethodSelect').style.display = 'none';

            switch(method) {
                case 'cash':
                    document.getElementById('cashPayment').style.display = 'block';
                    document.getElementById('cashReceived').value = '';
                    document.getElementById('changeAmount').textContent = '$0.00';
                    document.getElementById('cashSubmitBtn').disabled = true;
                    break;
                case 'card':
                    document.getElementById('cardPayment').style.display = 'block';
                    initializeStripeElements();
                    break;
                case 'terminal':
                    document.getElementById('terminalPayment').style.display = 'block';
                    initializeTerminalPayment();
                    break;
            }
        }

        // ============== CASH PAYMENT ==============

        function setQuickAmount(amount) {
            const total = pendingOrderData.total;
            if (amount === 'exact') {
                document.getElementById('cashReceived').value = total.toFixed(2);
            } else {
                document.getElementById('cashReceived').value = amount.toFixed(2);
            }
            calculateChange();
        }

        function calculateChange() {
            const received = parseFloat(document.getElementById('cashReceived').value) || 0;
            const total = pendingOrderData.total;
            const change = received - total;

            document.getElementById('changeAmount').textContent = change >= 0 ? `$${change.toFixed(2)}` : '-$' + Math.abs(change).toFixed(2);
            document.getElementById('cashSubmitBtn').disabled = change < 0;

            // Visual feedback
            const changeDisplay = document.getElementById('changeDisplay');
            if (change < 0) {
                changeDisplay.style.background = 'linear-gradient(135deg, #dc2626 0%, #b91c1c 100%)';
            } else {
                changeDisplay.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
            }
        }

        async function completeCashPayment() {
            const received = parseFloat(document.getElementById('cashReceived').value) || 0;
            const change = received - pendingOrderData.total;

            // Record payment and complete order
            await completeOrder('cash', {
                amountReceived: received,
                changeGiven: change
            });
        }

        // ============== CARD PAYMENT (STRIPE ELEMENTS) ==============

        function initializeStripeElements() {
            if (!stripe) {
                document.getElementById('card-errors').textContent = 'Stripe is not configured. Please add your Stripe API key.';
                return;
            }

            // Create elements if not already created
            if (!cardNumberElement) {
                const elements = stripe.elements({
                    fonts: [{ cssSrc: 'https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap' }]
                });

                const elementStyle = {
                    base: {
                        fontSize: '16px',
                        fontFamily: 'Inter, -apple-system, BlinkMacSystemFont, sans-serif',
                        fontWeight: '500',
                        color: '#1f2937',
                        '::placeholder': { color: '#9ca3af' }
                    },
                    invalid: {
                        color: '#dc2626'
                    }
                };

                cardNumberElement = elements.create('cardNumber', { style: elementStyle, showIcon: true });
                cardExpiryElement = elements.create('cardExpiry', { style: elementStyle });
                cardCvcElement = elements.create('cardCvc', { style: elementStyle });

                cardNumberElement.mount('#card-number-element');
                cardExpiryElement.mount('#card-expiry-element');
                cardCvcElement.mount('#card-cvc-element');

                // Handle errors
                [cardNumberElement, cardExpiryElement, cardCvcElement].forEach(element => {
                    element.on('change', (event) => {
                        const errorEl = document.getElementById('card-errors');
                        errorEl.textContent = event.error ? event.error.message : '';
                    });
                });
            }
        }

        async function processCardPayment() {
            if (!stripe) {
                alert('Stripe is not configured');
                return;
            }

            const submitBtn = document.getElementById('cardSubmitBtn');
            const btnText = document.getElementById('cardBtnText');
            const btnSpinner = document.getElementById('cardBtnSpinner');

            // Show loading state
            submitBtn.disabled = true;
            btnText.style.display = 'none';
            btnSpinner.style.display = 'block';

            try {
                // Create payment intent on server
                const response = await fetch('/api/pos/create-payment-intent', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        amount: Math.round(pendingOrderData.total * 100), // Convert to cents
                        currency: 'usd',
                        orderData: {
                            type: orderType,
                            items: orderItems,
                            customer: pendingOrderData.customerInfo
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to create payment intent');
                }

                const { clientSecret } = await response.json();

                // Confirm card payment
                const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
                    payment_method: {
                        card: cardNumberElement,
                        billing_details: {
                            name: pendingOrderData.customerInfo.name,
                            phone: pendingOrderData.customerInfo.phone
                        }
                    }
                });

                if (error) {
                    document.getElementById('card-errors').textContent = error.message;
                } else if (paymentIntent.status === 'succeeded') {
                    await completeOrder('card', {
                        paymentIntentId: paymentIntent.id,
                        last4: paymentIntent.payment_method_types[0] // Will be updated with actual card info
                    });
                }
            } catch (error) {
                console.error('Payment error:', error);
                document.getElementById('card-errors').textContent = error.message || 'Payment failed. Please try again.';
            } finally {
                // Reset button state
                submitBtn.disabled = false;
                btnText.style.display = 'flex';
                btnSpinner.style.display = 'none';
            }
        }

        // ============== TERMINAL PAYMENT (STRIPE TERMINAL) ==============

        async function initializeTerminalPayment() {
            const messageEl = document.getElementById('terminalMessage');
            const spinnerEl = document.getElementById('terminalSpinner');

            if (!stripe) {
                messageEl.textContent = 'Stripe is not configured';
                spinnerEl.style.display = 'none';
                return;
            }

            messageEl.textContent = 'Connecting to card reader...';

            try {
                // In production, you would:
                // 1. Create a connection token from your server
                // 2. Initialize Stripe Terminal
                // 3. Discover and connect to readers
                // 4. Collect payment method
                // 5. Process payment

                // For now, show placeholder message
                setTimeout(() => {
                    messageEl.textContent = 'No card readers found. Please connect a Stripe Terminal reader.';
                    spinnerEl.style.display = 'none';
                }, 2000);

                // Example of what the real implementation would look like:
                /*
                const terminal = StripeTerminal.create({
                    onFetchConnectionToken: async () => {
                        const response = await fetch('/api/pos/connection-token');
                        const { secret } = await response.json();
                        return secret;
                    },
                    onUnexpectedReaderDisconnect: () => {
                        messageEl.textContent = 'Reader disconnected';
                    }
                });

                const discoverResult = await terminal.discoverReaders();
                if (discoverResult.discoveredReaders.length > 0) {
                    await terminal.connectReader(discoverResult.discoveredReaders[0]);
                    messageEl.textContent = 'Present card to reader...';

                    // Create payment intent and collect payment
                    const intent = await createPaymentIntent();
                    const result = await terminal.collectPaymentMethod(intent.client_secret);
                    const processResult = await terminal.processPayment(result.paymentIntent);

                    if (processResult.paymentIntent.status === 'succeeded') {
                        completeOrder('terminal', { paymentIntentId: processResult.paymentIntent.id });
                    }
                }
                */
            } catch (error) {
                console.error('Terminal error:', error);
                messageEl.textContent = 'Error connecting to reader: ' + error.message;
                spinnerEl.style.display = 'none';
            }
        }

        function cancelTerminalPayment() {
            showPaymentMethods();
        }

        // ============== ORDER COMPLETION ==============

        async function completeOrder(paymentMethod, paymentDetails) {
            const { subtotal, tax, deliveryFee, total, customerInfo } = pendingOrderData;

            let serverOrder = null;

            // POST to server for persistence
            try {
                const response = await fetch('/api/pos/orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orderType: orderType,
                        employeeId: posEmployee ? posEmployee.id : null,
                        items: orderItems.map(i => ({
                            name: i.name,
                            qty: i.qty,
                            price: i.price,
                            lineTotal: i.price * i.qty,
                            modifiers: i.modifiers || null
                        })),
                        subtotal: subtotal,
                        taxAmount: tax,
                        deliveryFee: deliveryFee,
                        total: total,
                        customerName: customerInfo.name,
                        customerPhone: customerInfo.phone,
                        customerAddress: customerInfo.fullAddress,
                        deliveryDistance: customerInfo.deliveryDistance,
                        notes: customerInfo.instructions,
                        payment: {
                            method: paymentMethod,
                            details: paymentDetails
                        }
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        serverOrder = data.order;
                        lastCompletedOrderId = data.order.id;
                    }
                }
            } catch (e) {
                console.warn('Failed to save order to server, using localStorage fallback:', e);
            }

            // Add to order history (with server order number if available)
            addToOrderHistory({
                type: orderType,
                items: [...orderItems],
                subtotal: subtotal,
                tax: tax,
                deliveryFee: deliveryFee,
                total: total,
                customerName: customerInfo.name,
                customerPhone: customerInfo.phone,
                pickupTime: customerInfo.pickupTime,
                streetAddress: customerInfo.streetAddress,
                aptUnit: customerInfo.aptUnit,
                city: customerInfo.city,
                state: customerInfo.state,
                zipCode: customerInfo.zipCode,
                fullAddress: customerInfo.fullAddress,
                deliveryInstructions: customerInfo.instructions,
                deliveryDistance: customerInfo.deliveryDistance,
                deliveryDuration: customerInfo.deliveryDuration,
                paymentMethod: paymentMethod,
                paymentDetails: paymentDetails
            }, serverOrder);

            // Show success screen
            document.getElementById('cashPayment').style.display = 'none';
            document.getElementById('cardPayment').style.display = 'none';
            document.getElementById('terminalPayment').style.display = 'none';
            document.getElementById('paymentSuccess').style.display = 'block';

            document.getElementById('successAmount').textContent = `$${total.toFixed(2)}`;

            const methodLabels = {
                'cash': '💵 Paid with Cash',
                'card': '💳 Paid with Card',
                'terminal': '📱 Paid with Card Reader'
            };
            document.getElementById('successMethod').textContent = methodLabels[paymentMethod];
        }

        function finishPayment() {
            // Close modal
            closePaymentModal();

            // Clear order
            orderItems = [];
            document.getElementById('customerName').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('pickupTime').value = '';
            document.getElementById('streetAddress').value = '';
            document.getElementById('aptUnit').value = '';
            document.getElementById('city').value = '';
            document.getElementById('state').value = '';
            document.getElementById('zipCode').value = '';
            document.getElementById('deliveryInstructions').value = '';
            document.getElementById('mapPreview').style.display = 'none';
            deliveryDistanceInfo = null;
            deliveryFee = 0;

            setOrderType('dine-in');
            renderOrder();
            updateOrderNumber();
            loadProductAvailability(); // Refresh stock badges after sale
        }

        // Void order with permission check + manager override
        async function voidOrder(orderId) {
            if (!confirm('Void this order? Inventory will be restored.')) return;

            async function doVoid(overrideCode) {
                const body = { status: 'voided' };
                if (overrideCode) body.overrideCode = overrideCode;
                try {
                    const res = await fetch(`/api/pos/orders/${orderId}/status`, {
                        method: 'PATCH',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(body)
                    });
                    const data = await res.json();
                    if (data.success) {
                        // Reload order history from server
                        await loadPosData();
                        loadProductAvailability();
                    } else if (data.needsOverride) {
                        const code = prompt('Manager code required to void:');
                        if (code) doVoid(code);
                    } else {
                        alert(data.error || 'Failed to void order');
                    }
                } catch (e) {
                    alert('Failed to void order');
                }
            }

            doVoid(null);
        }

        // Receipt functions
        async function printReceipt() {
            if (!lastCompletedOrderId) { window.print(); return; }
            try {
                const res = await fetch(`/api/pos/orders/${lastCompletedOrderId}/receipt`);
                const data = await res.json();
                if (data.success) {
                    const win = window.open('', '_blank', 'width=420,height=600');
                    win.document.write(`<html><head><title>Receipt</title><style>@media print{body{margin:0}}</style></head><body>${data.receipt.html}<script>setTimeout(()=>{window.print();window.close()},300)<\/script></body></html>`);
                    win.document.close();
                } else {
                    window.print();
                }
            } catch (e) {
                window.print();
            }
        }

        async function emailReceipt() {
            if (!lastCompletedOrderId) return;
            const email = prompt('Enter email address for receipt:');
            if (!email) return;
            try {
                const res = await fetch(`/api/pos/orders/${lastCompletedOrderId}/receipt/email`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ email })
                });
                const data = await res.json();
                if (data.success) {
                    alert(`Receipt sent to ${email}`);
                } else {
                    alert(data.error || 'Failed to send receipt');
                }
            } catch (e) {
                alert('Could not send receipt. Email service may not be configured.');
            }
        }

        async function textReceipt() {
            if (!lastCompletedOrderId) return;
            const phone = pendingOrderData?.customerInfo?.phone || prompt('Enter phone number for receipt:');
            if (!phone) return;
            try {
                const res = await fetch(`/api/pos/orders/${lastCompletedOrderId}/receipt/sms`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ phone })
                });
                const data = await res.json();
                if (data.success) {
                    alert(`Receipt texted to ${phone}`);
                } else {
                    alert(data.error || 'Failed to send receipt');
                }
            } catch (e) {
                alert('Could not send receipt. SMS service may not be configured.');
            }
        }

        // Google Maps initialization (called when API loads)
        function initGoogleMaps() {
            googleMapsLoaded = true;
            console.log('Google Maps API loaded');

            // Initialize autocomplete on street address field
            const streetInput = document.getElementById('streetAddress');
            if (streetInput && google.maps.places) {
                autocomplete = new google.maps.places.Autocomplete(streetInput, {
                    componentRestrictions: { country: 'us' },
                    fields: ['address_components', 'geometry', 'formatted_address'],
                    types: ['address']
                });

                autocomplete.addListener('place_changed', handlePlaceSelect);
            }

            // Geocode store location for distance calculations
            geocodeStoreLocation();
        }

        // Geocode the store location
        function geocodeStoreLocation() {
            if (!googleMapsLoaded) return;

            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({ address: storeLocation.address }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    storeLocation.lat = results[0].geometry.location.lat();
                    storeLocation.lng = results[0].geometry.location.lng();
                }
            });
        }

        // Handle place selection from autocomplete
        function handlePlaceSelect() {
            const place = autocomplete.getPlace();

            if (!place.geometry) return;

            // Extract address components
            const components = {};
            place.address_components.forEach(component => {
                const type = component.types[0];
                if (type === 'street_number') components.streetNumber = component.long_name;
                if (type === 'route') components.street = component.long_name;
                if (type === 'locality') components.city = component.long_name;
                if (type === 'administrative_area_level_1') components.state = component.short_name;
                if (type === 'postal_code') components.zip = component.long_name;
            });

            // Fill in the form fields
            if (components.streetNumber && components.street) {
                document.getElementById('streetAddress').value = `${components.streetNumber} ${components.street}`;
            }
            if (components.city) document.getElementById('city').value = components.city;
            if (components.state) document.getElementById('state').value = components.state;
            if (components.zip) document.getElementById('zipCode').value = components.zip;

            // Calculate distance and show map
            const destLat = place.geometry.location.lat();
            const destLng = place.geometry.location.lng();
            calculateDeliveryDistance(destLat, destLng);
            showMapPreview(destLat, destLng);
        }

        // Calculate delivery distance using Distance Matrix API
        function calculateDeliveryDistance(destLat, destLng) {
            if (!googleMapsLoaded || !storeLocation.lat) {
                return;
            }

            const service = new google.maps.DistanceMatrixService();
            const origin = new google.maps.LatLng(storeLocation.lat, storeLocation.lng);
            const destination = new google.maps.LatLng(destLat, destLng);

            const mapStatus = document.getElementById('mapStatus');
            mapStatus.className = 'map-status calculating';
            mapStatus.textContent = '📍 Calculating distance...';

            service.getDistanceMatrix({
                origins: [origin],
                destinations: [destination],
                travelMode: google.maps.TravelMode.DRIVING,
                unitSystem: google.maps.UnitSystem.IMPERIAL
            }, (response, status) => {
                if (status === 'OK' && response.rows[0].elements[0].status === 'OK') {
                    const result = response.rows[0].elements[0];
                    const distanceText = result.distance.text;
                    const durationText = result.duration.text;
                    const distanceMiles = result.distance.value / 1609.34;

                    deliveryDistanceInfo = {
                        distance: distanceText,
                        duration: durationText,
                        distanceMiles: distanceMiles
                    };

                    // Check if within delivery range
                    if (distanceMiles <= posSettings.maxDeliveryDistance) {
                        mapStatus.className = 'map-status valid';
                        mapStatus.textContent = `✓ ${distanceText} away • Est. ${durationText} delivery time`;

                        // Calculate variable delivery fee if enabled
                        if (posSettings.deliveryFeeType === 'variable') {
                            deliveryFee = posSettings.baseDeliveryFee + (distanceMiles * posSettings.perMileFee);
                            renderOrder();
                        }
                    } else {
                        mapStatus.className = 'map-status invalid';
                        mapStatus.textContent = `✗ ${distanceText} away - Outside delivery range (max ${posSettings.maxDeliveryDistance} mi)`;
                    }
                } else {
                    mapStatus.className = 'map-status invalid';
                    mapStatus.textContent = '✗ Could not calculate distance';
                }
            });
        }

        // Show map preview with delivery location
        function showMapPreview(lat, lng) {
            const mapPreview = document.getElementById('mapPreview');
            const mapContainer = document.getElementById('mapContainer');
            mapPreview.style.display = 'block';

            if (!map) {
                map = new google.maps.Map(mapContainer, {
                    center: { lat, lng },
                    zoom: 14,
                    disableDefaultUI: true,
                    zoomControl: true,
                    styles: [
                        { featureType: 'poi', stylers: [{ visibility: 'off' }] }
                    ]
                });
            } else {
                map.setCenter({ lat, lng });
            }

            if (marker) {
                marker.setMap(null);
            }

            marker = new google.maps.Marker({
                position: { lat, lng },
                map: map,
                title: 'Delivery Location',
                animation: google.maps.Animation.DROP
            });
        }

        // Manual address verification when fields are filled manually
        function verifyAddressManually() {
            if (!googleMapsLoaded) return;

            const street = document.getElementById('streetAddress').value.trim();
            const city = document.getElementById('city').value.trim();
            const state = document.getElementById('state').value.trim();
            const zip = document.getElementById('zipCode').value.trim();

            if (!street || !city || !state) return;

            const fullAddress = `${street}, ${city}, ${state} ${zip}`;
            const geocoder = new google.maps.Geocoder();

            geocoder.geocode({ address: fullAddress }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    const lat = results[0].geometry.location.lat();
                    const lng = results[0].geometry.location.lng();
                    calculateDeliveryDistance(lat, lng);
                    showMapPreview(lat, lng);
                }
            });
        }


        // Add completed order to history
        function addToOrderHistory(orderData, serverOrder) {
            const now = new Date();
            const useServerNumber = serverOrder && serverOrder.orderNumber;

            orderHistory.push({
                // Order info — use server order number when available
                orderNumber: useServerNumber ? serverOrder.orderNumber : orderNumber,
                serverId: serverOrder ? serverOrder.id : null,
                time: now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }),
                timestamp: now.toISOString(),
                date: now.toISOString().split('T')[0],
                type: orderData.type,
                // Items
                items: orderData.items,
                itemCount: orderData.items.reduce((sum, i) => sum + i.qty, 0),
                itemsList: orderData.items.map(i => `${i.qty}x ${i.name}`).join('; '),
                // Financials
                subtotal: orderData.subtotal,
                tax: orderData.tax,
                deliveryFee: orderData.deliveryFee,
                total: orderData.total,
                // Customer info - separate CSV components
                customerName: orderData.customerName || '',
                customerPhone: orderData.customerPhone || '',
                pickupTime: orderData.pickupTime || '',
                // Address components - separate CSV fields
                streetAddress: orderData.streetAddress || '',
                aptUnit: orderData.aptUnit || '',
                city: orderData.city || '',
                state: orderData.state || '',
                zipCode: orderData.zipCode || '',
                fullAddress: orderData.fullAddress || '',
                deliveryInstructions: orderData.deliveryInstructions || '',
                // Distance info
                deliveryDistance: orderData.deliveryDistance || '',
                deliveryDuration: orderData.deliveryDuration || ''
            });

            // Only increment local counter for offline orders
            if (!useServerNumber) {
                orderNumber++;
            }
            saveOrderHistory();
        }

        // Calculate delivery fee based on settings
        function calculateDeliveryFee(subtotal) {
            if (subtotal >= posSettings.freeDeliveryThreshold && posSettings.freeDeliveryThreshold > 0) {
                return 0;
            }
            if (posSettings.deliveryFeeType === 'fixed') {
                return posSettings.fixedDeliveryFee;
            }
            // For variable, would need distance calculation - default to base fee
            return posSettings.baseDeliveryFee;
        }

        // Category to subcategory mapping (includes add-ons within each category)
        const categoryStructure = {
            'Salads': ['Salads', '➕ Salad Add-ons'],
            'Pizza': ['Pizza', '➕ Pizza Add-ons'],
            'Calzones': ['Calzones', '➕ Calzone Add-ons'],
            'Subs': ['Hot Subs', 'Cold Subs', 'Omelette Subs', '➕ Sub Add-ons'],
            'Sandwiches': ['Sandwiches', 'Clubs', '➕ Sandwich Add-ons'],
            'Dinners': ['Dinner Plates', 'Rice Plates', 'Burrito Bowls', 'Fajita Bowls', '➕ Rice Plate Add-ons'],
            'Desserts': ['Açai', 'Chocozone', 'Other']
        };

        // Subcategory icons
        const subcatIcons = {
            'Hot Subs': '🔥',
            'Cold Subs': '❄️',
            'Omelette Subs': '🍳',
            'Sandwiches': '🥪',
            'Clubs': '🥪',
            'Dinner Plates': '🍽️',
            'Rice Plates': '🍚',
            'Burrito Bowls': '🌯',
            'Fajita Bowls': '🌶️',
            'Açai': '🫐',
            'Chocozone': '🍫',
            'Other': '🍪',
            'Salads': '🥗',
            'Pizza': '🍕',
            'Calzones': '🥟',
            '➕ Salad Add-ons': '🥗',
            '➕ Pizza Add-ons': '🍕',
            '➕ Calzone Add-ons': '🥟',
            '➕ Sub Add-ons': '🥖',
            '➕ Sandwich Add-ons': '🥪',
            '➕ Rice Plate Add-ons': '🍚'
        };

        // Product name to icon mapping (checked first)
        const productIcons = {
            // Pizza
            'pizza': '🍕',
            // Wings & Chicken
            'wing': '🍗',
            'chicken': '🍗',
            'finger': '🍗',
            'fried chicken': '🍗',
            // Fries
            'fries': '🍟',
            'fry': '🍟',
            'onion ring': '🧅',
            // Burgers
            'burger': '🍔',
            'cheeseburger': '🍔',
            'hamburger': '🍔',
            // Tacos & Mexican
            'taco': '🌮',
            'burrito': '🌯',
            'fajita': '🌯',
            'nacho': '🧀',
            'quesadilla': '🌮',
            // Salads
            'salad': '🥗',
            'caesar': '🥗',
            'garden': '🥗',
            'greek': '🥗',
            // Sandwiches & Subs
            'sub': '🥖',
            'sandwich': '🥪',
            'club': '🥪',
            'blt': '🥓',
            'gyro': '🥙',
            'wrap': '🌯',
            // Hot Dogs
            'hot dog': '🌭',
            // Pasta
            'pasta': '🍝',
            'spaghetti': '🍝',
            'lasagna': '🍝',
            'ziti': '🍝',
            'alfredo': '🍝',
            'marinara': '🍝',
            // Seafood
            'shrimp': '🦐',
            'fish': '🐟',
            'haddock': '🐟',
            'seafood': '🦐',
            // Steak & Beef
            'steak': '🥩',
            'beef': '🥩',
            'roast beef': '🥩',
            'pastrami': '🥩',
            // Calzones
            'calzone': '🥟',
            // Desserts
            'cookie': '🍪',
            'brownie': '🍫',
            'ice cream': '🍦',
            'açai': '🫐',
            'acai': '🫐',
            'chocozone': '🍫',
            'donut': '🍩',
            'cake': '🍰',
            // Drinks
            'drink': '🥤',
            'soda': '🥤',
            'coffee': '☕',
            'tea': '🍵',
            'water': '💧',
            'juice': '🧃',
            // Breakfast
            'egg': '🍳',
            'omelette': '🍳',
            'bacon': '🥓',
            'sausage': '🌭',
            // Sides
            'rice': '🍚',
            'coleslaw': '🥬',
            'mozzarella': '🧀',
            'cheese': '🧀',
            'jalapeño': '🌶️',
            'poppers': '🌶️',
            'broccoli': '🥦',
            // Sauces & Add-ons
            'sauce': '🫙',
            'dressing': '🫙',
            'guac': '🥑',
            'avocado': '🥑',
            'salsa': '🫙',
            'pita': '🫓'
        };

        // Category icon mapping (fallback)
        const categoryIcons = {
            'Appetizers': '🍟',
            'Salads': '🥗',
            'Pizza': '🍕',
            'Calzones': '🥟',
            'Subs': '🥖',
            'Sandwiches': '🥪',
            'Wraps': '🌯',
            'Dinners': '🍽️',
            'Pasta': '🍝',
            'Desserts': '🍰',
            'Drinks': '🥤',
            'Catering': '🍱',
            'Add-ons': '➕',
            'default': '🍴'
        };

        // Load products from API
        async function loadProducts() {
            try {
                const res = await fetch('/api/products/list');
                const products = await res.json();
                allProducts = Array.isArray(products) ? products : [];
                renderProducts();
            } catch (err) {
                console.error('Error loading products:', err);
                document.getElementById('productsGrid').innerHTML =
                    '<div class="loading-products">Error loading products</div>';
            }
        }

        // Render products based on selected category and subcategory
        function renderProducts() {
            const grid = document.getElementById('productsGrid');
            const subcats = categoryStructure[currentCategory];

            // If category has subcategories and none is selected, show subcategory buttons
            if (subcats && !currentSubcategory && !subcatExpanded) {
                grid.innerHTML = `<div class="subcat-grid">` + subcats.map(sub => `
                    <div class="subcat-btn" onclick="selectSubcategory('${sub}')">
                        <span class="subcat-icon">${subcatIcons[sub] || '📁'}</span>
                        <span class="subcat-name">${sub}</span>
                    </div>
                `).join('') + `</div>`;
                return;
            }

            let filtered = allProducts;

            // Filter by main category
            if (currentCategory !== 'All') {
                filtered = allProducts.filter(p => {
                    const cat = (p.category || '').toLowerCase();
                    const name = (p.product_name || '').toLowerCase();
                    const selected = currentCategory.toLowerCase();

                    return cat.includes(selected) || selected.includes(cat) ||
                           matchesCategoryKeywords(name, cat, selected);
                });
            }

            // Filter by subcategory if selected
            if (currentSubcategory) {
                filtered = filtered.filter(p => {
                    const cat = (p.category || '').toLowerCase();
                    const name = (p.product_name || '').toLowerCase();
                    const subcat = currentSubcategory.toLowerCase();

                    return cat.includes(subcat) || subcat.includes(cat) ||
                           name.includes(subcat) || matchesSubcategoryKeywords(name, cat, subcat);
                });
            }

            // Build the product HTML
            const productHTML = filtered.length === 0
                ? '<div class="loading-products">No products found</div>'
                : filtered.map(product => {
                    const name = product.product_name || product.name || 'Unknown';
                    const icon = getProductIcon(name, product.category);
                    let basePrice = parseFloat(product.selling_price || 0);

                    // Add tax to displayed price if "included in prices" is enabled
                    let displayPrice = basePrice;
                    if (posSettings.taxEnabled && posSettings.taxDisplay === 'included') {
                        displayPrice = basePrice * (1 + posSettings.taxRate / 100);
                    }

                    // Check availability (Phase 2)
                    const avail = productAvailability[String(product.id)];
                    const is86d = avail && !avail.available;
                    const isLow = avail && avail.lowStock && !is86d;

                    // In 86 mode: all products clickable, click toggles 86
                    const clickAction = eightySixMode
                        ? `toggle86Product(${product.id})`
                        : `addToOrder(${product.id}, '${escapeHtml(name)}', ${displayPrice})`;

                    // Classes + inline overrides for 86 mode
                    let classes = 'product-btn';
                    let inlineStyle = '';
                    if (eightySixMode) {
                        inlineStyle = 'pointer-events:auto; cursor:pointer; position:relative;';
                        if (is86d) inlineStyle += ' opacity:0.65;';
                    } else {
                        if (is86d) classes += ' out-of-stock';
                        else if (isLow) classes += ' low-stock';
                        if (is86d || isLow) inlineStyle = 'position:relative;';
                    }

                    // Build badge HTML (low stock only — 86'd uses CSS class)
                    let badgeHTML = '';
                    if (isLow && !eightySixMode) {
                        badgeHTML = '<div class="product-low-badge">LOW</div>';
                    }

                    return `
                        <div class="${classes}" style="${inlineStyle}" onclick="${clickAction}">
                            ${badgeHTML}
                            <span class="product-icon">${icon}</span>
                            <span class="product-name">${escapeHtml(name)}</span>
                            <span class="product-price">$${displayPrice.toFixed(2)}</span>
                        </div>
                    `;
                }).join('');

            // If subcategory is expanded, show subcat button on left + products
            if (currentSubcategory && subcatExpanded) {
                grid.innerHTML = `
                    <div class="subcat-expanded">
                        <div class="subcat-btn active" onclick="collapseSubcategory()">
                            <span class="subcat-icon">${subcatIcons[currentSubcategory] || '📁'}</span>
                            <span class="subcat-name">${currentSubcategory}</span>
                        </div>
                        <div class="products-grid">${productHTML}</div>
                    </div>
                `;
            } else {
                grid.innerHTML = `<div class="products-grid">${productHTML}</div>`;
            }
        }

        // Select a subcategory
        function selectSubcategory(subcat) {
            currentSubcategory = subcat;
            subcatExpanded = true;
            renderProducts();
        }

        // Collapse subcategory view back to showing all subcategories
        function collapseSubcategory() {
            currentSubcategory = null;
            subcatExpanded = false;
            renderProducts();
        }

        // Category keyword matching
        function matchesCategoryKeywords(name, cat, selected) {
            const categoryKeywords = {
                'appetizers': ['wing', 'fries', 'fry', 'mozzarella', 'poppers', 'onion ring', 'chicken finger', 'broccoli bite', 'cheesy stix', 'coleslaw', 'potato salad', 'rice'],
                'salads': ['salad', 'caesar', 'greek', 'garden', 'antipasto', 'chef'],
                'pizza': ['pizza'],
                'calzones': ['calzone'],
                'subs': ['sub', 'hot sub', 'cold sub', 'omelette'],
                'sandwiches': ['sandwich', 'club', 'burger', 'gyro', 'blt'],
                'wraps': ['wrap', 'burrito', 'fajita'],
                'dinners': ['dinner', 'plate', 'bowl', 'rice plate'],
                'pasta': ['pasta', 'lasagna', 'ziti', 'spaghetti', 'alfredo', 'marinara', 'parm'],
                'desserts': ['cookie', 'brownie', 'açai', 'acai', 'chocozone', 'dessert'],
                'drinks': ['drink', 'can', 'bottle', 'soda', 'coffee', 'tea', '2 l', '20 oz'],
                'catering': ['catering', 'giant', 'party'],
                'add-ons': ['add-on']
            };

            const keywords = categoryKeywords[selected] || [];

            // For add-ons tab, only show general add-ons (exclude category-specific ones)
            if (selected === 'add-ons') {
                const isAddOn = name.includes('add-on') || cat.includes('add-on');
                const isSpecificAddOn = name.includes('(salad)') || name.includes('(pizza') ||
                                        name.includes('(calzone)') || name.includes('(sub') ||
                                        name.includes('(sandwich)') || name.includes('(rice');
                return isAddOn && !isSpecificAddOn;
            }

            return keywords.some(kw => name.includes(kw) || cat.includes(kw));
        }

        // Subcategory keyword matching
        function matchesSubcategoryKeywords(name, cat, subcat) {
            const subcategoryKeywords = {
                // Main items (non-addons)
                'salads': ['salad'],
                'pizza': ['pizza'],
                'calzones': ['calzone'],
                'hot subs': ['hot sub'],
                'cold subs': ['cold sub'],
                'omelette subs': ['omelette sub', 'omelette'],
                'sandwiches': ['sandwich'],
                'clubs': ['club'],
                'dinner plates': ['dinner plate'],
                'rice plates': ['rice plate'],
                'burrito bowls': ['burrito bowl'],
                'fajita bowls': ['fajita bowl'],
                'açai': ['açai', 'acai'],
                'chocozone': ['chocozone'],
                'other': ['cookie', 'brownie', 'dessert'],
                // Add-ons within categories
                '➕ salad add-ons': ['add-on (salad)'],
                '➕ pizza add-ons': ['add-on (pizza'],
                '➕ calzone add-ons': ['add-on (calzone)'],
                '➕ sub add-ons': ['add-on (sub'],
                '➕ sandwich add-ons': ['add-on (sandwich)'],
                '➕ rice plate add-ons': ['add-on (rice']
            };

            const keywords = subcategoryKeywords[subcat] || [subcat];
            // For main item subcats, exclude add-ons
            if (!subcat.includes('add-on')) {
                return keywords.some(kw => name.includes(kw) || cat.includes(kw)) && !name.includes('add-on');
            }
            return keywords.some(kw => name.includes(kw) || cat.includes(kw));
        }

        // Get icon based on product name first, then category
        function getProductIcon(productName, category) {
            // First check product name
            if (productName) {
                const name = productName.toLowerCase();
                for (const [key, icon] of Object.entries(productIcons)) {
                    if (name.includes(key.toLowerCase())) {
                        return icon;
                    }
                }
            }

            // Fall back to category
            if (category) {
                const cat = category.toLowerCase();
                for (const [key, icon] of Object.entries(categoryIcons)) {
                    if (cat.includes(key.toLowerCase()) || key.toLowerCase().includes(cat)) {
                        return icon;
                    }
                }
            }

            return categoryIcons['default'];
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        // Add item to order
        function addToOrder(productId, name, price) {
            const existing = orderItems.find(item => item.id === productId);
            if (existing) {
                existing.qty += 1;
            } else {
                orderItems.push({ id: productId, name: name, price: price, qty: 1 });
            }
            renderOrder();
        }

        // Update item quantity
        function updateQty(productId, delta) {
            const item = orderItems.find(i => i.id === productId);
            if (item) {
                item.qty += delta;
                if (item.qty <= 0) {
                    orderItems = orderItems.filter(i => i.id !== productId);
                }
            }
            renderOrder();
        }

        // Render order panel
        function renderOrder() {
            const itemsContainer = document.getElementById('orderItems');
            const itemsTotal = orderItems.reduce((sum, item) => sum + (item.price * item.qty), 0);

            // Calculate tax based on settings
            const taxRate = posSettings.taxEnabled ? (posSettings.taxRate / 100) : 0;
            let subtotal, tax, total;

            if (posSettings.taxDisplay === 'included' && posSettings.taxEnabled) {
                // Tax is included in prices - extract it
                subtotal = itemsTotal / (1 + taxRate);
                tax = itemsTotal - subtotal;
                // Recalculate delivery fee based on pre-tax subtotal
                if (orderType === 'delivery') {
                    deliveryFee = calculateDeliveryFee(subtotal);
                }
                total = itemsTotal + deliveryFee;
            } else {
                // Tax is added at checkout
                subtotal = itemsTotal;
                tax = subtotal * taxRate;
                // Recalculate delivery fee if delivery is selected
                if (orderType === 'delivery') {
                    deliveryFee = calculateDeliveryFee(subtotal);
                }
                total = subtotal + tax + deliveryFee;
            }

            if (orderItems.length === 0) {
                itemsContainer.innerHTML = `
                    <div class="order-empty">
                        <div class="order-empty-icon">🛒</div>
                        <div>No items yet</div>
                        <div style="font-size: 13px; margin-top: 8px;">Tap products to add them</div>
                    </div>
                `;
            } else {
                itemsContainer.innerHTML = orderItems.map(item => `
                    <div class="order-item">
                        <div class="order-item-info">
                            <div class="order-item-name">${item.name}</div>
                            <div class="order-item-price">$${item.price.toFixed(2)} each</div>
                        </div>
                        <div class="order-item-qty">
                            <button class="qty-btn" onclick="updateQty(${item.id}, -1)">−</button>
                            <span style="min-width: 24px; text-align: center; font-weight: 600;">${item.qty}</span>
                            <button class="qty-btn" onclick="updateQty(${item.id}, 1)">+</button>
                        </div>
                    </div>
                `).join('');
            }

            // Update summary
            document.getElementById('subtotalAmount').textContent = `$${subtotal.toFixed(2)}`;

            // Update tax display
            const taxRow = document.getElementById('taxRow');
            if (posSettings.taxEnabled) {
                taxRow.style.display = 'flex';
                if (posSettings.taxDisplay === 'included') {
                    document.getElementById('taxLabelDisplay').textContent = `${posSettings.taxLabel} (${posSettings.taxRate}% incl.)`;
                } else {
                    document.getElementById('taxLabelDisplay').textContent = `${posSettings.taxLabel} (${posSettings.taxRate}%)`;
                }
                document.getElementById('taxAmount').textContent = `$${tax.toFixed(2)}`;
            } else {
                taxRow.style.display = 'none';
            }

            document.getElementById('totalAmount').textContent = `$${total.toFixed(2)}`;

            // Update delivery fee row
            const deliveryFeeRow = document.getElementById('deliveryFeeRow');
            if (orderType === 'delivery') {
                deliveryFeeRow.style.display = 'flex';
                if (deliveryFee === 0 && subtotal >= posSettings.freeDeliveryThreshold) {
                    document.getElementById('deliveryFeeAmount').textContent = 'FREE';
                    document.getElementById('deliveryFeeAmount').style.color = '#10b981';
                } else {
                    document.getElementById('deliveryFeeAmount').textContent = `$${deliveryFee.toFixed(2)}`;
                    document.getElementById('deliveryFeeAmount').style.color = '';
                }
            } else {
                deliveryFeeRow.style.display = 'none';
            }

            // Update pay button
            const payBtn = document.getElementById('payBtn');
            payBtn.textContent = `Pay $${total.toFixed(2)}`;
            payBtn.disabled = orderItems.length === 0;
        }

        // Clear order
        function clearOrder() {
            if (orderItems.length > 0 && !confirm('Clear all items from order?')) return;
            orderItems = [];
            // Reset customer info
            document.getElementById('customerName').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('pickupTime').value = '';
            // Reset address fields
            document.getElementById('streetAddress').value = '';
            document.getElementById('aptUnit').value = '';
            document.getElementById('city').value = '';
            document.getElementById('state').value = '';
            document.getElementById('zipCode').value = '';
            document.getElementById('deliveryInstructions').value = '';
            // Reset map preview
            document.getElementById('mapPreview').style.display = 'none';
            deliveryDistanceInfo = null;
            renderOrder();
        }

        // Set order type (dine-in, pickup, delivery)
        function setOrderType(type) {
            orderType = type;

            // Update button states
            document.querySelectorAll('.order-type-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === type);
            });

            // Show/hide customer info section
            const customerInfo = document.getElementById('customerInfo');
            const deliveryFields = document.getElementById('deliveryFields');
            const pickupTimeRow = document.getElementById('pickupTimeRow');
            const orderSubtitle = document.getElementById('orderSubtitle');
            const orderNum = String(orderNumber).padStart(3, '0');

            if (type === 'dine-in') {
                customerInfo.classList.remove('visible');
                deliveryFee = 0;
                orderSubtitle.textContent = `Order #${orderNum} • Dine In`;
            } else if (type === 'pickup') {
                customerInfo.classList.add('visible');
                deliveryFields.style.display = 'none';
                pickupTimeRow.style.display = 'flex';
                deliveryFee = 0;
                document.getElementById('customerInfoIcon').textContent = '🥡';
                document.getElementById('customerInfoTitle').textContent = 'Pickup Information';
                orderSubtitle.textContent = `Order #${orderNum} • Pickup`;
            } else if (type === 'delivery') {
                customerInfo.classList.add('visible');
                deliveryFields.style.display = 'block';
                pickupTimeRow.style.display = 'none';
                // Calculate delivery fee from settings
                const subtotal = orderItems.reduce((sum, item) => sum + (item.price * item.qty), 0);
                deliveryFee = calculateDeliveryFee(subtotal);
                document.getElementById('customerInfoIcon').textContent = '🚗';
                document.getElementById('customerInfoTitle').textContent = 'Delivery Information';
                orderSubtitle.textContent = `Order #${orderNum} • Delivery`;
            }

            renderOrder();
        }

        // Get customer info for order
        function getCustomerInfo() {
            const streetAddress = document.getElementById('streetAddress')?.value || '';
            const aptUnit = document.getElementById('aptUnit')?.value || '';
            const city = document.getElementById('city')?.value || '';
            const state = document.getElementById('state')?.value || '';
            const zipCode = document.getElementById('zipCode')?.value || '';

            // Build full address string for display
            const fullAddress = streetAddress ?
                `${streetAddress}${aptUnit ? ', ' + aptUnit : ''}, ${city}, ${state} ${zipCode}`.trim() : null;

            return {
                type: orderType,
                name: document.getElementById('customerName').value,
                phone: document.getElementById('customerPhone').value,
                pickupTime: document.getElementById('pickupTime')?.value || null,
                // Separate address components for CSV
                streetAddress: streetAddress || null,
                aptUnit: aptUnit || null,
                city: city || null,
                state: state.toUpperCase() || null,
                zipCode: zipCode || null,
                // Full address for display
                fullAddress: fullAddress,
                instructions: document.getElementById('deliveryInstructions')?.value || null,
                // Delivery distance info from Google Maps
                deliveryDistance: deliveryDistanceInfo?.distance || null,
                deliveryDuration: deliveryDistanceInfo?.duration || null
            };
        }

        // Validate customer info
        function validateCustomerInfo() {
            if (orderType === 'dine-in') return true;

            const name = document.getElementById('customerName').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();

            if (!name) {
                alert('Please enter customer name');
                document.getElementById('customerName').focus();
                return false;
            }

            if (!phone) {
                alert('Please enter phone number');
                document.getElementById('customerPhone').focus();
                return false;
            }

            if (orderType === 'delivery') {
                const streetAddress = document.getElementById('streetAddress').value.trim();
                const city = document.getElementById('city').value.trim();
                const state = document.getElementById('state').value.trim();
                const zipCode = document.getElementById('zipCode').value.trim();

                if (!streetAddress) {
                    alert('Please enter street address');
                    document.getElementById('streetAddress').focus();
                    return false;
                }
                if (!city) {
                    alert('Please enter city');
                    document.getElementById('city').focus();
                    return false;
                }
                if (!state) {
                    alert('Please enter state');
                    document.getElementById('state').focus();
                    return false;
                }
                if (!zipCode) {
                    alert('Please enter zip code');
                    document.getElementById('zipCode').focus();
                    return false;
                }
            }

            return true;
        }

        // Process payment - opens payment modal
        function processPayment() {
            if (!validateCustomerInfo()) return;
            openPaymentModal();
        }

        // Update order number display
        async function updateOrderNumber() {
            try {
                const response = await fetch('/api/pos/next-order-number');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        orderNumber = data.sequence;
                    }
                }
            } catch (e) {
                // Use local counter as fallback
            }
            const orderSubtitle = document.getElementById('orderSubtitle');
            const orderNum = String(orderNumber).padStart(3, '0');
            orderSubtitle.textContent = `Order #${orderNum} • ${orderType === 'dine-in' ? 'Dine In' : orderType === 'pickup' ? 'Pickup' : 'Delivery'}`;
        }

        // Handle main category selection
        document.querySelectorAll('#mainCategories .category-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('#mainCategories .category-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentCategory = this.dataset.category;
                currentSubcategory = null;
                subcatExpanded = false;
                renderProducts();
            });
        });

        // ============== EMPLOYEE AUTH (Phase 3) ==============

        let posEmployee = null;
        let selectedEmployeeId = null;
        const isAdmin = {{ 'true' if g.is_super_admin or g.is_organization_admin else 'false' }};

        // Admins bypass employee selection
        if (isAdmin) {
            document.getElementById('employeeOverlay').classList.add('hidden');
            const badge = document.getElementById('employeeBadge');
            document.getElementById('badgeAvatar').textContent = '{{ g.user.username[:2]|upper if g.user and g.user.username else "AD" }}';
            document.getElementById('badgeName').textContent = '{{ g.user.username if g.user and g.user.username else "Admin" }}';
            badge.style.display = 'inline-flex';
            posEmployee = { id: null, firstName: '{{ g.user.username if g.user and g.user.username else "Admin" }}', lastName: '', position: 'Admin', canVoid: true };
        }

        function posAddDigit(d) {
            const input = document.getElementById('employeePinField');
            if (input.value.length < 10) {
                input.value += d;
                document.getElementById('pinError').textContent = '';
            }
        }

        function posClearCode() {
            document.getElementById('employeePinField').value = '';
            document.getElementById('pinError').textContent = '';
        }

        async function submitEmployeePin() {
            const code = document.getElementById('employeePinField').value.trim();
            if (!code) {
                document.getElementById('pinError').textContent = 'Enter your code';
                return;
            }

            try {
                const res = await fetch('/api/pos/auth', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ employeeCode: code })
                });
                const data = await res.json();

                if (data.success) {
                    authenticateEmployee(
                        data.employee.id,
                        data.employee.firstName,
                        data.employee.lastName,
                        data.employee.position,
                        data.employee.canVoid
                    );
                } else {
                    document.getElementById('pinError').textContent = data.error || 'Invalid code';
                    document.getElementById('employeePinField').value = '';
                }
            } catch (e) {
                document.getElementById('pinError').textContent = 'Connection error';
            }
        }

        function authenticateEmployee(id, firstName, lastName, position, canVoid = false) {
            posEmployee = { id, firstName, lastName, position, canVoid: canVoid || isAdmin };

            // Update header badge
            const badge = document.getElementById('employeeBadge');
            const initials = (firstName[0] + lastName[0]).toUpperCase();
            document.getElementById('badgeAvatar').textContent = initials;
            document.getElementById('badgeName').textContent = firstName;
            badge.style.display = 'inline-flex';

            // Hide overlay
            document.getElementById('employeeOverlay').classList.add('hidden');
        }

        function switchEmployee() {
            posEmployee = null;
            selectedEmployeeId = null;
            document.getElementById('employeeBadge').style.display = 'none';
            document.getElementById('employeeOverlay').classList.remove('hidden');
            document.getElementById('employeePinField').value = '';
            document.getElementById('pinError').textContent = '';

            // Clear server session
            fetch('/api/pos/auth/logout', { method: 'POST' }).catch(() => {});
        }

        // ============== PRODUCT AVAILABILITY + 86 MODE (Phase 2) ==============

        let productAvailability = {};
        let eightySixMode = false;
        let eightySixGroups = [];
        let productIngredientMap = {};

        async function loadProductAvailability() {
            try {
                const res = await fetch('/api/pos/product-availability');
                const data = await res.json();
                if (data.success) {
                    productAvailability = {};
                    data.availability.forEach(p => {
                        productAvailability[String(p.productId)] = p;
                    });
                    renderProducts();
                }
            } catch (e) {
                console.warn('Could not load product availability:', e);
            }
        }

        async function loadProductIngredients() {
            try {
                const res = await fetch('/api/pos/product-ingredients');
                const data = await res.json();
                if (data.success) {
                    productIngredientMap = data.ingredients;
                }
            } catch (e) {
                console.warn('Could not load product ingredients:', e);
            }
        }

        function toggle86Mode() {
            eightySixMode = !eightySixMode;
            const btn = document.getElementById('eightySixBtn');
            if (eightySixMode) {
                btn.style.background = '#dc2626';
                btn.style.color = 'white';
                btn.style.borderColor = '#dc2626';
                loadEightySixGroups();
            } else {
                btn.style.background = '#f1f3f4';
                btn.style.color = '#5f6368';
                btn.style.borderColor = 'transparent';
            }
            renderGroupBar();
            renderProducts();
        }

        async function toggle86Product(productId) {
            try {
                const res = await fetch(`/api/pos/86/${productId}`, { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    loadProductAvailability();
                    loadEightySixGroups();
                }
            } catch (e) {
                console.error('Failed to toggle 86:', e);
            }
        }

        // ============== 86 GROUPS ==============

        async function loadEightySixGroups() {
            try {
                const res = await fetch('/api/pos/86-groups');
                const data = await res.json();
                if (data.success) {
                    eightySixGroups = data.groups;
                    renderGroupBar();
                }
            } catch (e) {
                console.warn('Could not load 86 groups:', e);
            }
        }

        function renderGroupBar() {
            const bar = document.getElementById('eightySixGroupBar');
            if (!eightySixMode || eightySixGroups.length === 0) {
                bar.style.display = 'none';
                return;
            }
            bar.style.display = 'block';
            bar.innerHTML = '<span style="font-size:12px;font-weight:700;color:#991b1b;margin-right:8px;vertical-align:middle;">QUICK 86:</span>' +
                eightySixGroups.map(g => {
                    const active = g.all86d;
                    return `<button onclick="toggleGroupEightySix(${g.id})" style="
                        display:inline-block; margin: 2px 4px; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; cursor: pointer; border: 1.5px solid ${active ? '#dc2626' : '#d1d5db'};
                        background: ${active ? '#dc2626' : '#fff'}; color: ${active ? '#fff' : '#374151'}; transition: all 0.15s;
                    ">${g.groupName} <span style="opacity:0.7">${g.count86d}/${g.totalProducts}</span></button>`;
                }).join('');
        }

        async function toggleGroupEightySix(groupId) {
            try {
                const res = await fetch(`/api/pos/86-groups/${groupId}/toggle`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({})
                });
                const data = await res.json();
                if (data.success) {
                    await loadProductAvailability();
                    await loadEightySixGroups();
                }
            } catch (e) {
                console.error('Failed to toggle 86 group:', e);
            }
        }

        async function syncCategoryGroups() {
            try {
                await fetch('/api/pos/86-groups/sync-categories', { method: 'POST' });
            } catch (e) {
                console.warn('Could not sync category groups:', e);
            }
        }

        // ============== PHASE 8: CUSTOMER LOOKUP ==============

        let customerLookupTimeout = null;
        function debouncedCustomerLookup() {
            clearTimeout(customerLookupTimeout);
            const phone = document.getElementById('customerPhone').value.trim();
            const hint = document.getElementById('customerLookupHint');
            if (phone.length < 7) { hint.style.display = 'none'; return; }
            customerLookupTimeout = setTimeout(() => lookupCustomer(phone), 400);
        }

        async function lookupCustomer(phone) {
            const hint = document.getElementById('customerLookupHint');
            try {
                const res = await fetch(`/api/pos/customers/lookup?phone=${encodeURIComponent(phone)}`);
                const data = await res.json();
                if (data.success && data.customer) {
                    const c = data.customer;
                    // Auto-fill name if empty
                    const nameField = document.getElementById('customerName');
                    if (!nameField.value && c.name) nameField.value = c.name;
                    // Auto-fill address for delivery
                    if (orderType === 'delivery' && c.address) {
                        const addrField = document.getElementById('streetAddress');
                        if (!addrField.value) addrField.value = c.address;
                    }
                    let hintText = `Welcome back, ${c.name || 'customer'}! ${c.totalOrders} orders, $${c.totalSpent.toFixed(2)} total.`;
                    if (c.notes) hintText += ` Note: ${c.notes}`;
                    hint.innerHTML = hintText;
                    hint.style.display = 'block';
                    hint.style.background = '#ecfdf5';
                    hint.style.color = '#065f46';
                } else {
                    hint.innerHTML = 'New customer';
                    hint.style.display = 'block';
                    hint.style.background = '#eff6ff';
                    hint.style.color = '#1e40af';
                }
            } catch (e) {
                hint.style.display = 'none';
            }
        }

        // Initialize
        loadPosData().then(() => updateOrderNumber());
        loadProducts().then(() => { loadProductAvailability(); loadEightySixGroups(); loadProductIngredients(); });

        // Add debounced address verification for manual entry
        let addressVerifyTimeout = null;
        ['city', 'state', 'zipCode'].forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.addEventListener('blur', () => {
                    clearTimeout(addressVerifyTimeout);
                    addressVerifyTimeout = setTimeout(verifyAddressManually, 500);
                });
            }
        });
    </script>
    <script src="{{ url_for('static', filename='js/datepicker.js') }}"></script>
    <script src="{{ url_for('static', filename='js/share.js') }}"></script>
</body>
</html>
