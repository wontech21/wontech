<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Today's Intelligence</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        body {
            background: var(--theme-gradient);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .insights-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .insights-header {
            text-align: center;
            color: white;
            padding: 40px 20px 30px 20px;
        }

        .insights-header h1 {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 8px;
            text-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .insights-meta {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-top: 12px;
            font-size: 14px;
            opacity: 0.9;
        }

        .insights-meta span {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .back-btn, .refresh-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            text-decoration: none;
            position: absolute;
            top: 20px;
            left: 20px;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        .refresh-btn {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .refresh-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        .refresh-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .refresh-btn.spinning svg {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .insights-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 20px;
            padding-bottom: 40px;
        }

        .insight-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 28px 32px;
            border: 2px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .insight-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .insight-top {
            display: flex;
            align-items: flex-start;
            gap: 14px;
            margin-bottom: 12px;
        }

        .severity-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
            margin-top: 6px;
        }

        .severity-dot.critical { background: #ef4444; box-shadow: 0 0 8px rgba(239, 68, 68, 0.4); }
        .severity-dot.warning { background: #f59e0b; box-shadow: 0 0 8px rgba(245, 158, 11, 0.4); }
        .severity-dot.positive { background: #10b981; box-shadow: 0 0 8px rgba(16, 185, 129, 0.4); }
        .severity-dot.info { background: #6366f1; box-shadow: 0 0 8px rgba(99, 102, 241, 0.4); }

        .insight-title {
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
            flex: 1;
        }

        .domain-tag {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 4px 10px;
            border-radius: 6px;
            flex-shrink: 0;
        }

        .domain-tag.sales { background: #dbeafe; color: #1d4ed8; }
        .domain-tag.inventory { background: #fef3c7; color: #92400e; }
        .domain-tag.labor { background: #ede9fe; color: #5b21b6; }
        .domain-tag.costs { background: #fee2e2; color: #991b1b; }
        .domain-tag.operations { background: #e0e7ff; color: #3730a3; }

        .insight-detail {
            font-size: 15px;
            color: #4b5563;
            line-height: 1.7;
            margin-bottom: 16px;
            padding-left: 26px;
        }

        .insight-action {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 12px 16px;
            background: #f8fafc;
            border-radius: 10px;
            border-left: 3px solid #667eea;
            margin-left: 26px;
        }

        .insight-action-label {
            font-size: 12px;
            font-weight: 700;
            color: #667eea;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            flex-shrink: 0;
            margin-top: 1px;
        }

        .insight-action-text {
            font-size: 14px;
            color: #374151;
            line-height: 1.5;
        }

        .loading-state {
            text-align: center;
            color: white;
            padding: 60px 20px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        .error-state {
            text-align: center;
            color: white;
            padding: 60px 20px;
            opacity: 0.9;
        }

        @media (max-width: 640px) {
            .insights-header h1 { font-size: 28px; }
            .insight-card { padding: 20px; }
            .insight-title { font-size: 17px; }
            .insight-detail, .insight-action { margin-left: 0; padding-left: 0; }
            .back-btn { position: static; margin-bottom: 20px; display: inline-flex; }
        }
    </style>
</head>
<body>
    <div class="insights-container" style="position: relative;">
        <a href="/dashboard" class="back-btn">‚Üê Back to Dashboard</a>

        <div class="insights-header">
            <h1>Today's Intelligence</h1>
            <div class="insights-meta">
                <span id="generatedAt">Loading...</span>
                <span id="sourceLabel"></span>
                <button class="refresh-btn" id="refreshBtn" onclick="refreshInsights()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/>
                        <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                    </svg>
                    Refresh
                </button>
            </div>
        </div>

        <div id="insightsContainer" class="insights-list">
            <div class="loading-state">
                <div class="loading-spinner"></div>
                <p>Analyzing your business data...</p>
            </div>
        </div>
    </div>

    <script>
        function renderInsights(data) {
            const container = document.getElementById('insightsContainer');

            if (!data.success || !data.insights || data.insights.length === 0) {
                container.innerHTML = '<div class="error-state"><p>No insights available yet. Check back later.</p></div>';
                return;
            }

            // Update meta
            if (data.generated_at) {
                const gen = new Date(data.generated_at);
                const now = new Date();
                const diffMs = now - gen;
                const diffMins = Math.floor(diffMs / 60000);
                let ago;
                if (diffMins < 1) ago = 'Just now';
                else if (diffMins < 60) ago = diffMins + 'm ago';
                else ago = Math.floor(diffMins / 60) + 'h ago';
                document.getElementById('generatedAt').textContent = 'Updated ' + ago;
            }

            if (data.source) {
                const label = data.source === 'ai' ? 'AI-powered' : 'Rule-based';
                document.getElementById('sourceLabel').textContent = label;
            }

            container.innerHTML = data.insights.map(insight => `
                <div class="insight-card">
                    <div class="insight-top">
                        <div class="severity-dot ${insight.severity || 'info'}"></div>
                        <div class="insight-title">${escapeHtml(insight.title)}</div>
                        <span class="domain-tag ${insight.domain || 'operations'}">${escapeHtml(insight.domain || 'operations')}</span>
                    </div>
                    <div class="insight-detail">${escapeHtml(insight.detail)}</div>
                    ${insight.action ? `
                    <div class="insight-action">
                        <span class="insight-action-label">Action</span>
                        <span class="insight-action-text">${escapeHtml(insight.action)}</span>
                    </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function loadInsights() {
            try {
                const res = await fetch('/api/insights/today');
                const data = await res.json();
                renderInsights(data);
            } catch (err) {
                console.error('Error loading insights:', err);
                document.getElementById('insightsContainer').innerHTML =
                    '<div class="error-state"><p>Failed to load insights. Please try again.</p></div>';
            }
        }

        async function refreshInsights() {
            const btn = document.getElementById('refreshBtn');
            btn.disabled = true;
            btn.classList.add('spinning');

            document.getElementById('insightsContainer').innerHTML =
                '<div class="loading-state"><div class="loading-spinner"></div><p>Generating fresh insights...</p></div>';

            try {
                const res = await fetch('/api/insights/refresh', { method: 'POST' });
                const data = await res.json();
                renderInsights(data);
            } catch (err) {
                console.error('Error refreshing insights:', err);
                document.getElementById('insightsContainer').innerHTML =
                    '<div class="error-state"><p>Failed to refresh insights. Please try again.</p></div>';
            } finally {
                btn.disabled = false;
                btn.classList.remove('spinning');
            }
        }

        loadInsights();
    </script>
</body>
</html>
