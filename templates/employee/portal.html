<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <title>{{ g.organization.organization_name }}</title>
    <link rel="stylesheet" href="/static/css/employee-portal.css">
</head>
<body class="ep-body">
    <div class="ep-app">
        <!-- Status Bar Header -->
        <header class="ep-status-bar">
            <div class="ep-status-content">
                <div class="ep-user-greeting">
                    <div class="ep-greeting-text">Welcome back</div>
                    <div class="ep-user-name">{{ employee.first_name }}</div>
                </div>
                <div class="ep-header-actions">
                    <a href="/logout" class="ep-logout-btn" title="Logout">
                        Logout
                    </a>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="ep-main">
            <!-- Quick Actions -->
            <h2 class="ep-section-title">Quick Actions</h2>
            <div class="ep-actions-grid">
                <a href="/employee/schedule" class="ep-action-card">
                    <div class="ep-action-icon">üìÖ</div>
                    <div class="ep-action-title">Schedule</div>
                </a>
                <a href="/employee/time-entries" class="ep-action-card">
                    <div class="ep-action-icon">‚è±</div>
                    <div class="ep-action-title">Time</div>
                </a>
                <a href="/employee/paystubs" class="ep-action-card">
                    <div class="ep-action-icon">üíµ</div>
                    <div class="ep-action-title">Pay</div>
                </a>
                <a href="/employee/time-off" class="ep-action-card">
                    <div class="ep-action-icon">üèñ</div>
                    <div class="ep-action-title">Time Off</div>
                </a>
                <a href="/employee/availability-page" class="ep-action-card">
                    <div class="ep-action-icon">üìÜ</div>
                    <div class="ep-action-title">Availability</div>
                </a>
                <a href="/employee/profile" class="ep-action-card">
                    <div class="ep-action-icon">‚öô</div>
                    <div class="ep-action-title">Settings</div>
                </a>
            </div>

            <!-- Recent Activity -->
            <div class="ep-activity-card">
                <div class="ep-activity-header">
                    <div class="ep-activity-title">
                        <span class="ep-activity-icon">‚è∞</span>
                        Recent Hours
                    </div>
                    <a href="/employee/time-entries" class="ep-stats-link">View All</a>
                </div>
                <ul class="ep-activity-list" id="recentTimeEntries">
                    <li class="ep-empty-state ep-loading">
                        <div class="ep-empty-text">Loading...</div>
                    </li>
                </ul>
                <div class="ep-pagination" id="paginationControls" style="display: none;">
                    <button class="ep-pagination-btn" onclick="changePage('prev')" id="btnPrev">‚Äπ</button>
                    <span id="pageNumbers"></span>
                    <button class="ep-pagination-btn" onclick="changePage('next')" id="btnNext">‚Ä∫</button>
                </div>
            </div>

            <!-- Profile Summary -->
            <div class="ep-card ep-mt-2">
                <div class="ep-card-header">
                    <div class="ep-card-header-icon">üìã</div>
                    <h3 class="ep-card-title">My Info</h3>
                </div>
                <div class="ep-info-grid">
                    <div class="ep-info-item">
                        <div class="ep-info-label">ID</div>
                        <div class="ep-info-value">{{ employee.employee_code or 'N/A' }}</div>
                    </div>
                    <div class="ep-info-item">
                        <div class="ep-info-label">Position</div>
                        <div class="ep-info-value">{{ employee.position or 'N/A' }}</div>
                    </div>
                    <div class="ep-info-item">
                        <div class="ep-info-label">Department</div>
                        <div class="ep-info-value">{{ employee.department or 'N/A' }}</div>
                    </div>
                    <div class="ep-info-item">
                        <div class="ep-info-label">Email</div>
                        <div class="ep-info-value">{{ g.user.email }}</div>
                    </div>
                </div>
            </div>
        </main>

    </div>

    <!-- Notification Toast -->
    <div id="notification" class="ep-notification"></div>

    <script>
        let allTimeEntries = [];
        let currentPage = 1;
        const pageSize = 5;

        // Load recent time entries
        async function loadRecentTimeEntries() {
            try {
                const res = await fetch('/employee/time-entries/data?days=365');
                const data = await res.json();

                allTimeEntries = data.entries || [];

                if (allTimeEntries.length === 0) {
                    document.getElementById('recentTimeEntries').innerHTML = `
                        <li class="ep-empty-state">
                            <div class="ep-empty-icon">üì≠</div>
                            <div class="ep-empty-title">No time entries yet</div>
                            <div class="ep-empty-text">Your hours will appear here</div>
                        </li>
                    `;
                    document.getElementById('paginationControls').style.display = 'none';
                    return;
                }

                displayTimeEntries();

            } catch (err) {
                console.error('Error loading time entries:', err);
                document.getElementById('recentTimeEntries').innerHTML = `
                    <li class="ep-empty-state">
                        <div class="ep-empty-text" style="color: var(--ep-danger);">Error loading data</div>
                    </li>
                `;
            }
        }

        function displayTimeEntries() {
            const listEl = document.getElementById('recentTimeEntries');
            const totalPages = Math.ceil(allTimeEntries.length / pageSize);

            currentPage = Math.min(currentPage, totalPages || 1);

            const startIdx = (currentPage - 1) * pageSize;
            const endIdx = startIdx + pageSize;
            const pageEntries = allTimeEntries.slice(startIdx, endIdx);

            listEl.innerHTML = pageEntries.map(entry => {
                const date = new Date(entry.clock_in);
                const dateStr = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                const hours = (entry.hours_worked || 0).toFixed(1);
                const timeIn = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                const timeOut = entry.clock_out
                    ? new Date(entry.clock_out).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })
                    : 'Active';

                return `
                    <li class="ep-activity-item">
                        <div class="ep-activity-dot"></div>
                        <div class="ep-activity-content">
                            <div class="ep-activity-primary">${dateStr}</div>
                            <div class="ep-activity-secondary">${timeIn} - ${timeOut}</div>
                        </div>
                        <div class="ep-activity-value">${hours}h</div>
                    </li>
                `;
            }).join('');

            updatePagination();
        }

        function updatePagination() {
            const totalPages = Math.ceil(allTimeEntries.length / pageSize);

            document.getElementById('paginationControls').style.display =
                allTimeEntries.length > pageSize ? 'flex' : 'none';

            document.getElementById('btnPrev').disabled = currentPage === 1;
            document.getElementById('btnNext').disabled = currentPage === totalPages;

            const pageNumbersDiv = document.getElementById('pageNumbers');
            let pageNumbersHTML = '';

            const maxButtons = 3;
            let startPage = Math.max(1, currentPage - 1);
            let endPage = Math.min(totalPages, startPage + maxButtons - 1);

            if (endPage - startPage + 1 < maxButtons) {
                startPage = Math.max(1, endPage - maxButtons + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                pageNumbersHTML += `<button class="ep-pagination-btn ${i === currentPage ? 'active' : ''}"
                    onclick="goToPage(${i})">${i}</button>`;
            }

            pageNumbersDiv.innerHTML = pageNumbersHTML;
        }

        function changePage(direction) {
            const totalPages = Math.ceil(allTimeEntries.length / pageSize);

            if (direction === 'prev') {
                currentPage = Math.max(1, currentPage - 1);
            } else {
                currentPage = Math.min(totalPages, currentPage + 1);
            }

            displayTimeEntries();
        }

        function goToPage(page) {
            currentPage = page;
            displayTimeEntries();
        }

        // Notification helper
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            if (notification) {
                notification.textContent = message;
                notification.className = `ep-notification ep-notification-${type}`;
                notification.style.display = 'block';

                setTimeout(() => {
                    notification.style.display = 'none';
                }, 4000);
            }
        }

        // Initialize
        loadRecentTimeEntries();
    </script>
</body>
</html>
