<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Professional inventory management system for restaurants with barcode scanning">
    <meta name="theme-color" content="#6f42c1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="WONTECH">

    <title>WONTECH Data Center</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/aesthetic-enhancement.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard-components.css') }}">

    <!-- Chart.js and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/service-worker.js')
                    .then(reg => console.log('Service Worker: Registered'))
                    .catch(err => console.log('Service Worker: Registration failed', err));
            });
        }
    </script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <!-- Profile Section (Top Right) -->
            <div class="header-profile-section">
                <div class="profile-logo-container">
                    {% if g.organization.logo_url %}
                    <img src="{{ g.organization.logo_url }}" alt="{{ g.organization.organization_name }} Logo" class="profile-logo" onclick="openLogoUploadModal()">
                    {% else %}
                    <div class="profile-logo-placeholder" onclick="openLogoUploadModal()" title="Click to upload logo">
                        <span class="upload-icon">üì∏</span>
                    </div>
                    {% endif %}
                    <span class="active-indicator" title="Active"></span>
                </div>
                {% if not section and not g.is_super_admin %}
                <button class="logout-btn" onclick="logout()" style="margin-left: 15px;">üö™ Logout</button>
                {% endif %}
            </div>

            <!-- Title Section (Centered) -->
            {% if section == 'inventory' %}
            <h1>Inventory & Sales</h1>
            {% elif section == 'attendance' %}
            <h1>Employees</h1>
            {% else %}
            <h1>{{ g.organization.organization_name }} Data Center</h1>
            {% endif %}
            <div class="header-stats" id="headerStats">Loading...</div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="nav-tabs">
            {% if g.is_super_admin %}
            <button class="tab-btn" onclick="window.location.href='/admin/dashboard'" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">‚ö° Admin</button>
            {% endif %}

            {% if section and not g.is_super_admin %}
            <button class="tab-btn" onclick="window.location.href='/dashboard'" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">üè† Main</button>
            {% endif %}

            {% if not section or section == 'inventory' %}
            <!-- Inventory & Sales Tabs -->
            <button class="tab-btn active" onclick="showTab('inventory')">üìä Inventory</button>
            {% if g.user.role != 'employee' %}
            <button class="tab-btn" onclick="showTab('products')">üçî Products</button>
            <button class="tab-btn" onclick="showTab('sales')">üí∞ Sales</button>
            <button class="tab-btn" onclick="showTab('invoices')">üìÑ Invoices</button>
            <button class="tab-btn" onclick="showTab('counts')">üìã Counts</button>
            <button class="tab-btn" onclick="showTab('analytics')">üìà Analytics</button>
            <button class="tab-btn" onclick="showTab('history')">üìú History</button>
            <button class="tab-btn" onclick="showTab('settings')">‚öôÔ∏è Settings</button>
            {% endif %}
            {% endif %}

            {% if not section or section == 'attendance' %}
            <!-- Attendance Management Tabs -->
            {% if g.user.role in ['organization_admin', 'super_admin'] %}
            <button class="tab-btn active" onclick="showTab('schedules')">üìÖ Schedules</button>
            <button class="tab-btn" onclick="showTab('attendance')">‚è∞ Attendance</button>
            <button class="tab-btn" onclick="showTab('time-off-requests')">üèñÔ∏è Time Off</button>
            <button class="tab-btn" onclick="showTab('payroll')">üí∞ Payroll</button>
            <button class="tab-btn" onclick="showTab('employees')">üë• Employees</button>
            <button class="tab-btn" onclick="showTab('labor-analytics')">üìä Analytics</button>
            {% endif %}
            {% endif %}
        </nav>

        <!-- Inventory View Tab -->
        <div id="inventory-tab" class="tab-content {% if not section or section == 'inventory' %}active{% endif %}">
            <div class="page-header">
                <h2 class="page-title">Inventory Details</h2>
                <button class="btn-create-primary" onclick="openCreateIngredientModal()">
                    <span class="btn-icon">+</span> Create Ingredient
                </button>
            </div>

            <div class="filters">
                <select id="statusFilter" onchange="loadInventory()">
                    <option value="active">Active Items</option>
                    <option value="inactive">Inactive Items</option>
                    <option value="all">All Items</option>
                </select>
                <select id="ingredientFilter" onchange="loadInventory()">
                    <option value="all">All Ingredients</option>
                </select>
                <select id="categoryFilter" onchange="loadInventory()">
                    <option value="all">All Categories</option>
                </select>
                <select id="supplierFilter" onchange="loadInventory()">
                    <option value="all">All Suppliers</option>
                </select>
                <select id="brandFilter" onchange="loadInventory()">
                    <option value="all">All Brands</option>
                </select>
            </div>
            <div class="date-range-filter">
                <label class="date-label">Date Received:</label>
                <input type="date" id="dateFrom" class="date-input" placeholder="From">
                <span class="date-separator">to</span>
                <input type="date" id="dateTo" class="date-input" placeholder="To">
                <button class="btn-apply-filter" onclick="applyInventoryDateFilter()">‚úì Apply</button>
                <button class="btn-clear-dates" onclick="clearDateFilter()">Clear</button>
            </div>

            <div class="selection-controls" id="selectionControls">
                <label class="checkbox-label">
                    <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                    <span>Select All</span>
                </label>
                <button class="btn-secondary" onclick="clearSelection()">Clear Selection</button>
                <span class="selection-count" id="selectionCount">0 selected</span>
                <button class="btn-primary" id="editSelectedBtn" onclick="editSelectedCategories()" style="display:none;">Edit Selected Categories</button>
                <button class="btn-primary" onclick="editAllCategories()">Edit All Categories</button>
            </div>

            <div class="table-container">
                <table id="inventoryTable">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortTable('inventory', 0, 'string')">Ingredient <span class="sort-arrow"></span></th>
                            <th>Brand / Variant</th>
                            <th>Supplier / Variant</th>
                            <th class="sortable" onclick="sortTable('inventory', 3, 'string')">Category <span class="sort-arrow"></span></th>
                            <th class="sortable" onclick="sortTable('inventory', 4, 'number')">Total Qty <span class="sort-arrow"></span></th>
                            <th>Unit</th>
                            <th class="sortable" onclick="sortTable('inventory', 6, 'number')">Avg Cost <span class="sort-arrow"></span></th>
                            <th class="sortable" onclick="sortTable('inventory', 7, 'number')">Total Value <span class="sort-arrow"></span></th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryTableBody">
                        <tr><td colspan="9" class="loading">Loading inventory...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination Controls -->
            <div class="pagination-container">
                <div class="pagination-info">
                    <span id="inventoryPaginationInfo">Showing 0-0 of 0 items</span>
                </div>
                <div class="pagination-controls">
                    <label>Show:
                        <select id="inventoryPageSize" onchange="changeInventoryPageSize()">
                            <option value="10">10</option>
                            <option value="25" selected>25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                            <option value="all">All</option>
                        </select>
                    </label>
                    <div class="pagination-buttons">
                        <button onclick="changeInventoryPage('first')" id="inventoryFirstPage">¬´</button>
                        <button onclick="changeInventoryPage('prev')" id="inventoryPrevPage">‚Äπ</button>
                        <span id="inventoryPageNumbers"></span>
                        <button onclick="changeInventoryPage('next')" id="inventoryNextPage">‚Ä∫</button>
                        <button onclick="changeInventoryPage('last')" id="inventoryLastPage">¬ª</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Products Tab -->
        <div id="products-tab" class="tab-content">
            <div class="page-header">
                <h2 class="page-title">Products & Recipes</h2>
                <button class="btn-create-primary" onclick="openCreateProductModal()">
                    <span class="btn-icon">+</span> Create Product
                </button>
            </div>

            <div class="section-header">
                <p class="subtitle">Manage products, recipes, and cost analysis</p>
            </div>

            <div class="table-container">
                <table id="productsTable">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortTable('products', 0, 'string')">Product <span class="sort-arrow"></span></th>
                            <th class="sortable" onclick="sortTable('products', 1, 'number')">Ingredient Cost <span class="sort-arrow"></span></th>
                            <th class="sortable" onclick="sortTable('products', 2, 'number')">Selling Price <span class="sort-arrow"></span></th>
                            <th class="sortable" onclick="sortTable('products', 3, 'number')">Gross Profit <span class="sort-arrow"></span></th>
                            <th class="sortable" onclick="sortTable('products', 4, 'number')">Margin % <span class="sort-arrow"></span></th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody">
                        <tr><td colspan="6" class="loading">Loading products...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination Controls -->
            <div class="pagination-container">
                <div class="pagination-info">
                    <span id="productsPaginationInfo">Showing 0-0 of 0 items</span>
                </div>
                <div class="pagination-controls">
                    <label>Show:
                        <select id="productsPageSize" onchange="changeProductsPageSize()">
                            <option value="10" selected>10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="all">All</option>
                        </select>
                    </label>
                    <div class="pagination-buttons">
                        <button onclick="changeProductsPage('first')" id="productsFirstPage">¬´</button>
                        <button onclick="changeProductsPage('prev')" id="productsPrevPage">‚Äπ</button>
                        <span id="productsPageNumbers"></span>
                        <button onclick="changeProductsPage('next')" id="productsNextPage">‚Ä∫</button>
                        <button onclick="changeProductsPage('last')" id="productsLastPage">¬ª</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sales Tab -->
        <div id="sales-tab" class="tab-content">
            <div class="page-header">
                <h2 class="page-title">üí∞ Sales Analytics</h2>
                <button class="btn-export-primary" onclick="exportSalesRecords()">
                    üìä Export CSV
                </button>
            </div>

            <!-- Sales Analytics Dashboard (formerly in Analytics tab) -->
            <div id="sales-analytics-content">
                <!-- Time Period Selector -->
                <div class="card" style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn-time-filter" data-period="today" onclick="changeSalesPeriod('today')">Today</button>
                            <button class="btn-time-filter active" data-period="7days" onclick="changeSalesPeriod('7days')">Last 7 Days</button>
                            <button class="btn-time-filter" data-period="week" onclick="changeSalesPeriod('week')">This Week</button>
                            <button class="btn-time-filter" data-period="month" onclick="changeSalesPeriod('month')">This Month</button>
                            <button class="btn-time-filter" data-period="30days" onclick="changeSalesPeriod('30days')">Last 30 Days</button>
                            <button class="btn-time-filter" data-period="all" onclick="changeSalesPeriod('all')">All Time</button>
                            <button class="btn-time-filter" data-period="custom" onclick="showCustomDateRange()">Custom Range</button>
                        </div>
                        <div id="custom-date-range" style="display: none; gap: 10px; align-items: center;">
                            <input type="date" id="sales-start-date" style="padding: 8px; border: 2px solid #667eea; border-radius: 5px;">
                            <span>to</span>
                            <input type="date" id="sales-end-date" style="padding: 8px; border: 2px solid #667eea; border-radius: 5px;">
                            <button class="btn-success" onclick="applyCustomDateRange()" style="padding: 10px 20px; font-weight: 600; box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);">
                                ‚úì Apply Range
                            </button>
                        </div>
                        <div id="selected-period-display" style="color: #667eea; font-weight: 600;">
                            Last 7 Days
                        </div>
                    </div>
                </div>

                <!-- Summary Stats Row -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <div class="kpi-card">
                        <div class="kpi-icon">üí∞</div>
                        <div class="kpi-value" id="sales-total-revenue">$0.00</div>
                        <div class="kpi-label">Total Revenue</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-icon">üìä</div>
                        <div class="kpi-value" id="sales-total-profit">$0.00</div>
                        <div class="kpi-label">Gross Profit</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-icon">üìà</div>
                        <div class="kpi-value" id="sales-total-transactions">0</div>
                        <div class="kpi-label">Transactions</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-icon">üõí</div>
                        <div class="kpi-value" id="sales-avg-transaction">$0.00</div>
                        <div class="kpi-label">Avg Transaction</div>
                    </div>
                </div>

                <!-- Main Content Area -->
                <div style="display: grid; grid-template-columns: 1fr 350px; gap: 20px;">
                    <!-- Left Column: Charts and Product List -->
                    <div>
                        <!-- Sales Trend Chart -->
                        <div class="card" style="margin-bottom: 20px;">
                            <h3>üìà Sales Trend</h3>
                            <div id="sales-trend-chart" style="min-height: 300px; padding: 20px;">
                                <canvas id="salesTrendCanvas"></canvas>
                            </div>
                        </div>

                        <!-- Order Type Breakdown -->
                        <div class="card" style="margin-bottom: 20px;">
                            <h3>üçΩÔ∏è Sales by Order Type</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: center; padding: 20px;">
                                <div style="max-width: 250px; margin: 0 auto;">
                                    <canvas id="orderTypeCanvas"></canvas>
                                </div>
                                <div id="order-type-stats" style="display: flex; flex-direction: column; gap: 10px;">
                                    <!-- Populated by JS -->
                                </div>
                            </div>
                        </div>

                        <!-- Top Products -->
                        <div class="card">
                            <h3>üèÜ Top Selling Products</h3>
                            <div id="top-products-list" style="max-height: 500px; overflow-y: auto;">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Stats Sidebar -->
                    <div>
                        <!-- Quick Stats -->
                        <div class="card" style="margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px;">üìä Quick Stats</h3>
                            <div style="display: flex; flex-direction: column; gap: 15px;">
                                <div class="stat-item">
                                    <div style="font-size: 0.85em; color: #6c757d; margin-bottom: 5px;">üåü Best Seller</div>
                                    <div id="stat-best-seller" style="font-weight: 600; color: #667eea;">Loading...</div>
                                </div>
                                <div class="stat-item">
                                    <div style="font-size: 0.85em; color: #6c757d; margin-bottom: 5px;">‚è∞ Busiest Hour</div>
                                    <div id="stat-busiest-hour" style="font-weight: 600; color: #667eea;">Loading...</div>
                                </div>
                                <div class="stat-item">
                                    <div style="font-size: 0.85em; color: #6c757d; margin-bottom: 5px;">üíµ Highest Sale</div>
                                    <div id="stat-highest-sale" style="font-weight: 600; color: #667eea;">Loading...</div>
                                </div>
                                <div class="stat-item">
                                    <div style="font-size: 0.85em; color: #6c757d; margin-bottom: 5px;">üì¶ Items Sold</div>
                                    <div id="stat-items-sold" style="font-weight: 600; color: #667eea;">Loading...</div>
                                </div>
                                <div class="stat-item">
                                    <div style="font-size: 0.85em; color: #6c757d; margin-bottom: 5px;">üé´ Discounts Given</div>
                                    <div id="stat-discounts" style="font-weight: 600; color: #667eea;">Loading...</div>
                                </div>
                            </div>
                        </div>

                        <!-- Hourly Sales -->
                        <div class="card">
                            <h3 style="margin-bottom: 15px;">‚è∞ Sales by Hour</h3>
                            <div id="hourly-sales-chart" style="padding: 10px;">
                                <canvas id="hourlySalesCanvas" style="max-height: 200px;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Product Detail Modal -->
                <div id="product-detail-modal" class="modal" style="display: none;">
                    <div class="modal-content modal-large">
                        <div class="modal-header">
                            <h2 id="product-detail-title">Product Details</h2>
                            <button class="modal-close" onclick="closeProductDetail()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div id="product-detail-content">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CSV Sales Import Section -->
            <div style="margin-top: 30px;">
                <div class="card" style="margin-bottom: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div>
                            <h3 style="margin: 0;">üìù Import Sales Data</h3>
                            <p class="form-help-text" style="margin: 5px 0 0 0;">Upload or paste CSV sales data to process</p>
                        </div>
                        <button onclick="toggleFormatGuide()" class="btn-format-guide">
                            üìã Show Format Guide
                        </button>
                    </div>

                    <!-- Format Guide (Collapsible) -->
                    <div id="format-guide" class="format-guide-box">
                        <h4 class="format-guide-title">üìä CSV Format Guide</h4>

                        <div style="background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            <strong style="color: #28a745;">‚úì Required Format:</strong>
                            <pre style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 10px 0; overflow-x: auto; font-size: 0.9em;">Product, Quantity, Retail_Price, Time
Cheese Pizza, 100, 14.99, 14:30:00
Beef Tacos, 250, 9.99, 14:35:00
Chicken Burrito, 75, 11.99, 15:00:00</pre>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                            <div style="background: white; border-radius: 8px; padding: 15px;">
                                <strong style="color: #667eea;">üìã Column Details:</strong>
                                <ul style="margin: 10px 0 0 0; padding-left: 20px; line-height: 1.8;">
                                    <li><strong>Product:</strong> Product name (must match database)</li>
                                    <li><strong>Quantity:</strong> Number sold</li>
                                    <li><strong>Retail_Price:</strong> Actual sale price (optional, uses DB price if blank)</li>
                                    <li><strong>Time:</strong> Sale time HH:MM:SS (optional)</li>
                                </ul>
                            </div>

                            <div style="background: white; border-radius: 8px; padding: 15px;">
                                <strong style="color: #f5576c;">üí° Important Notes:</strong>
                                <ul style="margin: 10px 0 0 0; padding-left: 20px; line-height: 1.8;">
                                    <li>Headers are optional but recommended</li>
                                    <li>If Retail_Price is blank, uses database price</li>
                                    <li>Revenue = retail_price √ó quantity</li>
                                    <li>Product names must exactly match your products</li>
                                </ul>
                            </div>
                        </div>

                        <div style="background: #fff3cd; border-radius: 8px; padding: 15px; margin-top: 15px; border-left: 4px solid #ffc107;">
                            <strong style="color: #856404;">‚ö° Quick Example:</strong>
                            <pre style="background: white; padding: 10px; border-radius: 5px; margin: 10px 0; font-size: 0.85em;">Margherita Pizza, 50, 13.99, 16:00:00
Veggie Burrito, 30, , 16:15:00    ‚Üê Blank price uses database price
Hawaiian Pizza, 25, 15.99</pre>
                        </div>
                    </div>

                    <div class="sales-input-section">
                        <!-- CSV Input -->
                        <div id="csv-input" class="input-method-content">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <label for="salesCsvText" style="font-weight: 600; font-size: 1.05em;">Sales Data (CSV):</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <label for="csvFileUpload" class="btn-upload-csv">
                                        üìÅ Upload CSV File
                                        <input type="file" id="csvFileUpload" accept=".csv" style="display: none;" onchange="handleCsvFileUpload(event)">
                                    </label>
                                    <span id="uploadedFileName" style="font-size: 0.9em; color: #28a745; font-weight: 600;"></span>
                                    <button id="clearUploadBtn" class="btn-clear-upload" onclick="clearCsvUpload()" style="display: none; padding: 8px 14px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9em; font-weight: 600;">
                                        ‚úï Clear
                                    </button>
                                </div>
                            </div>
                            <textarea id="salesCsvText" rows="10" style="width: 100%; padding: 15px; border: 2px solid #e9ecef; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 0.95em;" placeholder="Paste or upload CSV data here...

Example:
Product, Quantity, Retail_Price, Time
Cheese Pizza, 100, 14.99, 14:30:00
Beef Tacos, 250, 9.99, 14:35:00"></textarea>
                            <div style="margin-top: 15px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                                <label style="font-weight: 600;">Sale Date:</label>
                                <input type="date" id="saleDate" value="" class="csv-date-input">
                                <label style="font-weight: 600;">Time (Optional):</label>
                                <input type="time" id="saleTime" value="" step="1" class="csv-date-input">
                                <button class="btn-parse-csv" onclick="parseSalesCSV()">
                                    üîç Parse & Preview
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Preview Section -->
                <div id="preview-section" style="display: none;">
                    <div class="card" style="margin-bottom: 20px;">
                        <h3>üëÅÔ∏è Preview Changes</h3>
                        <div id="preview-summary" class="sales-summary-cards"></div>
                        <div id="preview-details" class="sales-preview-details"></div>
                        <div id="preview-warnings" class="sales-warnings"></div>
                        <div style="margin-top: 20px; text-align: right;">
                            <button class="btn-secondary" onclick="cancelPreview()">Cancel</button>
                            <button class="btn-success" onclick="applySales()">‚úì Apply to Inventory</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Invoices Tab -->
        <div id="invoices-tab" class="tab-content">
            <div class="section-header">
                <h2>Invoice Management</h2>
                <div class="header-buttons">
                    <button class="btn btn-primary" onclick="openCreateInvoiceModal()">
                        ‚ûï Create New Invoice
                    </button>
                    <button class="btn btn-secondary" onclick="openImportInvoiceModal()">
                        üìÇ Import from File
                    </button>
                </div>
            </div>

            <div class="date-range-filter">
                <label class="date-label">Invoice Date:</label>
                <input type="date" id="invoiceDateFrom" class="date-input" placeholder="From">
                <span class="date-separator">to</span>
                <input type="date" id="invoiceDateTo" class="date-input" placeholder="To">
                <button class="btn-apply-filter" onclick="applyInvoiceDateFilter()">‚úì Apply</button>
                <button class="btn-clear-dates" onclick="clearInvoiceDateFilters()">Clear</button>
            </div>

            <div class="invoice-section">
                <h3>‚ö†Ô∏è Unreconciled Invoices</h3>
                <div class="table-container">
                    <table id="unreconciledTable">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortTable('unreconciled', 0, 'string')">Invoice # <span class="sort-arrow"></span></th>
                                <th class="sortable" onclick="sortTable('unreconciled', 1, 'string')">Supplier <span class="sort-arrow"></span></th>
                                <th class="sortable" onclick="sortTable('unreconciled', 2, 'date')">Invoice Date <span class="sort-arrow"></span></th>
                                <th class="sortable" onclick="sortTable('unreconciled', 3, 'date')">Received Date <span class="sort-arrow"></span></th>
                                <th class="sortable" onclick="sortTable('unreconciled', 4, 'number')">Amount <span class="sort-arrow"></span></th>
                                <th class="sortable" onclick="sortTable('unreconciled', 5, 'string')">Payment Status <span class="sort-arrow"></span></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="unreconciledTableBody">
                            <tr><td colspan="7" class="loading">Loading invoices...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination Controls -->
                <div class="pagination-container">
                    <div class="pagination-info">
                        <span id="unreconciledPaginationInfo">Showing 0-0 of 0 items</span>
                    </div>
                    <div class="pagination-controls">
                        <label>Show:
                            <select id="unreconciledPageSize" onchange="changeUnreconciledPageSize()">
                                <option value="10" selected>10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="all">All</option>
                            </select>
                        </label>
                        <div class="pagination-buttons">
                            <button onclick="changeUnreconciledPage('first')" id="unreconciledFirstPage">¬´</button>
                            <button onclick="changeUnreconciledPage('prev')" id="unreconciledPrevPage">‚Äπ</button>
                            <span id="unreconciledPageNumbers"></span>
                            <button onclick="changeUnreconciledPage('next')" id="unreconciledNextPage">‚Ä∫</button>
                            <button onclick="changeUnreconciledPage('last')" id="unreconciledLastPage">¬ª</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="invoice-section">
                <h3>üìã Recent Invoices</h3>
                <div class="table-container">
                    <table id="recentInvoicesTable">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortTable('recentInvoices', 0, 'string')">Invoice # <span class="sort-arrow"></span></th>
                                <th class="sortable" onclick="sortTable('recentInvoices', 1, 'string')">Supplier <span class="sort-arrow"></span></th>
                                <th class="sortable" onclick="sortTable('recentInvoices', 2, 'date')">Date <span class="sort-arrow"></span></th>
                                <th class="sortable" onclick="sortTable('recentInvoices', 3, 'number')">Amount <span class="sort-arrow"></span></th>
                                <th class="sortable" onclick="sortTable('recentInvoices', 4, 'string')">Payment <span class="sort-arrow"></span></th>
                                <th class="sortable" onclick="sortTable('recentInvoices', 5, 'string')">Reconciled <span class="sort-arrow"></span></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recentInvoicesTableBody">
                            <tr><td colspan="7" class="loading">Loading invoices...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination Controls -->
                <div class="pagination-container">
                    <div class="pagination-info">
                        <span id="invoicesPaginationInfo">Showing 0-0 of 0 items</span>
                    </div>
                    <div class="pagination-controls">
                        <label>Show:
                            <select id="invoicesPageSize" onchange="changeInvoicesPageSize()">
                                <option value="10">10</option>
                                <option value="25" selected>25</option>
                                <option value="50">50</option>
                                <option value="all">All</option>
                            </select>
                        </label>
                        <div class="pagination-buttons">
                            <button onclick="changeInvoicesPage('first')" id="invoicesFirstPage">¬´</button>
                            <button onclick="changeInvoicesPage('prev')" id="invoicesPrevPage">‚Äπ</button>
                            <span id="invoicesPageNumbers"></span>
                            <button onclick="changeInvoicesPage('next')" id="invoicesNextPage">‚Ä∫</button>
                            <button onclick="changeInvoicesPage('last')" id="invoicesLastPage">¬ª</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Counts Tab -->
        <div id="counts-tab" class="tab-content">
            <div class="section-header">
                <h2>Inventory Counts</h2>
                <button class="btn btn-primary" onclick="openCreateCountModal()">
                    ‚ûï Create New Count
                </button>
            </div>

            <div class="date-range-filter">
                <label class="date-label">Count Date:</label>
                <input type="date" id="countDateFrom" class="date-input" placeholder="From">
                <span class="date-separator">to</span>
                <input type="date" id="countDateTo" class="date-input" placeholder="To">
                <button class="btn-apply-filter" onclick="applyCountDateFilter()">‚úì Apply</button>
                <button class="btn-clear-dates" onclick="clearCountDateFilters()">Clear</button>
            </div>

            <div class="counts-section">
                <h3>üìä Recent Counts</h3>
                <div class="table-container">
                    <table id="countsTable">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortTable('counts', 0, 'string')">Count # <span class="sort-arrow"></span></th>
                                <th class="sortable" onclick="sortTable('counts', 1, 'date')">Count Date <span class="sort-arrow"></span></th>
                                <th class="sortable" onclick="sortTable('counts', 2, 'string')">Counted By <span class="sort-arrow"></span></th>
                                <th class="sortable" onclick="sortTable('counts', 3, 'number')">Items <span class="sort-arrow"></span></th>
                                <th class="sortable" onclick="sortTable('counts', 4, 'number')">Total Variance <span class="sort-arrow"></span></th>
                                <th class="sortable" onclick="sortTable('counts', 5, 'string')">Status <span class="sort-arrow"></span></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="countsTableBody">
                            <tr><td colspan="7" class="loading">Loading counts...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div id="history-tab" class="tab-content">
            <div class="section-header">
                <h2>System History</h2>
            </div>

            <div class="filters">
                <select id="historyActionFilter" onchange="loadHistory()">
                    <option value="all">All Actions</option>
                    <option value="SALE_RECORDED">Sales Recorded</option>
                    <option value="INVOICE_CREATED">Invoice Created</option>
                    <option value="INVOICE_IMPORTED">Invoice Imported</option>
                    <option value="INVOICE_DELETED">Invoice Deleted</option>
                    <option value="INVOICE_PAYMENT_PAID">Invoice Paid</option>
                    <option value="INVOICE_PAYMENT_UNPAID">Invoice Unpaid</option>
                    <option value="INVOICE_PAYMENT_PARTIAL">Invoice Partial Payment</option>
                    <option value="COUNT_CREATED">Count Created</option>
                    <option value="COUNT_DELETED">Count Deleted</option>
                    <option value="ITEM_CREATED">Item Created</option>
                    <option value="ITEM_DEACTIVATED">Item Deactivated</option>
                    <option value="ITEM_REACTIVATED">Item Reactivated</option>
                    <option value="BRAND_UPDATED">Brand Updated</option>
                    <option value="SUPPLIER_UPDATED">Supplier Updated</option>
                    <option value="SUPPLIER_CREATED">Supplier Created</option>
                </select>
                <select id="historyEntityFilter" onchange="loadHistory()">
                    <option value="all">All Types</option>
                    <option value="product">Products/Sales</option>
                    <option value="invoice">Invoices</option>
                    <option value="count">Counts</option>
                    <option value="item">Items</option>
                    <option value="brand">Brands</option>
                    <option value="supplier">Suppliers</option>
                </select>
            </div>

            <div class="date-range-filter">
                <label class="date-label">Event Date:</label>
                <input type="date" id="historyDateFrom" class="date-input" placeholder="From">
                <span class="date-separator">to</span>
                <input type="date" id="historyDateTo" class="date-input" placeholder="To">
                <button class="btn-apply-filter" onclick="applyHistoryDateFilter()">‚úì Apply</button>
                <button class="btn-clear-dates" onclick="clearHistoryDateFilters()">Clear</button>
            </div>

            <div class="stats-cards" id="historyStats">
                <div class="stat-card">
                    <div class="stat-label">Total Events</div>
                    <div class="stat-value" id="totalEvents">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Last 7 Days</div>
                    <div class="stat-value" id="recentEvents">-</div>
                </div>
            </div>

            <div class="history-section">
                <h3>üìú Activity Log</h3>
                <div class="table-container">
                    <table id="historyTable">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortHistoryTable(0)">Timestamp <span class="sort-arrow"></span></th>
                                <th class="sortable" onclick="sortHistoryTable(1)">Action <span class="sort-arrow"></span></th>
                                <th class="sortable" onclick="sortHistoryTable(2)">Type <span class="sort-arrow"></span></th>
                                <th class="sortable" onclick="sortHistoryTable(3)">Reference <span class="sort-arrow"></span></th>
                                <th>Details</th>
                                <th>User</th>
                                <th>IP Address</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <tr><td colspan="7" class="loading">Loading history...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination Controls -->
                <div class="pagination-container">
                    <div class="pagination-info">
                        <span id="historyPaginationInfo">Showing 0-0 of 0 items</span>
                    </div>
                    <div class="pagination-controls">
                        <label>Show:
                            <select id="historyPageSize" onchange="changeHistoryPageSize()">
                                <option value="10">10</option>
                                <option value="25" selected>25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                                <option value="all">All</option>
                            </select>
                        </label>
                        <div class="pagination-buttons">
                            <button onclick="changeHistoryPage('first')" id="historyFirstPage">¬´</button>
                            <button onclick="changeHistoryPage('prev')" id="historyPrevPage">‚Äπ</button>
                            <span id="historyPageNumbers"></span>
                            <button onclick="changeHistoryPage('next')" id="historyNextPage">‚Ä∫</button>
                            <button onclick="changeHistoryPage('last')" id="historyLastPage">¬ª</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics-tab" class="tab-content">
            <div class="section-header">
                <h2>üìà Analytics Dashboard</h2>
            </div>

            <!-- Time Period Selection (matching Sales layout) -->
            <div class="card" style="margin-bottom: 20px;">
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn-time-filter" data-period="today" onclick="changeAnalyticsPeriod('today')">Today</button>
                        <button class="btn-time-filter" data-period="7days" onclick="changeAnalyticsPeriod('7days')">Last 7 Days</button>
                        <button class="btn-time-filter" data-period="week" onclick="changeAnalyticsPeriod('week')">This Week</button>
                        <button class="btn-time-filter" data-period="month" onclick="changeAnalyticsPeriod('month')">This Month</button>
                        <button class="btn-time-filter active" data-period="30days" onclick="changeAnalyticsPeriod('30days')">Last 30 Days</button>
                        <button class="btn-time-filter" data-period="90days" onclick="changeAnalyticsPeriod('90days')">Last Quarter</button>
                        <button class="btn-time-filter" data-period="365days" onclick="changeAnalyticsPeriod('365days')">Last Year</button>
                        <button class="btn-time-filter" data-period="all" onclick="changeAnalyticsPeriod('all')">All Time</button>
                        <button class="btn-time-filter" data-period="custom" onclick="showAnalyticsCustomDateRange()">Custom Range</button>
                    </div>
                    <div id="analytics-custom-date-range" style="display: none; gap: 10px; align-items: center;">
                        <input type="date" id="analytics-start-date" class="csv-date-input">
                        <span>to</span>
                        <input type="date" id="analytics-end-date" class="csv-date-input">
                        <button class="btn-success" onclick="applyAnalyticsCustomDateRange()" style="padding: 10px 20px; font-weight: 600; box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);">
                            ‚úì Apply Range
                        </button>
                    </div>
                    <div style="display: flex; gap: 15px; align-items: center; justify-content: space-between;">
                        <div id="analytics-period-display" style="color: var(--theme-color-1); font-weight: 600;">
                            Last 30 Days
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary" onclick="refreshAnalytics()">üîÑ Refresh</button>
                            <button class="btn btn-primary" onclick="openCustomizeWidgets()">‚öôÔ∏è Customize</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- KPI Summary Cards -->
            <div class="analytics-kpi-grid" id="analyticsKPIs">
                <div class="kpi-card">
                    <div class="kpi-icon">üí∞</div>
                    <div class="kpi-value" id="kpiSpending">$0</div>
                    <div class="kpi-label">Total Spending</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">üè¢</div>
                    <div class="kpi-value" id="kpiSuppliers">0</div>
                    <div class="kpi-label">Active Suppliers</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">‚ö†Ô∏è</div>
                    <div class="kpi-value" id="kpiAlerts">0</div>
                    <div class="kpi-label">Price Alerts</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">üì¶</div>
                    <div class="kpi-value" id="kpiInventoryValue">$0</div>
                    <div class="kpi-label">Inventory Value</div>
                </div>
            </div>

            <!-- Analytics Sub-Tabs -->
            <div class="analytics-subtabs">
                <button class="analytics-subtab-btn active" onclick="showAnalyticsPage('spending')">üí∞ Spending</button>
                <button class="analytics-subtab-btn" onclick="showAnalyticsPage('pricing')">üíµ Pricing</button>
                <button class="analytics-subtab-btn" onclick="showAnalyticsPage('performance')">üìä Performance</button>
                <button class="analytics-subtab-btn" onclick="showAnalyticsPage('all')">üîç All Widgets</button>
            </div>

            <!-- Sales Analytics Page -->
            <!-- Sales Analytics removed - now in Sales tab -->

            <!-- Widgets Container (Dynamic) -->
            <div class="analytics-widgets-grid" id="analyticsWidgetsContainer">
                <div class="widget-placeholder">
                    <p>Loading analytics widgets...</p>
                </div>
            </div>
        </div>

        <!-- Customize Widgets Modal -->
        <div id="customizeWidgetsModal" class="modal">
            <div class="modal-content modal-large">
                <div class="modal-header">
                    <h2>‚öôÔ∏è Customize Analytics Dashboard</h2>
                    <button class="modal-close" onclick="closeCustomizeWidgets()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="customize-search">
                        <input type="text" id="widgetSearch" placeholder="üîç Search widgets..." onkeyup="filterWidgets()">
                        <select id="widgetCategoryFilter" onchange="filterWidgets()">
                            <option value="all">All Categories</option>
                            <option value="cost">Cost Analysis</option>
                            <option value="profitability">Profitability</option>
                            <option value="inventory">Inventory</option>
                            <option value="supplier">Supplier</option>
                            <option value="forecasting">Forecasting</option>
                        </select>
                    </div>

                    <div class="widget-lists">
                        <div class="widget-list-section">
                            <h3>‚úÖ Enabled Widgets</h3>
                            <p class="widget-list-help">Drag to reorder</p>
                            <div id="enabledWidgetsList" class="widget-list sortable">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>

                        <div class="widget-list-section">
                            <h3>‚òê Available Widgets</h3>
                            <p class="widget-list-help">Click to enable</p>
                            <div id="availableWidgetsList" class="widget-list">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeCustomizeWidgets()">Cancel</button>
                    <button class="btn btn-primary" onclick="saveWidgetPreferences()">Save Changes</button>
                </div>
            </div>
        </div>

        <!-- Employees Tab -->
        {% if g.user.role in ['organization_admin', 'super_admin'] %}
        <div id="employees-tab" class="tab-content">
            <div class="section-header">
                <h2>Employee Management</h2>
                <button class="btn btn-primary" onclick="openCreateEmployeeModal()">
                    ‚ûï Add Employee
                </button>
            </div>

            <div class="filters">
                <select id="employeeStatusFilter" onchange="filterAndDisplayEmployees()">
                    <option value="active">Active Employees</option>
                    <option value="inactive">Inactive Employees</option>
                    <option value="all">All Employees</option>
                </select>
                <input type="text" id="employeeSearch" placeholder="üîç Search employees..."
                       onkeyup="searchEmployees()" class="search-input" style="flex: 1; min-width: 250px;">
            </div>

            <div class="employees-section">
                <div class="table-container">
                    <table id="employeesTable">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortEmployeesTable(0, 'string')">Employee Code <span class="sort-arrow"></span></th>
                                <th class="sortable" onclick="sortEmployeesTable(1, 'string')">Name <span class="sort-arrow"></span></th>
                                <th class="sortable" onclick="sortEmployeesTable(2, 'string')">Position <span class="sort-arrow"></span></th>
                                <th class="sortable" onclick="sortEmployeesTable(3, 'string')">Email <span class="sort-arrow"></span></th>
                                <th class="sortable" onclick="sortEmployeesTable(4, 'string')">Phone <span class="sort-arrow"></span></th>
                                <th class="sortable" onclick="sortEmployeesTable(5, 'string')">Status <span class="sort-arrow"></span></th>
                                <th>Login</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="employeesTableBody">
                            <tr><td colspan="8" class="loading">Loading employees...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination Controls -->
                <div class="pagination-container">
                    <div class="pagination-info">
                        <span id="employeesPaginationInfo">Showing 0-0 of 0 items</span>
                    </div>
                    <div class="pagination-controls">
                        <label>Show:
                            <select id="employeesPageSize" onchange="changeEmployeesPageSize()">
                                <option value="10" selected>10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="all">All</option>
                            </select>
                        </label>
                        <div class="pagination-buttons">
                            <button onclick="changeEmployeesPage('first')" id="employeesFirstPage">¬´</button>
                            <button onclick="changeEmployeesPage('prev')" id="employeesPrevPage">‚Äπ</button>
                            <span id="employeesPageNumbers"></span>
                            <button onclick="changeEmployeesPage('next')" id="employeesNextPage">‚Ä∫</button>
                            <button onclick="changeEmployeesPage('last')" id="employeesLastPage">¬ª</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Attendance Tab -->
        <div id="attendance-tab" class="tab-content">
            <div class="section-header">
                <h2>Employee Attendance</h2>
                <p class="subtitle">View and track all employee clock in/out records</p>
            </div>

            <div class="filters">
                <select id="attendanceEmployeeFilter" onchange="filterAndDisplayAttendance()">
                    <option value="all">All Employees</option>
                </select>
                <select id="attendanceStatusFilter" onchange="filterAndDisplayAttendance()">
                    <option value="all">All Statuses</option>
                    <option value="clocked_in">Clocked In</option>
                    <option value="on_break">On Break</option>
                    <option value="clocked_out">Clocked Out</option>
                </select>
                <input type="date" id="attendanceDateFrom" onchange="loadAttendance()" class="search-input" style="max-width: 180px;">
                <input type="date" id="attendanceDateTo" onchange="loadAttendance()" class="search-input" style="max-width: 180px;">
            </div>

            <div class="attendance-section">
                <div class="table-container">
                    <table id="attendanceTable">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortAttendanceTable(0, 'string')">Employee <span class="sort-arrow"></span></th>
                                <th class="sortable" onclick="sortAttendanceTable(1, 'date')">Clock In <span class="sort-arrow"></span></th>
                                <th class="sortable" onclick="sortAttendanceTable(2, 'date')">Clock Out <span class="sort-arrow"></span></th>
                                <th class="sortable" onclick="sortAttendanceTable(3, 'number')">Total Hours <span class="sort-arrow"></span></th>
                                <th class="sortable" onclick="sortAttendanceTable(4, 'number')">Break Duration <span class="sort-arrow"></span></th>
                                <th class="sortable" onclick="sortAttendanceTable(5, 'string')">Status <span class="sort-arrow"></span></th>
                                <th>Notes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceTableBody">
                            <tr><td colspan="8" class="loading">Loading attendance records...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination Controls -->
                <div class="pagination-container">
                    <div class="pagination-info">
                        <span id="attendancePaginationInfo">Showing 0-0 of 0 records</span>
                    </div>
                    <div class="pagination-controls">
                        <label>Show:
                            <select id="attendancePageSize" onchange="changeAttendancePageSize()">
                                <option value="10" selected>10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="all">All</option>
                            </select>
                        </label>
                        <div class="pagination-buttons">
                            <button onclick="changeAttendancePage('first')" id="attendanceFirstPage">¬´</button>
                            <button onclick="changeAttendancePage('prev')" id="attendancePrevPage">‚Äπ</button>
                            <span id="attendancePageNumbers"></span>
                            <button onclick="changeAttendancePage('next')" id="attendanceNextPage">‚Ä∫</button>
                            <button onclick="changeAttendancePage('last')" id="attendanceLastPage">¬ª</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary Stats -->
            <div class="attendance-stats">
                <div class="stat-card">
                    <h4>Total Records</h4>
                    <p id="statTotalRecords">0</p>
                </div>
                <div class="stat-card">
                    <h4>Total Hours Worked</h4>
                    <p id="statTotalHours">0.0</p>
                </div>
                <div class="stat-card">
                    <h4>Currently Clocked In</h4>
                    <p id="statClockedIn">0</p>
                </div>
                <div class="stat-card">
                    <h4>On Break</h4>
                    <p id="statOnBreak">0</p>
                </div>
            </div>
        </div>

        <!-- Schedules Tab -->
        <div id="schedules-tab" class="tab-content {% if section == 'attendance' %}active{% endif %}">
            <div class="section-header">
                <h2>üìÖ Schedule Management</h2>
                <p class="subtitle">Create and manage employee work schedules</p>
                <button class="btn btn-primary" onclick="openCreateScheduleModal()">
                    ‚ûï Create Shift
                </button>
            </div>

            <!-- Schedule Controls -->
            <div class="schedule-controls-bar">
                <div class="schedule-view-controls">
                    <button class="schedule-view-btn active" data-view="week" onclick="switchAdminScheduleView('week')">
                        üìÖ Week
                    </button>
                    <button class="schedule-view-btn" data-view="month" onclick="switchAdminScheduleView('month')">
                        üìÜ Month
                    </button>
                </div>

                <div class="schedule-filters-admin">
                    <select id="scheduleEmployeeFilter" onchange="filterAdminSchedules()" autocomplete="off">
                        <option value="">All Employees</option>
                    </select>
                    <select id="schedulePositionFilter" onchange="filterAdminSchedules()" autocomplete="off">
                        <option value="">All Positions</option>
                    </select>
                    <select id="scheduleStatusFilter" onchange="filterAdminSchedules()" autocomplete="off">
                        <option value="">All Statuses</option>
                        <option value="scheduled">Scheduled</option>
                        <option value="confirmed">Confirmed</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>

                <div class="schedule-navigation-admin">
                    <button class="btn-icon" onclick="navigateAdminSchedule('prev')">‚Üê Previous</button>
                    <button class="btn-primary" onclick="navigateAdminSchedule('today')">Today</button>
                    <button class="btn-icon" onclick="navigateAdminSchedule('next')">Next ‚Üí</button>
                </div>
            </div>

            <!-- Week View -->
            <div id="adminWeekView" class="admin-schedule-view active">
                <div class="admin-week-calendar">
                    <div id="adminWeekGrid">
                        <!-- Week grid will be populated by JavaScript -->
                        <div class="schedule-loading">
                            <div class="loader"></div>
                            <p>Loading schedules...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Month View -->
            <div id="adminMonthView" class="admin-schedule-view" style="display: none;">
                <div class="admin-month-calendar">
                    <div id="adminMonthGrid">
                        <!-- Month grid will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Change Requests Section -->
            <div class="change-requests-section">
                <h3>Pending Change Requests</h3>
                <div class="table-container">
                    <table id="changeRequestsTable">
                        <thead>
                            <tr>
                                <th>Employee</th>
                                <th>Current Schedule</th>
                                <th>Requested By</th>
                                <th>Reason</th>
                                <th>Requested Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="changeRequestsTableBody">
                            <tr><td colspan="6" class="loading">No pending change requests</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Time Off Requests Tab -->
        <div id="time-off-requests-tab" class="tab-content">
            <div class="section-header">
                <h2>Time Off Requests</h2>
                <p class="subtitle">Review and manage employee time off requests</p>
            </div>

            <div class="filters">
                <select id="timeOffEmployeeFilter" onchange="filterTimeOffRequests()">
                    <option value="all">All Employees</option>
                </select>
                <select id="timeOffStatusFilter" onchange="filterTimeOffRequests()">
                    <option value="pending">Pending</option>
                    <option value="approved">Approved</option>
                    <option value="denied">Denied</option>
                    <option value="all">All Statuses</option>
                </select>
                <select id="timeOffTypeFilter" onchange="filterTimeOffRequests()">
                    <option value="all">All Types</option>
                    <option value="pto">PTO</option>
                    <option value="sick">Sick Leave</option>
                    <option value="unpaid">Unpaid Leave</option>
                    <option value="other">Other</option>
                </select>
            </div>

            <div class="time-off-section">
                <div class="table-container">
                    <table id="timeOffRequestsTable">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortTimeOffTable(0, 'string')">Employee <span class="sort-arrow"></span></th>
                                <th class="sortable" onclick="sortTimeOffTable(1, 'string')">Position <span class="sort-arrow"></span></th>
                                <th class="sortable" onclick="sortTimeOffTable(2, 'date')">Start Date <span class="sort-arrow"></span></th>
                                <th class="sortable" onclick="sortTimeOffTable(3, 'date')">End Date <span class="sort-arrow"></span></th>
                                <th class="sortable" onclick="sortTimeOffTable(4, 'string')">Type <span class="sort-arrow"></span></th>
                                <th class="sortable" onclick="sortTimeOffTable(5, 'number')">Hours <span class="sort-arrow"></span></th>
                                <th class="sortable" onclick="sortTimeOffTable(6, 'string')">Status <span class="sort-arrow"></span></th>
                                <th>Reason</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="timeOffRequestsTableBody">
                            <tr><td colspan="9" class="loading">Loading time off requests...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination Controls -->
                <div class="pagination-container">
                    <div class="pagination-info">
                        <span id="timeOffPaginationInfo">Showing 0-0 of 0 items</span>
                    </div>
                    <div class="pagination-controls">
                        <label>Show:
                            <select id="timeOffPageSize" onchange="changeTimeOffPageSize()">
                                <option value="10" selected>10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="all">All</option>
                            </select>
                        </label>
                        <div class="pagination-buttons">
                            <button onclick="changeTimeOffPage('first')" id="timeOffFirstPage">¬´</button>
                            <button onclick="changeTimeOffPage('prev')" id="timeOffPrevPage">‚Äπ</button>
                            <span id="timeOffPageNumbers"></span>
                            <button onclick="changeTimeOffPage('next')" id="timeOffNextPage">‚Ä∫</button>
                            <button onclick="changeTimeOffPage('last')" id="timeOffLastPage">¬ª</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payroll Tab -->
        <div id="payroll-tab" class="tab-content">
            <div class="section-header">
                <h2>üí∞ Payroll</h2>
                <p class="subtitle">Review and export weekly payroll data</p>
            </div>

            <div class="payroll-controls" style="display: flex; gap: 15px; align-items: center; margin-bottom: 20px; flex-wrap: wrap;">
                <div class="form-group" style="margin-bottom: 0;">
                    <label style="font-weight: 600; margin-right: 10px;">View:</label>
                    <select id="payrollViewType" onchange="togglePayrollView()" style="padding: 8px 12px; border-radius: 6px; border: 1px solid #d1d5db;">
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                    </select>
                </div>

                <!-- Weekly Selection -->
                <div id="weeklySelector" class="form-group" style="margin-bottom: 0;">
                    <label for="payrollWeekSelect" style="font-weight: 600; margin-right: 10px;">Week:</label>
                    <select id="payrollWeekSelect" onchange="loadPayrollData()" style="padding: 8px 12px; border-radius: 6px; border: 1px solid #d1d5db; min-width: 250px;">
                        <option value="">Loading weeks...</option>
                    </select>
                </div>

                <!-- Monthly Selection -->
                <div id="monthlySelector" style="display: none; gap: 10px; align-items: center;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="payrollMonthSelect" style="font-weight: 600; margin-right: 10px;">Month:</label>
                        <select id="payrollMonthSelect" onchange="loadMonthlyPayroll()" style="padding: 8px 12px; border-radius: 6px; border: 1px solid #d1d5db;">
                            <option value="1">January</option>
                            <option value="2">February</option>
                            <option value="3">March</option>
                            <option value="4">April</option>
                            <option value="5">May</option>
                            <option value="6">June</option>
                            <option value="7">July</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="payrollYearSelect" style="font-weight: 600; margin-right: 10px;">Year:</label>
                        <select id="payrollYearSelect" onchange="loadMonthlyPayroll()" style="padding: 8px 12px; border-radius: 6px; border: 1px solid #d1d5db;">
                            <option value="">Loading...</option>
                        </select>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="exportPayrollCSV()" style="display: flex; align-items: center; gap: 6px;">
                    üì• Export CSV
                </button>
                <button class="btn btn-secondary" onclick="printPayroll()" style="display: flex; align-items: center; gap: 6px;">
                    üñ®Ô∏è Print
                </button>
            </div>

            <div class="payroll-summary-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <div class="summary-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 0.85rem; opacity: 0.9;">Total Hours</div>
                    <div id="payrollTotalHours" style="font-size: 1.8rem; font-weight: 700;">0</div>
                </div>
                <div class="summary-card" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 0.85rem; opacity: 0.9;">Regular Wages</div>
                    <div id="payrollRegularWages" style="font-size: 1.8rem; font-weight: 700;">$0</div>
                </div>
                <div class="summary-card" style="background: linear-gradient(135deg, #F2994A 0%, #F2C94C 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 0.85rem; opacity: 0.9;">Overtime</div>
                    <div id="payrollOTWages" style="font-size: 1.8rem; font-weight: 700;">$0</div>
                </div>
                <div class="summary-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 0.85rem; opacity: 0.9;">Tips</div>
                    <div id="payrollTips" style="font-size: 1.8rem; font-weight: 700;">$0</div>
                </div>
                <div class="summary-card" style="background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 0.85rem; opacity: 0.9;">Salaries</div>
                    <div id="payrollSalaries" style="font-size: 1.8rem; font-weight: 700;">$0</div>
                </div>
                <div class="summary-card" style="background: linear-gradient(135deg, #232526 0%, #414345 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 0.85rem; opacity: 0.9;">Total Gross Pay</div>
                    <div id="payrollGrossPay" style="font-size: 1.8rem; font-weight: 700;">$0</div>
                </div>
            </div>

            <div class="payroll-section">
                <div class="table-container" id="payrollTableContainer">
                    <table id="payrollTable">
                        <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <tr>
                                <th style="color: white; background: transparent;">Employee</th>
                                <th style="color: white; background: transparent;">Hourly</th>
                                <th style="color: white; background: transparent;">Total Hrs</th>
                                <th style="color: white; background: transparent;">Reg Hrs</th>
                                <th style="color: white; background: transparent;">Reg Wage</th>
                                <th style="color: white; background: transparent;">OT Hrs</th>
                                <th style="color: white; background: transparent;">OT Wage</th>
                                <th style="color: white; background: transparent;">Tips</th>
                                <th style="color: white; background: transparent;">Salary</th>
                                <th style="color: white; background: transparent;">Classification</th>
                            </tr>
                        </thead>
                        <tbody id="payrollTableBody">
                            <tr><td colspan="10" class="loading">Select a pay period to view payroll data</td></tr>
                        </tbody>
                        <tfoot id="payrollTableFoot" style="display: none;">
                            <tr style="background: #f3f4f6; font-weight: 700;">
                                <td>TOTAL</td>
                                <td></td>
                                <td id="footTotalHours">0</td>
                                <td id="footRegHours">0</td>
                                <td id="footRegWages">$0</td>
                                <td id="footOTHours">0</td>
                                <td id="footOTWages">$0</td>
                                <td id="footTips">$0</td>
                                <td id="footSalary">$0</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Labor Analytics Tab -->
        <div id="labor-analytics-tab" class="tab-content">
            <div class="page-header">
                <h2 class="page-title">üìä Labor Analytics</h2>
                <button class="btn-export-primary" onclick="exportLaborAnalytics()">
                    üì• Export CSV
                </button>
            </div>

            <!-- Labor Analytics Dashboard -->
            <div id="labor-analytics-content" style="background: #f3f4f6; padding: 20px; border-radius: 12px; margin: -10px; margin-top: 0;">
                <!-- Time Period Selector -->
                <div class="card" style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn-time-filter labor-period-btn" data-period="4weeks" onclick="changeLaborPeriod('4weeks')">Last 4 Weeks</button>
                            <button class="btn-time-filter labor-period-btn active" data-period="8weeks" onclick="changeLaborPeriod('8weeks')">Last 8 Weeks</button>
                            <button class="btn-time-filter labor-period-btn" data-period="12weeks" onclick="changeLaborPeriod('12weeks')">Last 12 Weeks</button>
                            <button class="btn-time-filter labor-period-btn" data-period="6months" onclick="changeLaborPeriod('6months')">Last 6 Months</button>
                            <button class="btn-time-filter labor-period-btn" data-period="year" onclick="changeLaborPeriod('year')">Last Year</button>
                            <button class="btn-time-filter labor-period-btn" data-period="all" onclick="changeLaborPeriod('all')">All Time</button>
                            <button class="btn-time-filter labor-period-btn" data-period="custom" onclick="showLaborCustomDateRange()">Custom Range</button>
                        </div>
                        <div id="labor-custom-date-range" style="display: none; gap: 10px; align-items: center;">
                            <input type="date" id="labor-start-date" style="padding: 8px; border: 2px solid #667eea; border-radius: 5px;">
                            <span>to</span>
                            <input type="date" id="labor-end-date" style="padding: 8px; border: 2px solid #667eea; border-radius: 5px;">
                            <button class="btn-success" onclick="applyLaborCustomDateRange()" style="padding: 10px 20px; font-weight: 600; box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);">
                                Apply
                            </button>
                        </div>
                        <div id="labor-period-display" style="color: #667eea; font-weight: 600;">
                            Last 8 Weeks
                        </div>
                    </div>
                </div>

                <!-- Summary Stats Row -->
                <div class="card" style="margin-bottom: 20px;">
                    <h3 style="margin-bottom: 20px;">üìä Labor Summary</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div class="kpi-card">
                            <div class="kpi-icon">üíµ</div>
                            <div class="kpi-value" id="labor-total-cost">$0</div>
                            <div class="kpi-label">Total Labor Cost</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-icon">‚è±Ô∏è</div>
                            <div class="kpi-value" id="labor-total-hours">0</div>
                            <div class="kpi-label">Total Hours</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-icon">üìä</div>
                            <div class="kpi-value" id="labor-avg-weekly">$0</div>
                            <div class="kpi-label">Avg Weekly Cost</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-icon">üë•</div>
                            <div class="kpi-value" id="labor-active-employees">0</div>
                            <div class="kpi-label">Active Employees</div>
                        </div>
                    </div>
                </div>

                <!-- Main Chart Area -->
                <div class="card" style="margin-bottom: 20px;">
                    <h3>üìà Weekly Payroll Costs</h3>
                    <div id="labor-cost-chart" style="min-height: 350px; padding: 20px;">
                        <canvas id="laborCostCanvas"></canvas>
                    </div>
                </div>

                <!-- Additional Stats -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- Hours by Employee -->
                    <div class="card">
                        <h3>üë• Hours by Employee</h3>
                        <div id="labor-hours-by-employee" style="max-height: 400px; overflow-y: auto; padding: 10px;">
                            <div class="loading">Loading...</div>
                        </div>
                    </div>

                    <!-- Cost Breakdown -->
                    <div class="card">
                        <h3>üí∞ Cost Breakdown</h3>
                        <div id="labor-cost-breakdown" style="padding: 20px;">
                            <div style="display: flex; flex-direction: column; gap: 15px;">
                                <div style="display: flex; justify-content: space-between; padding: 12px; background: #f3f4f6; border-radius: 8px;">
                                    <span>Regular Wages</span>
                                    <span id="labor-breakdown-regular" style="font-weight: 700;">$0</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 12px; background: #fef3c7; border-radius: 8px;">
                                    <span>Overtime Wages</span>
                                    <span id="labor-breakdown-overtime" style="font-weight: 700;">$0</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 12px; background: #d1fae5; border-radius: 8px;">
                                    <span>Tips</span>
                                    <span id="labor-breakdown-tips" style="font-weight: 700;">$0</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 12px; background: #e0e7ff; border-radius: 8px;">
                                    <span>Salaries</span>
                                    <span id="labor-breakdown-salaries" style="font-weight: 700;">$0</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; color: white;">
                                    <span style="font-weight: 600;">Total</span>
                                    <span id="labor-breakdown-total" style="font-weight: 700;">$0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Schedule Modals -->
        <div id="createScheduleModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Create Shift</h2>
                    <button class="modal-close" onclick="closeScheduleModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="createScheduleForm">
                        <div class="form-group">
                            <label for="scheduleEmployee">Employee *</label>
                            <select id="scheduleEmployee" required>
                                <option value="">Select Employee</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="scheduleDate">Date *</label>
                            <input type="date" id="scheduleDate" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="scheduleStartTime">Start Time *</label>
                                <input type="time" id="scheduleStartTime" required>
                            </div>
                            <div class="form-group">
                                <label for="scheduleEndTime">End Time *</label>
                                <input type="time" id="scheduleEndTime" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="scheduleShiftType">Shift Type</label>
                            <select id="scheduleShiftType">
                                <option value="regular">Regular</option>
                                <option value="overtime">Overtime</option>
                                <option value="on-call">On-Call</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="schedulePosition">Position (Optional)</label>
                            <input type="text" id="schedulePosition" placeholder="Override default position">
                        </div>
                        <div class="form-group">
                            <label for="scheduleBreak">Break Duration (minutes)</label>
                            <input type="number" id="scheduleBreak" value="30" min="0">
                        </div>
                        <div class="form-group">
                            <label for="scheduleNotes">Notes</label>
                            <textarea id="scheduleNotes" rows="3" placeholder="Optional notes"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeScheduleModal()">Cancel</button>
                    <button class="btn-primary" onclick="saveSchedule()">Create Shift</button>
                </div>
            </div>
        </div>

        <div id="editScheduleModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Edit Shift</h2>
                    <button class="modal-close" onclick="closeScheduleModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editScheduleId">
                    <div class="schedule-detail-info">
                        <strong>Employee:</strong> <span id="editScheduleEmployeeName"></span>
                    </div>
                    <form id="editScheduleForm">
                        <div class="form-group">
                            <label for="editScheduleDate">Date *</label>
                            <input type="date" id="editScheduleDate" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editScheduleStartTime">Start Time *</label>
                                <input type="time" id="editScheduleStartTime" required>
                            </div>
                            <div class="form-group">
                                <label for="editScheduleEndTime">End Time *</label>
                                <input type="time" id="editScheduleEndTime" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="editScheduleShiftType">Shift Type</label>
                            <select id="editScheduleShiftType">
                                <option value="regular">Regular</option>
                                <option value="overtime">Overtime</option>
                                <option value="on-call">On-Call</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editSchedulePosition">Position</label>
                            <input type="text" id="editSchedulePosition">
                        </div>
                        <div class="form-group">
                            <label for="editScheduleBreak">Break Duration (minutes)</label>
                            <input type="number" id="editScheduleBreak" min="0">
                        </div>
                        <div class="form-group">
                            <label for="editScheduleNotes">Notes</label>
                            <textarea id="editScheduleNotes" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="editScheduleStatus">Status</label>
                            <select id="editScheduleStatus">
                                <option value="scheduled">Scheduled</option>
                                <option value="confirmed">Confirmed</option>
                                <option value="cancelled">Cancelled</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn-danger" onclick="deleteScheduleConfirm()">Delete</button>
                    <button class="btn-secondary" onclick="closeScheduleModal()">Cancel</button>
                    <button class="btn-primary" onclick="updateSchedule()">Save Changes</button>
                </div>
            </div>
        </div>

        <div id="approveChangeModal" class="modal" style="display: none;">
            <div class="modal-content modal-small">
                <div class="modal-header">
                    <h2>Approve Change Request</h2>
                    <button class="modal-close" onclick="closeScheduleModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="approveScheduleId">
                    <div id="approveChangeDetails"></div>
                    <p style="margin-top: 20px; font-weight: 600;">Are you sure you want to approve this change request?</p>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeScheduleModal()">Cancel</button>
                    <button class="btn-primary" onclick="confirmApproveChange()">Approve</button>
                </div>
            </div>
        </div>

        <div id="replaceShiftModal" class="modal" style="display: none;">
            <div class="modal-content modal-small">
                <div class="modal-header">
                    <h2>‚úì Shift Cancelled</h2>
                    <button class="modal-close" onclick="closeReplaceShiftModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="replacementDate">
                    <input type="hidden" id="replacementStartTime">
                    <input type="hidden" id="replacementEndTime">
                    <input type="hidden" id="replacementPosition">

                    <div class="success-message" style="background: #d1fae5; border: 1px solid #10b981; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <p style="margin: 0; color: #065f46; font-weight: 600;">The shift has been cancelled.</p>
                    </div>

                    <div id="replaceShiftDetails" style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <!-- Details will be populated by JS -->
                    </div>

                    <p style="font-weight: 600; margin-bottom: 10px;">Would you like to assign someone else to this time slot?</p>
                    <p style="color: #6b7280; font-size: 14px;">You can assign a replacement employee now, or discard and leave the slot empty.</p>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeReplaceShiftModal()">Discard</button>
                    <button class="btn-primary" onclick="openReplacementScheduleModal()">+ Assign Replacement</button>
                </div>
            </div>
        </div>

        <div id="denyChangeModal" class="modal" style="display: none;">
            <div class="modal-content modal-small">
                <div class="modal-header">
                    <h2>Deny Change Request</h2>
                    <button class="modal-close" onclick="closeScheduleModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="denyScheduleId">
                    <div id="denyChangeDetails"></div>
                    <div class="form-group" style="margin-top: 20px;">
                        <label for="denyReason">Reason for Denial *</label>
                        <textarea id="denyReason" rows="3" required placeholder="Explain why this request is being denied"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeScheduleModal()">Cancel</button>
                    <button class="btn-danger" onclick="confirmDenyChange()">Deny Request</button>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Settings Tab -->
        <div id="settings-tab" class="tab-content">
            <div class="section-header">
                <h2>Settings & Organization Info</h2>
                <p class="subtitle">View organization details and manage system settings</p>
            </div>

            <!-- Organization Information -->
            {% if g.organization %}
            <div class="settings-card org-info-card">
                <h3>üè¢ Organization Information</h3>
                <div class="org-info-grid">
                    <div class="org-info-item">
                        <span class="org-info-label">Organization Name</span>
                        <span class="org-info-value">{{ g.organization.organization_name }}</span>
                    </div>
                    <div class="org-info-item">
                        <span class="org-info-label">Organization ID</span>
                        <span class="org-info-value">{{ g.organization.slug }}</span>
                    </div>
                    <div class="org-info-item">
                        <span class="org-info-label">Plan Type</span>
                        <span class="org-info-value">{{ g.organization.plan_type|title }}</span>
                    </div>
                    <div class="org-info-item">
                        <span class="org-info-label">Subscription Status</span>
                        <span class="org-info-value status-badge status-{{ g.organization.subscription_status }}">
                            {{ g.organization.subscription_status|title }}
                        </span>
                    </div>
                    <div class="org-info-item">
                        <span class="org-info-label">Owner</span>
                        <span class="org-info-value">{{ g.organization.owner_name }}</span>
                    </div>
                    <div class="org-info-item">
                        <span class="org-info-label">Contact Email</span>
                        <span class="org-info-value">{{ g.organization.owner_email }}</span>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Password Change -->
            <div class="settings-card password-change-card">
                <h3>üîí Change Password</h3>
                <p class="settings-description">Update your account password securely</p>

                <div class="settings-form">
                    <form id="passwordChangeForm" onsubmit="changePassword(event)">
                        <div class="form-group">
                            <label>Current Password *</label>
                            <input type="password" id="currentPassword" name="current_password" required
                                   class="form-control" placeholder="Enter current password">
                        </div>

                        <div class="form-group">
                            <label>New Password *</label>
                            <input type="password" id="newPassword" name="new_password" required
                                   class="form-control" placeholder="Enter new password" minlength="8">
                            <small class="form-text">Must be at least 8 characters</small>
                        </div>

                        <div class="form-group">
                            <label>Confirm New Password *</label>
                            <input type="password" id="confirmPassword" name="confirm_password" required
                                   class="form-control" placeholder="Confirm new password" minlength="8">
                        </div>

                        <div id="passwordError" class="error-message" style="display: none;"></div>
                        <div id="passwordSuccess" class="success-message" style="display: none;"></div>

                        <button type="submit" class="btn btn-primary" id="changePasswordBtn">
                            üîí Change Password
                        </button>
                    </form>
                </div>
            </div>

            <div class="settings-grid">
                <!-- Brand Management -->
                <div class="settings-card">
                    <h3>üè∑Ô∏è Brand Management</h3>
                    <p class="settings-description">Rename a brand across all items that use it</p>

                    <div class="settings-form">
                        <div class="form-group">
                            <label>Select Brand to Update</label>
                            <select id="brandSelect" class="form-control" onchange="updateBrandPreview()">
                                <option value="">-- Select a brand --</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>New Brand Name</label>
                            <input type="text" id="newBrandName" class="form-control" placeholder="Enter new brand name">
                        </div>

                        <div id="brandPreview" class="update-preview"></div>

                        <button class="btn btn-primary" onclick="bulkUpdateBrand()">
                            Update Brand
                        </button>
                    </div>
                </div>

                <!-- Supplier Management -->
                <div class="settings-card">
                    <h3>üöö Supplier Name Management</h3>
                    <p class="settings-description">Rename a supplier across all items from that supplier</p>

                    <div class="settings-form">
                        <div class="form-group">
                            <label>Select Supplier to Update</label>
                            <select id="supplierSelect" class="form-control" onchange="updateSupplierPreview()">
                                <option value="">-- Select a supplier --</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>New Supplier Name</label>
                            <input type="text" id="newSupplierName" class="form-control" placeholder="Enter new supplier name">
                        </div>

                        <div id="supplierPreview" class="update-preview"></div>

                        <button class="btn btn-primary" onclick="bulkUpdateSupplier()">
                            Update Supplier
                        </button>
                    </div>
                </div>
            </div>

            <!-- Supplier Profiles Section -->
            <div class="section-header" style="margin-top: 40px;">
                <h2>Supplier Profiles</h2>
                <button class="btn btn-primary" onclick="openCreateSupplierModal()">
                    ‚ûï Create New Supplier
                </button>
            </div>

            <div class="table-container">
                <table id="suppliersTable">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortTable('suppliers', 0, 'string')">Supplier Name <span class="sort-arrow"></span></th>
                            <th class="sortable" onclick="sortTable('suppliers', 1, 'string')">Contact Person <span class="sort-arrow"></span></th>
                            <th class="sortable" onclick="sortTable('suppliers', 2, 'string')">Phone <span class="sort-arrow"></span></th>
                            <th class="sortable" onclick="sortTable('suppliers', 3, 'string')">Email <span class="sort-arrow"></span></th>
                            <th class="sortable" onclick="sortTable('suppliers', 4, 'string')">Address <span class="sort-arrow"></span></th>
                            <th class="sortable" onclick="sortTable('suppliers', 5, 'string')">Payment Terms <span class="sort-arrow"></span></th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="suppliersTableBody">
                        <tr><td colspan="7" class="loading">Loading suppliers...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Suppliers Pagination -->
            <div id="suppliersPagination" style="margin-top: 15px;"></div>

            <!-- Category Management Section -->
            <div class="section-header" style="margin-top: 40px;">
                <h2>Category Management</h2>
                <button class="btn btn-primary" onclick="openCreateCategoryModal()">
                    ‚ûï Create New Category
                </button>
            </div>

            <div class="table-container">
                <table id="categoriesTable">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortTable('categories', 0, 'string')">Category Name <span class="sort-arrow"></span></th>
                            <th class="sortable" onclick="sortTable('categories', 1, 'number')">Items Using <span class="sort-arrow"></span></th>
                            <th class="sortable" onclick="sortTable('categories', 2, 'date')">Created <span class="sort-arrow"></span></th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="categoriesTableBody">
                        <tr><td colspan="4" class="loading">Loading categories...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Categories Pagination -->
            <div id="categoriesPagination" style="margin-top: 15px;"></div>
        </div>
    </div>

    <!-- Tooltip Container -->
    <div id="tooltip" class="tooltip">
        <div class="tooltip-content" id="tooltipContent"></div>
    </div>

    <!-- Invoice Details Modal -->
    <div id="invoiceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalInvoiceTitle">Invoice Details</h2>
                <button class="modal-close" onclick="closeInvoiceModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="invoiceInfo" class="invoice-info"></div>
                <div class="invoice-items-section">
                    <h3>Line Items</h3>
                    <div class="table-container">
                        <table id="invoiceItemsTable">
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Ingredient</th>
                                    <th>Brand</th>
                                    <th>Size</th>
                                    <th>Qty Ordered</th>
                                    <th>Qty Received</th>
                                    <th>Unit Price</th>
                                    <th>Total Price</th>
                                    <th>Lot #</th>
                                </tr>
                            </thead>
                            <tbody id="invoiceItemsTableBody">
                                <tr><td colspan="9" class="loading">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Item Modal -->
    <div id="editItemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Inventory Item</h2>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editItemForm" onsubmit="saveItemChanges(event)">
                    <input type="hidden" id="editItemId">

                    <div class="form-row">
                        <div class="form-group">
                            <label>Ingredient Code *</label>
                            <input type="text" id="editCode" required class="form-control" placeholder="e.g., BEEF-001">
                        </div>
                        <div class="form-group">
                            <label>Ingredient Name *</label>
                            <input type="text" id="editName" required class="form-control">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Brand</label>
                            <input type="text" id="editBrand" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Supplier</label>
                            <select id="editSupplier" class="form-control">
                                <option value="">-- Select Supplier --</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Category *</label>
                            <select id="editCategory" required class="form-control">
                                <option value="Meat">Meat</option>
                                <option value="Produce">Produce</option>
                                <option value="Dairy">Dairy</option>
                                <option value="Dry Goods">Dry Goods</option>
                                <option value="Packaging">Packaging</option>
                                <option value="Beverages">Beverages</option>
                                <option value="Condiments">Condiments</option>
                                <option value="Bakery">Bakery</option>
                                <option value="Seafood">Seafood</option>
                                <option value="Frozen">Frozen</option>
                                <option value="Spices">Spices</option>
                                <option value="Uncategorized">Uncategorized</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Storage Location</label>
                            <input type="text" id="editLocation" class="form-control" placeholder="e.g., Freezer A, Shelf 3">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Quantity *</label>
                            <input type="number" step="0.01" id="editQuantity" required class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Unit of Measure *</label>
                            <select id="editUnit" required class="form-control">
                                <option value="lb">lb (pounds)</option>
                                <option value="oz">oz (ounces)</option>
                                <option value="kg">kg (kilograms)</option>
                                <option value="g">g (grams)</option>
                                <option value="ea">ea (each)</option>
                                <option value="gal">gal (gallons)</option>
                                <option value="qt">qt (quarts)</option>
                                <option value="pt">pt (pints)</option>
                                <option value="cup">cup</option>
                                <option value="L">L (liters)</option>
                                <option value="mL">mL (milliliters)</option>
                                <option value="case">case</option>
                                <option value="box">box</option>
                                <option value="bag">bag</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Last Price ($) *</label>
                            <input type="number" step="0.01" id="editCost" required class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Date Received</label>
                            <input type="date" id="editDateReceived" class="form-control">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Lot Number</label>
                            <input type="text" id="editLotNumber" class="form-control" placeholder="Vendor lot/batch number">
                        </div>
                        <div class="form-group">
                            <label>Expiration Date</label>
                            <input type="date" id="editExpirationDate" class="form-control">
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Create Invoice Modal -->
    <div id="createInvoiceModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>Create New Invoice</h2>
                <button class="modal-close" onclick="closeCreateInvoiceModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createInvoiceForm" onsubmit="saveNewInvoice(event)">
                    <!-- Invoice Header -->
                    <div class="invoice-header-section">
                        <h3>Invoice Information</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Invoice Number *</label>
                                <input type="text" id="newInvoiceNumber" required class="form-control" placeholder="INV-123456">
                            </div>
                            <div class="form-group">
                                <label>Supplier *</label>
                                <select id="newInvoiceSupplier" required class="form-control">
                                    <option value="">-- Select Supplier --</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Invoice Date *</label>
                                <input type="date" id="newInvoiceDate" required class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Received Date *</label>
                                <input type="date" id="newReceivedDate" required class="form-control">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Payment Status *</label>
                                <select id="newPaymentStatus" required class="form-control">
                                    <option value="UNPAID">Unpaid</option>
                                    <option value="PAID">Paid</option>
                                    <option value="PARTIAL">Partial</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Notes</label>
                                <input type="text" id="newInvoiceNotes" class="form-control" placeholder="Optional notes">
                            </div>
                        </div>
                    </div>

                    <!-- Line Items -->
                    <div class="invoice-items-section">
                        <h3>Line Items</h3>
                        <p class="subtitle" style="margin-top: 5px; font-size: 0.9em;">üí° Tip: You can select existing ingredients or type new ingredient codes</p>
                        <div class="table-container">
                            <table id="newInvoiceItemsTable" class="line-items-table">
                                <thead>
                                    <tr>
                                        <th style="width: 150px;">Ingredient Code *</th>
                                        <th style="width: 100px;">Brand</th>
                                        <th style="width: 80px;">Size</th>
                                        <th style="width: 70px;">Cases Ordered *</th>
                                        <th style="width: 70px;">Cases Received *</th>
                                        <th style="width: 70px;">Units/Case</th>
                                        <th style="width: 90px;">Unit Price *</th>
                                        <th style="width: 90px;">Total</th>
                                        <th style="width: 80px;">Lot #</th>
                                        <th style="width: 50px;"></th>
                                    </tr>
                                </thead>
                                <tbody id="newInvoiceItemsBody">
                                    <!-- Dynamic rows will be added here -->
                                </tbody>
                            </table>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <button type="button" class="btn btn-secondary" onclick="addInvoiceLineItem()">
                                ‚ûï Add Line Item
                            </button>
                            <button type="button" class="btn btn-primary" onclick="openBarcodeScannerForInvoice()">
                                üì± Scan Barcode
                            </button>
                        </div>
                    </div>

                    <!-- Invoice Total -->
                    <div class="invoice-total-section">
                        <div class="invoice-total">
                            <span>Invoice Total:</span>
                            <strong id="newInvoiceTotal">$0.00</strong>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeCreateInvoiceModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Invoice</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Import Invoice Modal -->
    <div id="importInvoiceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Import Invoice from File</h2>
                <button class="modal-close" onclick="closeImportInvoiceModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="importInvoiceForm" onsubmit="uploadInvoiceFile(event)" enctype="multipart/form-data">
                    <div class="import-info">
                        <h3>Supported File Formats</h3>
                        <ul>
                            <li>CSV files (.csv)</li>
                            <li>Excel files (.xlsx, .xls)</li>
                        </ul>
                        <p><strong>Required Columns:</strong> ingredient_code, quantity_received, unit_price</p>
                        <p><strong>Optional Columns:</strong> brand, size, quantity_ordered, lot_number</p>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Invoice Number *</label>
                            <input type="text" id="importInvoiceNumber" required class="form-control" placeholder="INV-123456">
                        </div>
                        <div class="form-group">
                            <label>Supplier *</label>
                            <select id="importSupplier" required class="form-control">
                                <option value="">-- Select Supplier --</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Invoice Date *</label>
                            <input type="date" id="importInvoiceDate" required class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Received Date *</label>
                            <input type="date" id="importReceivedDate" required class="form-control">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Payment Status *</label>
                            <select id="importPaymentStatus" required class="form-control">
                                <option value="UNPAID">Unpaid</option>
                                <option value="PAID">Paid</option>
                                <option value="PARTIAL">Partial</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Select File *</label>
                            <input type="file" id="invoiceFile" required class="form-control" accept=".csv,.xlsx,.xls">
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeImportInvoiceModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Import Invoice</button>
                    </div>
                </form>
                <div id="importProgress" class="import-progress" style="display: none;">
                    <p>Importing invoice...</p>
                    <div class="progress-bar">
                        <div class="progress-fill"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Invoice Confirmation Modal -->
    <div id="deleteInvoiceModal" class="modal">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2>Delete Invoice</h2>
                <button class="modal-close" onclick="closeDeleteInvoiceModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="warning-box">
                    <p><strong>‚ö†Ô∏è Warning: This action cannot be undone</strong></p>
                    <p>Deleting this invoice will:</p>
                    <ul>
                        <li>Remove the invoice and all its line items from the database</li>
                        <li>Reverse any inventory changes made by this invoice</li>
                    </ul>
                </div>
                <p id="deleteInvoiceInfo"></p>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeDeleteInvoiceModal()">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDeleteInvoice()">Delete Invoice</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Category Modal -->
    <div id="categoryModal" class="modal">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2 id="categoryModalTitle">Edit Category</h2>
                <button class="modal-close" onclick="closeCategoryModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="categoryForm" onsubmit="saveCategory(event)">
                    <input type="hidden" id="categoryEditId">
                    <input type="hidden" id="categoryOldName">

                    <div class="form-group">
                        <label>Category Name *</label>
                        <input type="text" id="categoryName" required class="form-control" placeholder="Enter category name">
                    </div>

                    <div class="form-group" id="categoryHelpText">
                        <p class="form-help">This will rename the category for all items that use it.</p>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-secondary" onclick="closeCategoryModal()">Cancel</button>
                        <button type="submit" class="btn-primary" id="categorySaveBtn">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Create Count Modal -->
    <div id="createCountModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>Create Inventory Count</h2>
                <button class="modal-close" onclick="closeCreateCountModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="countForm" onsubmit="submitCount(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Count Number *</label>
                            <input type="text" id="countNumber" required class="form-control" placeholder="e.g., COUNT-2026-001">
                        </div>
                        <div class="form-group">
                            <label>Count Date *</label>
                            <input type="date" id="countDate" required class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Counted By</label>
                            <input type="text" id="countedBy" class="form-control" placeholder="Person who did the count">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="countNotes" class="form-control" rows="2" placeholder="Optional notes about this count"></textarea>
                    </div>

                    <hr style="margin: 20px 0;">

                    <div class="section-header" style="margin-bottom: 15px;">
                        <h3>Count Items</h3>
                        <div>
                            <button type="button" class="btn btn-secondary" onclick="addCountRow()">+ Add Item</button>
                            <button type="button" class="btn btn-primary" onclick="openBarcodeScannerForCount()" style="margin-left: 10px;">üì± Scan Barcode</button>
                        </div>
                    </div>

                    <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                        <table id="countItemsTable" class="invoice-items-table">
                            <thead>
                                <tr>
                                    <th style="width: 150px;">Ingredient Code *</th>
                                    <th style="width: 200px;">Ingredient Name</th>
                                    <th style="width: 80px;">Expected</th>
                                    <th style="width: 100px;">Counted *</th>
                                    <th style="width: 80px;">Variance</th>
                                    <th style="width: 80px;">Unit</th>
                                    <th style="width: 150px;">Notes</th>
                                    <th style="width: 60px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="countItemsTableBody">
                                <!-- Rows will be added here dynamically -->
                            </tbody>
                        </table>
                    </div>

                    <div class="count-summary" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <strong>Total Items: <span id="countTotalItems">0</span></strong> |
                        <strong>Total Variance: <span id="countTotalVariance">0</span></strong>
                    </div>

                    <div class="form-actions" style="margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="closeCreateCountModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Count & Reconcile Inventory</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Count Details Modal -->
    <div id="countDetailsModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2 id="countDetailsTitle">Count Details</h2>
                <button class="modal-close" onclick="closeCountDetailsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="countDetailsContent">
                    <p class="loading">Loading count details...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Supplier Modal -->
    <div id="supplierModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="supplierModalTitle">Create New Supplier</h2>
                <button class="modal-close" onclick="closeSupplierModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="supplierForm" onsubmit="saveSupplier(event)">
                    <input type="hidden" id="supplierEditId">

                    <div class="form-row">
                        <div class="form-group">
                            <label>Supplier Name *</label>
                            <input type="text" id="supplierName" required class="form-control" placeholder="Enter supplier name">
                        </div>
                        <div class="form-group">
                            <label>Contact Person</label>
                            <input type="text" id="supplierContact" class="form-control" placeholder="Enter contact person">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="supplierPhone" class="form-control" placeholder="(555) 123-4567">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="supplierEmail" class="form-control" placeholder="contact@supplier.com">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Address</label>
                        <textarea id="supplierAddress" class="form-control" rows="3" placeholder="Enter complete address"></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Payment Terms</label>
                            <input type="text" id="supplierPaymentTerms" class="form-control" placeholder="e.g., Net 30, COD, etc.">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="supplierNotes" class="form-control" rows="2" placeholder="Additional notes about this supplier"></textarea>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeSupplierModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Supplier</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Datalist for ingredient code autocomplete in counts -->
    <datalist id="ingredientCodesList">
        <!-- Populated dynamically by JavaScript -->
    </datalist>

    <!-- ========== GENERIC MODAL (Layer 1.1) ========== -->
    <div id="genericModal" class="modal-backdrop" style="display: none;">
        <div class="modal-container">
            <div class="modal-header">
                <h2 id="modalTitle">Modal Title</h2>
                <button class="modal-close" onclick="closeModal()" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Dynamic content injected here by JavaScript -->
            </div>
            <div class="modal-footer" id="modalFooter">
                <!-- Dynamic buttons injected here by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Barcode Scanner Modal -->
    <div id="barcodeScannerModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>üì± Scan Barcode</h2>
                <button class="modal-close" onclick="closeBarcodeScanner()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="scanner-container">
                    <canvas class="drawing-buffer" style="position: absolute; top: 0; left: 0;"></canvas>

                    <!-- Targeting guide overlay -->
                    <div class="targeting-guide">
                        <div class="targeting-label">Position barcode here</div>
                    </div>

                    <div id="scanner-status">
                        <span id="scanner-message">Initializing camera...</span>
                    </div>
                </div>

                <!-- Scanning tips for better results -->
                <div style="margin-top: 15px; padding: 12px; background: #e3f2fd; border-radius: 8px; font-size: 0.9em;">
                    <strong>üì± iPhone Scanning Tips:</strong>
                    <ul style="margin: 8px 0 0 0; padding-left: 20px;">
                        <li><strong>Hold phone 6-10 inches away</strong> (further = less zoom)</li>
                        <li>Rotate to <strong>landscape mode</strong> for wider view</li>
                        <li>Entire barcode must fit in the green box</li>
                        <li>Use bright light or turn on flashlight</li>
                        <li>Hold very steady - let camera auto-focus</li>
                        <li>Try tilting phone slightly if glare present</li>
                    </ul>
                </div>

                <div id="barcode-results" style="margin-top: 20px; display: none;">
                    <h3>Scanned Barcode: <span id="scanned-barcode-value"></span></h3>

                    <!-- Loading indicator -->
                    <div id="barcode-loading" style="text-align: center; padding: 20px;">
                        <div class="spinner"></div>
                        <p>Looking up barcode in all databases...</p>
                    </div>

                    <!-- Results container -->
                    <div id="barcode-lookup-results" style="display: none;">
                        <!-- Inventory match -->
                        <div id="inventory-match-section" style="display: none;">
                            <div class="success-message">
                                <h4>‚úÖ Found in Inventory</h4>
                                <div id="inventory-match-details"></div>
                            </div>
                            <div id="add-to-count-section">
                                <label>Quantity Counted:</label>
                                <input type="number" id="barcode-quantity" step="0.01" min="0" value="1">
                                <button class="btn-success" onclick="addBarcodeItemToCount()">Add to Count</button>
                            </div>
                        </div>

                        <!-- External sources results -->
                        <div id="external-sources-section" style="display: none;">
                            <h4>üåê External Database Results</h4>
                            <div id="external-sources-list" style="display: grid; gap: 15px; margin-top: 15px;"></div>
                            <div id="external-sources-actions" style="margin-top: 15px;">
                                <!-- Action buttons will be added dynamically based on context -->
                            </div>
                        </div>

                        <!-- Not found -->
                        <div id="barcode-not-found" style="display: none;">
                            <div class="warning-message">
                                <h4>‚ö†Ô∏è Barcode Not Recognized</h4>
                                <p>This barcode was not found in our inventory or external databases.</p>
                                <button class="btn-primary" onclick="showCreateManualModal()">Create Item Manually</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn-secondary" onclick="restartScanner()">Scan Another</button>
                    <button class="btn-secondary" onclick="closeBarcodeScanner()">Close</button>
                </div>

                <!-- Manual Entry Option -->
                <div class="manual-entry-section">
                    <h4>Can't scan? Enter barcode manually:</h4>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="manual-barcode-input" placeholder="Enter barcode number" />
                        <button class="btn-primary" onclick="lookupManualBarcode()">Lookup</button>
                    </div>
                    <p>
                        <strong>Tip for dark/curved surfaces:</strong> Try better lighting, hold barcode flat, or use a white background behind it.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Ingredient from Barcode Modal -->
    <div id="createFromBarcodeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create Ingredient from Barcode</h2>
                <button class="modal-close" onclick="closeCreateFromBarcodeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="create-from-barcode-form">
                    <input type="hidden" id="new-item-barcode" />
                    <input type="hidden" id="new-item-external-data" />

                    <div class="form-group">
                        <label>Barcode:</label>
                        <input type="text" id="display-barcode" readonly style="background: #f5f5f5;" />
                    </div>

                    <div class="form-group">
                        <label>Ingredient Code: <span style="color: red;">*</span></label>
                        <input type="text" id="new-ingredient-code" required />
                    </div>

                    <div class="form-group">
                        <label>Ingredient Name: <span style="color: red;">*</span></label>
                        <input type="text" id="new-ingredient-name" required />
                    </div>

                    <div class="form-group">
                        <label>Brand:</label>
                        <input type="text" id="new-ingredient-brand" />
                    </div>

                    <div class="form-group">
                        <label>Category: <span style="color: red;">*</span></label>
                        <select id="new-ingredient-category" required>
                            <option value="">Select Category</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Unit of Measure: <span style="color: red;">*</span></label>
                        <select id="new-ingredient-uom" required>
                            <option value="">Select Unit</option>
                            <option value="lbs">lbs</option>
                            <option value="kg">kg</option>
                            <option value="oz">oz</option>
                            <option value="grams">grams</option>
                            <option value="each">each</option>
                            <option value="dozen">dozen</option>
                            <option value="case">case</option>
                            <option value="gallons">gallons</option>
                            <option value="liters">liters</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Unit Cost: <span style="color: red;">*</span></label>
                        <input type="number" id="new-ingredient-cost" step="0.01" min="0" required />
                    </div>

                    <div class="form-group">
                        <label>Supplier:</label>
                        <input type="text" id="new-ingredient-supplier" />
                    </div>

                    <div id="count-quantity-section" style="display: none; background: #e8f5e9; padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <h4 style="margin-top: 0; color: #2e7d32;">üìä Add to Count</h4>
                        <div class="form-group">
                            <label>Counted Quantity: <span style="color: red;">*</span></label>
                            <input type="number" id="new-ingredient-counted-qty" step="0.01" min="0" placeholder="How many did you count?" />
                            <small style="display: block; margin-top: 5px; color: #666;">This will be added to your inventory count</small>
                        </div>
                    </div>

                    <div class="form-group" style="background: #f8f9fa; padding: 10px; border-radius: 4px;">
                        <label>Starting Inventory Quantity:</label>
                        <input type="number" id="new-ingredient-quantity" step="0.01" min="0" value="0" />
                        <small style="display: block; margin-top: 5px; color: #666;">
                            Leave as 0 unless you want to set an initial quantity before the count
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-success" onclick="saveIngredientFromBarcode()">
                    <span id="create-button-text">Create Ingredient</span>
                </button>
                <button class="btn-secondary" onclick="closeCreateFromBarcodeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Password Change Script -->
    <script>
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = '/logout';
            }
        }

        function changePassword(event) {
            event.preventDefault();

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            const errorDiv = document.getElementById('passwordError');
            const successDiv = document.getElementById('passwordSuccess');
            const btn = document.getElementById('changePasswordBtn');

            // Hide previous messages
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';

            // Validate passwords match
            if (newPassword !== confirmPassword) {
                errorDiv.textContent = '‚ùå New passwords do not match';
                errorDiv.style.display = 'block';
                return;
            }

            // Validate password length
            if (newPassword.length < 8) {
                errorDiv.textContent = '‚ùå Password must be at least 8 characters';
                errorDiv.style.display = 'block';
                return;
            }

            // Disable button
            btn.disabled = true;
            btn.textContent = 'üîÑ Changing Password...';

            // Submit to API
            fetch('/api/user/change-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    current_password: currentPassword,
                    new_password: newPassword
                })
            })
            .then(res => res.json())
            .then(data => {
                btn.disabled = false;
                btn.textContent = 'üîí Change Password';

                if (data.success) {
                    successDiv.textContent = '‚úÖ ' + data.message;
                    successDiv.style.display = 'block';

                    // Reset form
                    document.getElementById('passwordChangeForm').reset();

                    // Hide success message after 5 seconds
                    setTimeout(() => {
                        successDiv.style.display = 'none';
                    }, 5000);
                } else {
                    errorDiv.textContent = '‚ùå ' + (data.error || 'Failed to change password');
                    errorDiv.style.display = 'block';
                }
            })
            .catch(err => {
                console.error('Error:', err);
                btn.disabled = false;
                btn.textContent = 'üîí Change Password';
                errorDiv.textContent = '‚ùå An error occurred. Please try again.';
                errorDiv.style.display = 'block';
            });
        }

        // Logo Upload Functions
        let selectedLogoFile = null;
        let dragDropInitialized = false;

        function openLogoUploadModal() {
            document.getElementById('logoUploadModal').style.display = 'flex';
            if (!dragDropInitialized) {
                setupDragAndDrop();
                dragDropInitialized = true;
            }
        }

        function closeLogoUploadModal() {
            document.getElementById('logoUploadModal').style.display = 'none';
            selectedLogoFile = null;
            document.getElementById('uploadArea').style.display = 'block';
            document.getElementById('logoPreview').style.display = 'none';
            document.getElementById('uploadProgress').style.display = 'none';
            document.getElementById('logoFileInput').value = '';
        }

        function setupDragAndDrop() {
            const uploadArea = document.getElementById('uploadArea');

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('drag-over');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleLogoFile(files[0]);
                }
            });

            uploadArea.addEventListener('click', () => {
                document.getElementById('logoFileInput').click();
            });
        }

        function handleLogoFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleLogoFile(file);
            }
        }

        function handleLogoFile(file) {
            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                return;
            }

            // Validate file size (5MB max)
            if (file.size > 5 * 1024 * 1024) {
                alert('File size must be less than 5MB');
                return;
            }

            selectedLogoFile = file;

            // Show preview
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('logoPreviewImage').src = e.target.result;
                document.getElementById('uploadArea').style.display = 'none';
                document.getElementById('logoPreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        function cancelLogoUpload() {
            selectedLogoFile = null;
            document.getElementById('uploadArea').style.display = 'block';
            document.getElementById('logoPreview').style.display = 'none';
            document.getElementById('logoFileInput').value = '';
        }

        function uploadLogo() {
            if (!selectedLogoFile) return;

            const formData = new FormData();
            formData.append('logo', selectedLogoFile);

            // Show progress
            document.getElementById('logoPreview').style.display = 'none';
            document.getElementById('uploadProgress').style.display = 'block';
            const progressFill = document.getElementById('progressFill');
            const uploadStatus = document.getElementById('uploadStatus');

            // Simulate progress
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 10;
                progressFill.style.width = progress + '%';
                if (progress >= 90) clearInterval(progressInterval);
            }, 100);

            fetch('/api/organization/upload-logo', {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                clearInterval(progressInterval);
                progressFill.style.width = '100%';

                if (data.success) {
                    uploadStatus.textContent = '‚úÖ Logo uploaded successfully!';
                    setTimeout(() => {
                        closeLogoUploadModal();
                        location.reload(); // Refresh to show new logo
                    }, 1000);
                } else {
                    uploadStatus.textContent = '‚ùå Upload failed: ' + (data.error || 'Unknown error');
                    setTimeout(() => {
                        document.getElementById('uploadProgress').style.display = 'none';
                        document.getElementById('uploadArea').style.display = 'block';
                    }, 2000);
                }
            })
            .catch(err => {
                clearInterval(progressInterval);
                console.error('Upload error:', err);
                uploadStatus.textContent = '‚ùå Upload failed. Please try again.';
                setTimeout(() => {
                    document.getElementById('uploadProgress').style.display = 'none';
                    document.getElementById('uploadArea').style.display = 'block';
                }, 2000);
            });
        }
    </script>

    <!-- Include QuaggaJS for barcode scanning -->
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.8.4/dist/quagga.min.js"></script>

    <script src="{{ url_for('static', filename='js/utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
    <script src="{{ url_for('static', filename='js/inventory.js') }}"></script>
    <script src="{{ url_for('static', filename='js/products.js') }}"></script>
    <script src="{{ url_for('static', filename='js/invoices.js') }}"></script>
    <script src="{{ url_for('static', filename='js/settings.js') }}"></script>
    <script src="{{ url_for('static', filename='js/counts.js') }}"></script>
    <script src="{{ url_for('static', filename='js/analytics.js') }}"></script>
    <script src="{{ url_for('static', filename='js/sales_tracking_ui.js') }}"></script>

    <!-- Employee Management Modal -->
    <div id="employeeModal" class="modal" style="display: none;">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2 id="employeeModalTitle">Add New Employee</h2>
                <button class="modal-close" onclick="closeEmployeeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="employeeForm" onsubmit="saveEmployee(event)">
                    <input type="hidden" id="employeeId" name="employee_id">

                    <!-- Personal Information -->
                    <div class="form-section">
                        <h3>üë§ Personal Information</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>First Name *</label>
                                <input type="text" id="employeeFirstName" name="first_name" required
                                       class="form-control" placeholder="John">
                            </div>

                            <div class="form-group">
                                <label>Last Name *</label>
                                <input type="text" id="employeeLastName" name="last_name" required
                                       class="form-control" placeholder="Doe">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="employeeEmail" name="email"
                                       class="form-control" placeholder="john.doe@example.com">
                            </div>

                            <div class="form-group">
                                <label>Phone</label>
                                <input type="tel" id="employeePhone" name="phone"
                                       class="form-control" placeholder="(555) 123-4567">
                            </div>
                        </div>
                    </div>

                    <!-- Employment Details -->
                    <div class="form-section">
                        <h3>üíº Employment Details</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Employee Code</label>
                                <input type="text" id="employeeCode" name="employee_code"
                                       class="form-control" placeholder="Auto-generated">
                                <small class="form-text">Leave empty to auto-generate</small>
                            </div>

                            <div class="form-group">
                                <label>Position</label>
                                <input type="text" id="employeePosition" name="position"
                                       class="form-control" placeholder="Line Cook">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Department</label>
                                <input type="text" id="employeeDepartment" name="department"
                                       class="form-control" placeholder="Kitchen">
                            </div>

                            <div class="form-group">
                                <label>Employment Type</label>
                                <select id="employeeType" name="employment_type" class="form-control">
                                    <option value="full-time">Full-time</option>
                                    <option value="part-time">Part-time</option>
                                    <option value="contractor">Contractor</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Hire Date</label>
                                <input type="date" id="employeeHireDate" name="hire_date"
                                       class="form-control">
                            </div>

                            <div class="form-group">
                                <label>Hourly Rate ($)</label>
                                <input type="number" id="employeeHourlyRate" name="hourly_rate"
                                       class="form-control" step="0.01" min="0" placeholder="15.00">
                            </div>
                        </div>
                    </div>

                    <!-- Address Information -->
                    <div class="form-section">
                        <h3>üìç Address</h3>

                        <div class="form-group">
                            <label>Street Address</label>
                            <input type="text" id="employeeAddress" name="address"
                                   class="form-control" placeholder="123 Main Street">
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>City</label>
                                <input type="text" id="employeeCity" name="city"
                                       class="form-control" placeholder="San Francisco">
                            </div>

                            <div class="form-group">
                                <label>State</label>
                                <input type="text" id="employeeState" name="state"
                                       class="form-control" placeholder="CA" maxlength="2">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>ZIP Code</label>
                            <input type="text" id="employeeZipCode" name="zip_code"
                                   class="form-control" placeholder="94102" maxlength="10">
                        </div>
                    </div>

                    <!-- Emergency Contact -->
                    <div class="form-section">
                        <h3>üö® Emergency Contact</h3>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Contact Name</label>
                                <input type="text" id="employeeEmergencyName" name="emergency_contact_name"
                                       class="form-control" placeholder="Jane Doe">
                            </div>

                            <div class="form-group">
                                <label>Contact Phone</label>
                                <input type="tel" id="employeeEmergencyPhone" name="emergency_contact_phone"
                                       class="form-control" placeholder="(555) 987-6543">
                            </div>
                        </div>
                    </div>

                    <!-- Profile Picture -->
                    <div class="form-section">
                        <h3>üì∏ Profile Picture</h3>
                        <div style="display: flex; align-items: center; gap: 20px;">
                            <div id="employeeProfilePicPreview" style="width: 80px; height: 80px; border-radius: 50%; background: #f3f4f6; display: flex; align-items: center; justify-content: center; font-size: 28px; font-weight: 600; color: #6b7280; border: 3px solid #e5e7eb;">
                                ?
                            </div>
                            <div style="flex: 1;">
                                <div id="employeeProfilePicUrl" style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">
                                    No profile picture uploaded
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="employeeFormError" class="error-message" style="display: none;"></div>

                    <div class="modal-actions">
                        <button type="submit" class="btn btn-primary" id="saveEmployeeBtn">
                            üíæ Save Employee
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeEmployeeModal()">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Attendance Modal -->
    <div id="editAttendanceModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è Edit Timesheet</h2>
                <button class="modal-close" onclick="closeEditAttendanceModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editAttendanceForm" onsubmit="saveAttendanceEdit(event)">
                    <input type="hidden" id="attendanceId" name="attendance_id">

                    <div class="form-group">
                        <label>Employee</label>
                        <input type="text" id="attendanceEmployeeName" name="employee_name" readonly class="form-control" style="background: #f3f4f6; cursor: not-allowed;">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Clock In *</label>
                            <input type="datetime-local" id="attendanceClockIn" name="clock_in" required class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Clock Out *</label>
                            <input type="datetime-local" id="attendanceClockOut" name="clock_out" required class="form-control">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Break Duration (minutes)</label>
                            <input type="number" id="attendanceBreakDuration" name="break_duration" min="0" class="form-control" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="attendanceStatus" name="status" class="form-control">
                                <option value="clocked_out">Clocked Out</option>
                                <option value="clocked_in">Clocked In</option>
                                <option value="on_break">On Break</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="attendanceNotes" name="notes" rows="3" class="form-control" placeholder="Any notes about this timesheet entry..."></textarea>
                    </div>

                    <div id="attendanceFormError" class="error-message" style="display: none;"></div>

                    <div class="modal-actions">
                        <button type="submit" class="btn btn-primary" id="saveAttendanceBtn">
                            üíæ Save Changes
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeEditAttendanceModal()">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Logo Upload Modal -->
    <div id="logoUploadModal" class="modal-overlay" style="display: none;">
        <div class="upload-modal">
            <div class="upload-modal-header">
                <h2>üé® Upload Company Logo</h2>
                <button class="modal-close-btn" onclick="closeLogoUploadModal()">&times;</button>
            </div>
            <div class="upload-modal-body">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon-large">üì∏</div>
                    <h3>Drag & Drop your logo here</h3>
                    <p>or click to browse</p>
                    <input type="file" id="logoFileInput" accept="image/*" style="display: none;" onchange="handleLogoFileSelect(event)">
                    <button class="browse-btn" onclick="document.getElementById('logoFileInput').click()">
                        <span>üìÅ</span> Browse Files
                    </button>
                    <small>Supported formats: JPG, PNG, SVG (Max 5MB)</small>
                </div>
                <div id="logoPreview" class="logo-preview" style="display: none;">
                    <img id="logoPreviewImage" src="" alt="Logo Preview">
                    <div class="preview-actions">
                        <button class="upload-btn" onclick="uploadLogo()">
                            <span>‚ú®</span> Upload Logo
                        </button>
                        <button class="cancel-btn" onclick="cancelLogoUpload()">
                            <span>‚úï</span> Cancel
                        </button>
                    </div>
                </div>
                <div id="uploadProgress" class="upload-progress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <p id="uploadStatus">Uploading...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/layer4_sales.js') }}"></script>
    <script src="{{ url_for('static', filename='js/sales_analytics.js') }}"></script>
    <script src="{{ url_for('static', filename='js/barcode_scanner.js') }}?v=2.0"></script>
    <script src="{{ url_for('static', filename='js/employees.js') }}"></script>
    <script src="{{ url_for('static', filename='js/attendance.js') }}"></script>
    <script src="{{ url_for('static', filename='js/schedule_admin.js') }}"></script>
    <script src="{{ url_for('static', filename='js/time_off_admin.js') }}"></script>
    <script src="{{ url_for('static', filename='js/payroll_admin.js') }}"></script>
    <script src="{{ url_for('static', filename='js/labor_analytics.js') }}"></script>
    <script src="{{ url_for('static', filename='js/datepicker.js') }}"></script>
    <script src="{{ url_for('static', filename='js/share.js') }}"></script>

    {% if g.is_super_admin or g.is_organization_admin %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/voice-ai.css') }}?v=16">
    <!-- Voice AI Assistant -->
    <button class="voice-ai-btn" id="voice-ai-btn" title="Voice Assistant">
        <svg class="icon-mic" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
        <svg class="icon-stop" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>
    </button>
    <div class="voice-ai-panel" id="voice-ai-panel">
        <div class="voice-ai-header">
            <div class="voice-ai-status-dot" id="voice-ai-status-dot"></div>
            <span class="voice-ai-status-label" id="voice-ai-status-text">Ready</span>
            <button class="voice-ai-pause" id="voice-ai-pause" title="Pause listening">
                <svg class="pause-icon" viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><rect x="6" y="4" width="4" height="16" rx="1"/><rect x="14" y="4" width="4" height="16" rx="1"/></svg>
                <svg class="play-icon" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="display:none"><path d="M8 5v14l11-7z"/></svg>
            </button>
            <button class="voice-ai-close" id="voice-ai-close" title="Close">&times;</button>
        </div>
        <div class="voice-ai-content">
            <div class="voice-ai-waveform" id="voice-ai-waveform">
                <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
                <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
                <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
                <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
            </div>
            <div class="voice-ai-body">
                <div class="voice-ai-ai"><div class="text" id="voice-ai-response"></div></div>
                <div class="voice-ai-data" id="voice-ai-data"></div>
                <div class="voice-ai-you"><div class="text" id="voice-ai-transcript"></div></div>
            </div>
            <div class="voice-ai-footer"><span>Powered by WONTECH</span></div>
        </div>
    </div>
    <script src="{{ url_for('static', filename='js/voice-ai.js') }}?v=16"></script>
    {% endif %}

    <script>
        // Initialize correct tab based on section
        document.addEventListener('DOMContentLoaded', function() {
            {% if section == 'attendance' %}
            // Show employees tab for attendance section
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            const employeesTab = document.getElementById('employees-tab');
            if (employeesTab) {
                employeesTab.classList.add('active');
            }

            // Find and activate employees button
            const employeesBtn = Array.from(document.querySelectorAll('.tab-btn')).find(btn =>
                btn.textContent.includes('Employees')
            );
            if (employeesBtn) {
                employeesBtn.classList.add('active');
            }

            // Load employees data
            if (typeof loadEmployees === 'function') {
                loadEmployees();
            }
            {% elif section == 'inventory' or not section %}
            // Show inventory tab for inventory section or no section
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            const inventoryTab = document.getElementById('inventory-tab');
            if (inventoryTab) {
                inventoryTab.classList.add('active');
            }

            // Find and activate inventory button
            const inventoryBtn = Array.from(document.querySelectorAll('.tab-btn')).find(btn =>
                btn.textContent.includes('Inventory')
            );
            if (inventoryBtn) {
                inventoryBtn.classList.add('active');
            }

            // Load inventory data
            if (typeof loadInventory === 'function') {
                loadInventory();
            }
            {% endif %}
        });
    </script>
</body>
</html>
